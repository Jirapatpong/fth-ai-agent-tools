<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI POS Sales Assistant</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 700px;
            height: 90vh;
            max-height: 800px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header {
            background-color: #007bff;
            color: white;
            padding: 16px 20px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
        }
        .upload-section {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
        }
        .upload-section label {
            font-weight: 500;
            margin-bottom: 10px;
            display: block;
        }
        .upload-section input[type="file"] {
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 6px;
            width: 80%;
        }
        #upload-status {
            margin-top: 10px;
            font-style: italic;
            color: #555;
            min-height: 20px;
        }
        .chat-window {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .ai-message {
            background-color: #e9e9eb;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .thinking {
            font-style: italic;
            color: #888;
        }
        .chat-input-form {
            display: flex;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
        }
        #chat-input {
            flex-grow: 1;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 1rem;
        }
        #send-button {
            border: none;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
        }
        #send-button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div class="container">
    <header>AI POS Sales Assistant</header>
    
    <div class="upload-section">
        <label for="file-upload">1. Upload your Product & Price Information File (.txt, .csv, .md)</label>
        <input type="file" id="file-upload" accept=".txt,.csv,.md,.json">
        <p id="upload-status">No file uploaded yet.</p>
    </div>

    <div class="chat-window" id="chat-window">
        <div class="message ai-message">
            Hello! Please upload a file above. Once it's loaded, you can ask me questions about it.
        </div>
    </div>

    <form class="chat-input-form" id="chat-form">
        <input type="text" id="chat-input" placeholder="Ask a question about the file..." disabled>
        <button type="submit" id="send-button" disabled>Send</button>
    </form>
</div>

<script>
    // --- DOM Element References ---
    const fileUpload = document.getElementById('file-upload');
    const uploadStatus = document.getElementById('upload-status');
    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');

    // --- State Variable ---
    let fileContent = null;

    // --- API Key Handling ---
    function getApiKey() {
        const base64Key = "c2stcHJvai1pUWtUQUxfMGh1MXFmU0k3N0gxRlF4STdCX2dUVnlMVERZREhRRllCTnlpdTl2em1ZOGc2YWhQc3JCVTcyYjl4NTBHOHNVOG14YlQzQmxia0ZKb25tM1RXaDlUVndjRHVoenpBclZsT1BMaUVGeDdBSXBjaUs2WmpqcDh4SUVDY2JZdmJObEY3b1BBbUF0YmktSkM3Q3hQd0NWd0E=";
        return atob(base64Key);
    }

    // --- File Upload Logic ---
    fileUpload.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) {
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            fileContent = e.target.result;
            uploadStatus.textContent = `✅ File loaded: ${file.name}`;
            uploadStatus.style.color = 'green';
            chatInput.disabled = false;
            sendButton.disabled = false;
            addMessageToChat('ai', `Great! I've analyzed the file "${file.name}". What would you like to know?`);
        };
        reader.onerror = () => {
            uploadStatus.textContent = '❌ Error reading file.';
            uploadStatus.style.color = 'red';
            fileContent = null;
        };
        reader.readAsText(file);
    });

    // --- Chat Logic ---
    chatForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const userQuestion = chatInput.value.trim();

        if (userQuestion && fileContent) {
            addMessageToChat('user', userQuestion);
            chatInput.value = '';
            getAIResponse(userQuestion);
        }
    });

    /**
     * Adds a message to the chat window UI.
     * @param {string} sender - Who sent the message ('user' or 'ai').
     * @param {string} text - The message content.
     */
    function addMessageToChat(sender, text) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', `${sender}-message`);
        messageElement.textContent = text;
        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    /**
     * Shows a "thinking..." indicator in the chat.
     * @returns {HTMLElement} The indicator element, so we can remove it later.
     */
    function showThinkingIndicator() {
        const thinkingElement = document.createElement('div');
        thinkingElement.classList.add('message', 'ai-message', 'thinking');
        thinkingElement.textContent = 'Thinking...';
        chatWindow.appendChild(thinkingElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return thinkingElement;
    }

    /**
     * Sends the data to the OpenAI API and gets a response.
     * @param {string} question - The user's question.
     */
    async function getAIResponse(question) {
        const thinkingIndicator = showThinkingIndicator();
        sendButton.disabled = true;

        const systemPrompt = `You are an expert sales assistant for a Point-of-Sale (POS) solutions provider. Your ONLY source of information is the document provided by the user. Do not use any external knowledge. If the answer is not in the document, say "I cannot find that information in the provided document." Answer questions concisely based on the following data:`;
        const apiUrl = 'https://api.openai.com/v1/chat/completions';

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getApiKey()}`
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        {
                            role: 'system',
                            content: systemPrompt
                        },
                        {
                            role: 'user',
                            content: `Here is the document:\n\n---\n${fileContent}\n---\n\nNow, please answer this question: ${question}`
                        }
                    ]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                const errorMessage = `API Error: ${errorData.error ? errorData.error.message : 'An unknown error occurred.'}`;
                throw new Error(errorMessage);
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;
            
            thinkingIndicator.remove();
            addMessageToChat('ai', aiResponse);

        } catch (error) {
            console.error('Error fetching AI response:', error);
            thinkingIndicator.remove();
            addMessageToChat('ai', error.message);
        } finally {
            sendButton.disabled = false;
        }
    }

</script>
</body>
</html>
