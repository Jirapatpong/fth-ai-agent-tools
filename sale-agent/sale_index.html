<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sales Estimator ‚Äî ChatGPT Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- PDF export helper -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIPb5VZ9x2hX3o8rW3h5S3iGf1yQbJQfT8CwQZqkzKf2Wc+oQmQeQdQkOY1ddo5rI4sQqg24dGQKSaX3k9xA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    body { font-family: Inter, system-ui, sans-serif; }
    .chat-bubble { max-width: 80%; padding: .75rem 1rem; border-radius: .75rem; margin-bottom: .5rem; white-space: pre-wrap; word-wrap: break-word; }
    .chat-bubble-user { background: #2563eb; color: #fff; align-self: flex-end; border-bottom-right-radius: .25rem; }
    .chat-bubble-assistant { background: #1f2937; color: #e5e7eb; align-self: flex-start; border-bottom-left-radius: .25rem; }
    .quote-table th, .quote-table td { border-bottom: 1px solid #334155; padding: .5rem .75rem; }
    .quote-table th { background: #0f172a; color: #cbd5e1; text-align: left; }
  </style>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen p-4 md:p-8">
  <div class="mx-auto max-w-6xl">
    <header class="mb-8">
      <h1 class="text-3xl font-bold text-white">Sales Estimator ‚Äî Competitive POS Pricing</h1>
      <p class="text-slate-400 mt-2">Powered by ChatGPT Agent with OpenAI API. Upload your price book and chat right away.</p>
    </header>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2 bg-slate-800 rounded-2xl p-6 shadow">
        <h2 class="text-xl font-semibold mb-4">1) Upload Price Book</h2>
        <div class="border-2 border-dashed border-slate-700 rounded-xl p-6 text-center">
          <label class="inline-flex items-center gap-2 px-5 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 font-semibold cursor-pointer">
            Browse (.xlsx/.csv)
            <input id="file-input" type="file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="hidden" />
          </label>
          <div id="file-info" class="mt-3 text-sm text-slate-400">No file selected.</div>
        </div>
        <div id="data-preview" class="mt-4 overflow-auto max-h-[400px] bg-slate-900 rounded-xl p-3 text-slate-400 text-sm">Preview will appear here‚Ä¶</div>
      </div>

      <div class="bg-slate-800 rounded-2xl p-6 shadow flex flex-col">
        <h2 class="text-xl font-semibold mb-4">2) Chat with ChatGPT Agent</h2>
        <div id="chat-history" class="flex-1 overflow-y-auto bg-slate-900 rounded-xl p-4 flex flex-col text-sm"></div>
        <div class="mt-3 flex gap-2">
          <input id="free-text" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-3 py-2" placeholder="Ask me about pricing, discounts, or quotes‚Ä¶"/>
          <button id="send-btn" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 font-semibold">Send</button>
        </div>
      </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
      <!-- Results / Assistant Narrative -->
      <div class="lg:col-span-2 bg-slate-800 rounded-2xl p-6 shadow">
        <h2 class="text-xl font-semibold mb-4">3) AI Answer</h2>
        <div id="results" class="text-slate-300">Results will appear here‚Ä¶</div>
      </div>

      <!-- Deal Narrative -->
      <div class="bg-slate-800 rounded-2xl p-6 shadow flex flex-col">
        <h2 class="text-xl font-semibold mb-4">4) Deal Narrative</h2>
        <div id="narrative" class="flex-1 overflow-y-auto bg-slate-900 rounded-xl p-4 text-sm text-slate-300">Narrative will appear here‚Ä¶</div>
      </div>
    </section>

    <!-- NEW: Customer Quote (table + exports) -->
    <section class="mt-6 bg-slate-800 rounded-2xl p-6 shadow">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold">5) Customer Quote (Auto-generated)</h2>
        <div class="flex gap-2">
          <button id="export-quote-csv" class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-semibold">Export CSV</button>
          <button id="export-quote-pdf" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 font-semibold">Export PDF</button>
        </div>
      </div>
      <div id="quote-meta" class="text-sm text-slate-400 mb-3">Quote will be generated after each AI answer.</div>
      <div id="quote-table-wrap" class="bg-slate-900 rounded-xl p-4 overflow-auto">
        <!-- Table goes here -->
        <div class="text-slate-500 text-sm">No quote yet.</div>
      </div>
    </section>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const UI = {
      file:$('#file-input'),
      fileInfo:$('#file-info'),
      preview:$('#data-preview'),
      chat:$('#chat-history'),
      freeText:$('#free-text'),
      send:$('#send-btn'),
      results:$('#results'),
      narrative:$('#narrative'),
      exportBtn:$('#export-btn'), // (legacy button in your layout)
      quoteMeta:$('#quote-meta'),
      quoteWrap:$('#quote-table-wrap'),
      exportQuoteCSV:$('#export-quote-csv'),
      exportQuotePDF:$('#export-quote-pdf'),
    };

    function addMsg(text,who='assistant'){
      const el=document.createElement('div');
      el.className=`chat-bubble ${who==='user'?'chat-bubble-user':'chat-bubble-assistant'}`;
      el.textContent=text;
      UI.chat.appendChild(el);
      UI.chat.scrollTop=UI.chat.scrollHeight;
    }

    // decode API key from base64 (‚ö†Ô∏è visible to anyone viewing source)
    function decodeKey(b64){ try{ return atob(b64); }catch(e){ return ''; } }
    const OPENAI_KEY = decodeKey("c2stcHJvai1pUWtUQUxfMGh1MXFmU0k3N0gxRlF4STdCX2dUVnlMVERZREhRRllCTnlpdTl2em1ZOGc2YWhQc3JCVTcyYjl4NTBHOHNVOG14YlQzQmxia0ZKb25tM1RXaDlUVndjRHVoenpBclZsT1BMaUVGeDdBSXBjaUs2WmpqcDh4SUVDY2JZdmJObEY3b1BBbUF0YmktSkM3Q3hQd0NWd0E=");

    async function chatWithGPT(message){
      const res = await fetch("https://api.openai.com/v1/chat/completions",{
        method:"POST",
        headers:{"Content-Type":"application/json","Authorization":`Bearer ${OPENAI_KEY}`},
        body:JSON.stringify({
          model:"gpt-4o-mini",
          messages:[
            {role:"system",content:"You are a helpful sales assistant for POS pricing. You can also help generate structured quotes."},
            {role:"user",content:message}
          ]
        })
      });
      const data = await res.json();
      return data.choices?.[0]?.message?.content || "(No response)";
    }

    // Strict JSON quote generator ‚Äî called after every AI answer
    async function generateQuoteJSON(contextText){
      const sys = `You are a quoting engine. Return ONLY strict JSON (no code fences) with this schema:
{
  "quoteId": string,
  "customer": { "name": string|null, "businessType": "F&B"|"Retail"|null, "branches": number|null },
  "currency": "THB"|"USD"|"EUR",
  "items": [
    { "name": string, "qty": number, "unit": number, "total": number, "category": "Mandatory"|"Optional" }
  ],
  "discounts": [
    { "label": string, "amount": number }
  ],
  "subtotal": number,
  "grandTotal": number,
  "notes": string
}
- Ensure totals are arithmetically correct: subtotal = sum(items.total), grandTotal = subtotal - sum(discounts.amount).
- If any field missing, infer from context (e.g., currency THB).
- Keep numbers as plain numbers (no commas).`;
      const user = `Context from assistant & user:
${contextText}

Produce the JSON quote now.`;
      const res = await fetch("https://api.openai.com/v1/chat/completions",{
        method:"POST",
        headers:{"Content-Type":"application/json","Authorization":`Bearer ${OPENAI_KEY}`},
        body:JSON.stringify({
          model:"gpt-4o-mini",
          temperature:0.2,
          messages:[{role:"system",content:sys},{role:"user",content:user}]
        })
      });
      const data = await res.json();
      let txt = data.choices?.[0]?.message?.content?.trim() || "{}";
      // Clean accidental code fences
      txt = txt.replace(/^```json/i,"").replace(/^```/,"").replace(/```$/,"").trim();
      try { return JSON.parse(txt); } catch(e){ console.warn("JSON parse failed", txt); return null; }
    }

    // Render the quote table
    function renderQuote(q){
      if (!q || !q.items || !Array.isArray(q.items) || !q.items.length){
        UI.quoteWrap.innerHTML = '<div class="text-slate-500 text-sm">No quote generated.</div>';
        return;
      }
      UI.quoteMeta.innerHTML = `
        <span class="text-slate-300">Quote ID:</span> ${q.quoteId || '-'}
        <span class="ml-4 text-slate-300">Customer:</span> ${q.customer?.name || '-'}
        <span class="ml-4 text-slate-300">Type:</span> ${q.customer?.businessType || '-'}
        <span class="ml-4 text-slate-300">Branches:</span> ${q.customer?.branches ?? '-'}
        <span class="ml-4 text-slate-300">Currency:</span> ${q.currency || 'THB'}
      `;
      const rows = q.items.map(it => `
        <tr>
          <td>${escapeHtml(it.name || '')}</td>
          <td>${it.category || ''}</td>
          <td class="text-right">${toInt(it.qty)}</td>
          <td class="text-right">${fmt(it.unit)}</td>
          <td class="text-right">${fmt(it.total)}</td>
        </tr>
      `).join("");

      const discRows = (q.discounts||[]).map(d => `
        <tr>
          <td colspan="4" class="text-right text-slate-300">${escapeHtml(d.label||'Discount')}</td>
          <td class="text-right text-rose-300">- ${fmt(d.amount||0)}</td>
        </tr>
      `).join("");

      UI.quoteWrap.innerHTML = `
        <div id="quote-print-area">
          <div class="mb-3">
            <div class="text-xl font-semibold text-white">Customer Quote</div>
            <div class="text-slate-400 text-sm">Auto-generated from the conversation.</div>
          </div>
          <table class="quote-table w-full text-sm">
            <thead>
              <tr>
                <th>Item</th><th>Category</th><th class="text-right">Qty</th><th class="text-right">Unit</th><th class="text-right">Total</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
            <tfoot>
              <tr>
                <td colspan="4" class="text-right text-slate-300">Subtotal</td>
                <td class="text-right">${fmt(q.subtotal||0)}</td>
              </tr>
              ${discRows}
              <tr>
                <td colspan="4" class="text-right text-slate-300 font-semibold">Grand Total</td>
                <td class="text-right font-semibold text-emerald-300">${fmt(q.grandTotal||0)}</td>
              </tr>
            </tfoot>
          </table>
          ${q.notes ? `<div class="mt-3 text-slate-300 text-sm">Notes: ${escapeHtml(q.notes)}</div>` : ''}
        </div>
      `;

      // stash for export
      window.__LAST_QUOTE__ = q;
    }

    // Export helpers
    UI.exportQuoteCSV.addEventListener('click', ()=>{
      const q = window.__LAST_QUOTE__; if(!q){ addMsg('No quote to export yet.'); return; }
      const rows = [
        ['Quote ID', q.quoteId || ''],
        ['Customer', q.customer?.name || ''],
        ['Business Type', q.customer?.businessType || ''],
        ['Branches', q.customer?.branches ?? ''],
        ['Currency', q.currency || 'THB'],
        [],
        ['Item','Category','Qty','Unit','Total']
      ];
      (q.items||[]).forEach(it=>{
        rows.push([it.name||'', it.category||'', toInt(it.qty), num(it.unit), num(it.total)]);
      });
      rows.push([]);
      rows.push(['Subtotal','', '', '', num(q.subtotal)]);
      (q.discounts||[]).forEach(d=>{
        rows.push([`Discount: ${d.label||''}`,'','','', -Math.abs(num(d.amount))]);
      });
      rows.push(['Grand Total','','','', num(q.grandTotal)]);
      const csv = rows.map(r=>r.map(v => (typeof v==='number' ? v : `"${String(v).replace(/"/g,'""')}"`)).join(',')).join('\n');
      downloadBlob(csv, 'text/csv;charset=utf-8;', 'customer-quote.csv');
    });

    UI.exportQuotePDF.addEventListener('click', ()=>{
      const area = document.getElementById('quote-print-area');
      if(!area){ addMsg('No quote to export yet.'); return; }
      const opt = {
        margin:       10,
        filename:     'customer-quote.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(area).save();
    });

    function downloadBlob(text, mime, filename){
      const blob=new Blob([text],{type:mime});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    }
    function fmt(n){ return Number(n||0).toLocaleString('en-TH'); }
    function num(v){ const n=Number(String(v).replace(/[^0-9.\-]/g,'')); return isFinite(n)?n:0; }
    function toInt(v){ const n=parseInt(v,10); return Number.isFinite(n)?n:0; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // File handling (preview only ‚Äî you can wire pricing to these rows later)
    UI.file.addEventListener('change',(e)=>{
      const file=e.target.files[0];
      if(!file) return;
      UI.fileInfo.textContent=`Loaded: ${file.name}`;
      addMsg('üìÇ Price Book uploaded. You can now chat with ChatGPT Agent about pricing.');

      const reader=new FileReader();
      reader.onload=(ev)=>{
        const data=new Uint8Array(ev.target.result);
        const wb=XLSX.read(data,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const matrix=XLSX.utils.sheet_to_json(ws,{header:1});
        if(!matrix.length) { UI.preview.textContent='(Empty file)'; return; }

        // render preview
        const table=document.createElement('table'); table.className='w-full text-sm';
        const thead=document.createElement('thead'); const trh=document.createElement('tr');
        for(const h of matrix[0]){ const th=document.createElement('th'); th.className='text-left bg-slate-900 px-2 py-2 border border-slate-700'; th.textContent=h; trh.appendChild(th); }
        thead.appendChild(trh); table.appendChild(thead);
        const tbody=document.createElement('tbody');
        for(let i=1;i<Math.min(matrix.length,60);i++){
          const tr=document.createElement('tr');
          for(const cell of matrix[i]){
            const td=document.createElement('td'); td.className='px-2 py-1 border border-slate-800'; td.textContent=(cell==null)?'':cell; tr.appendChild(td);
          }
          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        UI.preview.innerHTML=''; UI.preview.appendChild(table);
      };
      reader.readAsArrayBuffer(file);
    });

    // Chat cycle
    let lastAssistantText = '';
    UI.send.addEventListener('click', async ()=>{
      const text=UI.freeText.value.trim();
      if(!text) return;
      addMsg(text,'user');
      UI.freeText.value='';
      addMsg('ü§ñ Processing with ChatGPT‚Ä¶');

      try{
        // 1) Free-form assistant answer
        const reply = await chatWithGPT(text);
        lastAssistantText = reply;
        addMsg(reply,'assistant');
        UI.results.textContent = reply;

        // 2) Structured quote (JSON) based on the exchange
        const contextBlob = `User: ${text}\nAssistant: ${reply}`;
        const quote = await generateQuoteJSON(contextBlob);
        renderQuote(quote);

        // 3) Optional short sales narrative from the quote
        if (quote && typeof quote.grandTotal === 'number'){
          UI.narrative.textContent = `‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ${fmt(quote.subtotal)} ‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô ${fmt((quote.discounts||[]).reduce((s,d)=>s+Math.abs(d.amount||0),0))} ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ${fmt(quote.grandTotal)} ${quote.notes ? `\n‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${quote.notes}` : ''}`;
        }
      }catch(err){
        console.error(err);
        addMsg('‚ùó OpenAI call failed. Check network and API key.','assistant');
      }
    });

    // Initial hint
    addMsg('üëã Hello! Please upload a Price Book file to begin. After that, ask me anything about POS pricing and I‚Äôll generate answers and a customer-ready quote table you can export.');
  </script>
</body>
</html>
