<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOLmate - AI Sales Assistant & Dashboard</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            width: 24px;
            height: 24px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .generated-table table { width: 100%; border-collapse: collapse; }
        .generated-table th, .generated-table td { border: 1px solid #374151; padding: 8px 12px; text-align: left; font-size: 0.875rem; }
        .generated-table th { background-color: #1f2937; font-weight: 600; }
        .generated-table tr:nth-child(even) { background-color: #1f2937; }
        .chat-bubble { max-width: 90%; padding: 0.75rem 1rem; border-radius: 0.75rem; margin-bottom: 0.5rem; white-space: pre-wrap; word-wrap: break-word; }
        .chat-bubble-user { background-color: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 0.25rem; }
        .chat-bubble-assistant { background-color: #374151; color: #d1d5db; align-self: flex-start; border-bottom-left-radius: 0.25rem; }
        .chat-bubble-assistant ul { list-style-type: disc; padding-left: 20px; }
        .chat-bubble-assistant strong { color: #93c5fd; }
        #animation-container .robot-gear, #animation-container .robot-antenna-pulse { animation-play-state: paused; }
        #animation-container.is-thinking .robot-gear { animation: rotate 4s linear infinite; animation-play-state: running; }
        #animation-container.is-thinking .robot-antenna-pulse { animation: pulse 1.5s ease-in-out infinite; animation-play-state: running; }
        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 0.4; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } }
        /* Tab Styles */
        .tab { cursor: pointer; padding: 0.75rem 1.5rem; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab:hover { background-color: #374151; }
        .tab.active { color: #60a5fa; border-bottom-color: #60a5fa; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto max-w-7xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">SOLmate AI Sales Assistant</h1>
            <p class="mt-2 text-lg text-gray-400">Your intelligent partner for sales estimation and trend analysis.</p>
        </header>

        <!-- NEW: Tab Navigation -->
        <div class="border-b border-gray-700 mb-8">
            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                <div id="tab-assistant" class="tab active">AI Sales Assistant</div>
                <div id="tab-dashboard" class="tab">Inquiry Ranking Dashboard</div>
            </nav>
        </div>

        <!-- Page Content -->
        <div id="page-assistant">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Left Panel: Upload & Animation -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col gap-6">
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-4">1. Upload Price Book</h2>
                        <div class="flex justify-center items-center border-2 border-dashed border-gray-600 rounded-lg p-8">
                            <label class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center gap-2 cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                                Browse File (.csv, .xlsx)
                                <input type="file" id="file-input" class="hidden" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
                            </label>
                        </div>
                        <div id="file-info" class="text-center mt-4 text-gray-400">No file selected.</div>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold text-white mb-4">2. Assistant Status</h2>
                        <div id="animation-container" class="bg-gray-900 rounded-md p-4 flex flex-col justify-center items-center h-[400px]">
                            <svg width="200" height="200" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" class="transition-transform duration-500">
                                <path d="M 50 150 Q 50 70 100 70 Q 150 70 150 150 Z" fill="#374151" stroke="#6b7280" stroke-width="4"/>
                                <line x1="100" y1="70" x2="100" y2="40" stroke="#6b7280" stroke-width="4"/>
                                <circle class="robot-antenna-pulse" cx="100" cy="30" r="10" fill="#3b82f6"/>
                                <rect x="70" y="95" width="20" height="20" fill="#111827" rx="4"/><rect x="110" y="95" width="20" height="20" fill="#111827" rx="4"/>
                                <g class="robot-gear" style="transform-origin: 100px 125px;"><circle cx="100" cy="125" r="18" fill="none" stroke="#4b5563" stroke-width="4" stroke-dasharray="8 4"/></g>
                                <g class="robot-gear" style="transform-origin: 80px 135px; animation-direction: reverse; animation-duration: 3s;"><circle cx="80" cy="135" r="12" fill="none" stroke="#4b5563" stroke-width="3" stroke-dasharray="6 3"/></g>
                            </svg>
                            <p id="assistant-status-text" class="mt-4 text-lg text-gray-400">Waiting for data...</p>
                        </div>
                    </div>
                </div>

                <!-- Right Panel: AI Chat -->
                <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col h-[750px]">
                    <h2 class="text-xl font-semibold text-white mb-4">3. Ask SOLmate</h2>
                    <div id="chat-history" class="flex-grow overflow-y-auto mb-4 p-4 bg-gray-900 rounded-lg flex flex-col">
                        <div class="chat-bubble chat-bubble-assistant">Hello! I'm your sales assistant. Once the price book is loaded, ask me to estimate a budget. For example: "Estimate the cost for a new retail shop with 5 terminals."</div>
                    </div>
                    <div id="chat-input-area" class="flex gap-4">
                        <input type="text" id="ai-question" class="flex-grow bg-gray-700 border border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Type your question here..." disabled>
                        <button id="ask-ai-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>
                            <span id="btn-text">Ask</span>
                            <div id="btn-spinner" class="spinner hidden"></div>
                        </button>
                    </div>
                </div>
            </div>
            <div id="export-section" class="bg-gray-800 p-6 rounded-lg shadow-lg mt-8 hidden">
                 <h2 class="text-2xl font-semibold text-white mb-4">Generate Table & Export</h2>
                 <p class="text-gray-400 mb-4">Click the button below to generate a detailed table from the AI's last response. You can then export it to Excel.</p>
                 <div class="flex gap-4">
                     <button id="generate-table-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="3" y1="15" x2="21" y2="15"></line><line x1="9" y1="3" x2="9" y2="21"></line><line x1="15" y1="3" x2="15" y2="21"></line></svg>
                         Generate Table
                     </button>
                     <button id="export-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Export to Excel</button>
                 </div>
                 <div id="generated-table-container" class="overflow-auto max-h-[400px] bg-gray-900 rounded-md p-2 mt-4 generated-table"></div>
             </div>
        </div>

        <!-- NEW: Dashboard Page -->
        <div id="page-dashboard" class="hidden">
             <div id="dashboard-loader" class="text-center">
                <div class="flex justify-center items-center p-8"><div class="spinner"></div></div>
                <p>Analyzing inquiry history to build dashboard...</p>
             </div>
             <div id="dashboard-content" class="hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg"><canvas id="budget-chart"></canvas></div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg"><canvas id="solutions-chart"></canvas></div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg"><canvas id="top-products-chart"></canvas></div>
                    <div class="bg-gray-800 p-6 rounded-lg shadow-lg"><canvas id="bottom-products-chart"></canvas></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // DOM Element Refs
        const fileInput = document.getElementById('file-input'), fileInfo = document.getElementById('file-info');
        const chatHistory = document.getElementById('chat-history'), aiQuestion = document.getElementById('ai-question'), askAiBtn = document.getElementById('ask-ai-btn');
        const btnText = document.getElementById('btn-text'), btnSpinner = document.getElementById('btn-spinner');
        const exportSection = document.getElementById('export-section'), generateTableBtn = document.getElementById('generate-table-btn');
        const exportBtn = document.getElementById('export-btn'), generatedTableContainer = document.getElementById('generated-table-container');
        const animationContainer = document.getElementById('animation-container'), assistantStatusText = document.getElementById('assistant-status-text');
        const tabAssistant = document.getElementById('tab-assistant'), tabDashboard = document.getElementById('tab-dashboard');
        const pageAssistant = document.getElementById('page-assistant'), pageDashboard = document.getElementById('page-dashboard');
        const dashboardLoader = document.getElementById('dashboard-loader'), dashboardContent = document.getElementById('dashboard-content');
        
        // --- FIX: Corrected the corrupted Base64 key ---
        const CHATGPT_API_KEY_B64 = "c2stcHJvai1pUWtUQUxfMGh1MXFmU0k3N0gxRlF4STdCX2dUVnlMVERZREhRRllCTnlpdTl2em1ZOGc2YWhQc3JCVTcyYjl4NTBHOHNVOG14YlQzQmxia0ZKb25tM1RXaDlUVndjRHVoenpBclZsT1BMaUVGeDdBSXBjaUs2WmpqcDh4SUVDY2JZdmJObEY3b1BBbUF0YmktSkM3Q3hQd0NWd0E=";
        
        let parsedDataAsString = '', chatgptChatHistory = [], lastAiResponseText = '', generatedTableData = [];
        let charts = {}; // To hold chart instances

        // --- Event Listeners ---
        fileInput.addEventListener('change', handleFile);
        askAiBtn.addEventListener('click', handleAIChat);
        aiQuestion.addEventListener('keyup', (e) => { if (e.key === 'Enter') handleAIChat(); });
        generateTableBtn.addEventListener('click', generateTableFromAI);
        exportBtn.addEventListener('click', exportTable);
        tabAssistant.addEventListener('click', () => switchTab('assistant'));
        tabDashboard.addEventListener('click', () => switchTab('dashboard'));

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            fileInfo.textContent = `Processing file: ${file.name}...`;
            assistantStatusText.textContent = 'Analyzing data...';
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                if (jsonData.length === 0) { 
                    fileInfo.textContent = "Error: File is empty."; 
                    assistantStatusText.textContent = 'Upload failed.';
                    return;
                }
                parsedDataAsString = jsonData.map(row => row.join(', ')).join('\n');
                fileInfo.textContent = `Successfully loaded: ${file.name}`;
                assistantStatusText.textContent = 'Ready for questions.';
                aiQuestion.disabled = false;
                askAiBtn.disabled = false;
            };
            reader.readAsArrayBuffer(file);
        }
        
        async function handleAIChat() {
            const userQuery = aiQuestion.value.trim();
            if (!userQuery || !parsedDataAsString) return;
            
            addMessageToChat(userQuery, 'user');
            aiQuestion.value = '';
            toggleLoading(true);

            const systemPrompt = `You are SOLmate, an expert Sales and Budgeting AI assistant.
            **Your Task:** Help a salesperson estimate project costs using the provided price book data.
            **Pricing Logic (VERY IMPORTANT):**
            1.  **Standard Price First:** By default, you MUST calculate all costs using the standard 'Unit Price' or 'Total Price' column. Do NOT use any discount columns unless specifically asked.
            2.  **Strategic Discounting:** ONLY if the user's prompt includes keywords like "help me win", "competitive", "discount", or "winning price", you may then use the discount columns ('Minimum discount', 'Winning price suggestion', 'Maximum discount') to propose a more competitive offer. When doing so, you MUST state which discount level you are applying.
            **Response Format (VERY IMPORTANT):**
            1.  **Bulleted Summary ONLY:** Your response MUST be a concise summary in a bulleted list format.
            2.  **DO NOT generate a markdown table in your initial response.** Summarize the key findings, total costs, and mandatory components. The user has a separate button to generate a table later.
            **Calculation Steps:**
            1.  **Identify Business Type:** From the user's question (e.g., "cafe", "retail shop"), determine the correct business type table to use from the data below.
            2.  **Calculate Mandatory Costs:** Find all components where 'Mandatory' is 'Y' and include them.
            3.  **Incorporate Quantities:** Use quantities from the user's query (e.g., "5 terminals") to multiply costs.
            --- PRICE BOOK DATA START ---
            ${parsedDataAsString}
            --- PRICE BOOK DATA END ---`;
            
            chatgptChatHistory.push({ role: "user", content: userQuery });

            const messagesToSend = [
                { role: "system", content: systemPrompt },
                ...chatgptChatHistory
            ];
            
            try {
                const decodedApiKey = atob(CHATGPT_API_KEY_B64);
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + decodedApiKey },
                    body: JSON.stringify({ model: "gpt-4o-mini", messages: messagesToSend })
                });
                if (!response.ok) { const e = await response.json(); throw new Error(e.error.message); }
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                lastAiResponseText = aiResponse;
                addMessageToChat(aiResponse, 'assistant', true);
                chatgptChatHistory.push({ role: 'assistant', content: aiResponse });
                exportSection.classList.remove('hidden');
            } catch (error) {
                console.error("ChatGPT Error:", error);
                addMessageToChat(`Sorry, an error occurred: ${error.message}`, 'assistant');
                chatgptChatHistory.pop(); // remove user message if AI fails
            } finally {
                toggleLoading(false);
            }
        }
        
        async function generateTableFromAI() {
             if (chatgptChatHistory.length < 2) {
                generatedTableContainer.innerHTML = '<p class="text-yellow-400">Please ask a question first.</p>';
                return;
            }
            generateTableBtn.disabled = true;
            exportBtn.disabled = true;
            generatedTableContainer.innerHTML = '<div class="flex justify-center p-4"><div class="spinner"></div></div>';
            const tableRequestHistory = [...chatgptChatHistory, { role: "user", content: "Reformat your last response into a single markdown table. Output only the table." }];
            try {
                const decodedApiKey = atob(CHATGPT_API_KEY_B64);
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + decodedApiKey },
                    body: JSON.stringify({ model: "gpt-4o-mini", messages: tableRequestHistory })
                });
                if (!response.ok) { const e = await response.json(); throw new Error(e.error.message); }
                const data = await response.json();
                const tableText = data.choices[0].message.content;
                const tableData = parseMarkdownTable(tableText);
                if (tableData) {
                    generatedTableData = tableData;
                    displayTable(tableData, generatedTableContainer);
                    exportBtn.disabled = false;
                } else {
                    generatedTableContainer.innerHTML = '<p class="text-yellow-400">Could not generate a table.</p>';
                }
            } catch (error) {
                generatedTableContainer.innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            } finally {
                generateTableBtn.disabled = false;
            }
        }

        async function generateDashboard() {
            if (chatgptChatHistory.length < 2) {
                pageDashboard.innerHTML = '<p class="text-center text-yellow-400">No inquiry history yet. Please use the AI assistant to generate some estimates first.</p>';
                return;
            }
            dashboardLoader.style.display = 'block';
            dashboardContent.style.display = 'none';

            const analysisPrompt = `You are a data analysis bot. Analyze the following conversation and return ONLY a valid JSON object.
            Extract:
            1. "budgets": An array of all total cost estimations (as numbers).
            2. "products": An object with product names as keys and their mention frequency as values.
            3. "solutions": An object with solution types ('Retail', 'F&B') as keys and their mention frequency as values.

            Conversation:
            ${JSON.stringify(chatgptChatHistory)}

            JSON output only:`;

            try {
                const decodedApiKey = atob(CHATGPT_API_KEY_B64);
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + decodedApiKey },
                    body: JSON.stringify({ model: "gpt-4o-mini", messages: [{role: "user", content: analysisPrompt}], response_format: { type: "json_object" } })
                });
                if (!response.ok) { const e = await response.json(); throw new Error(e.error.message); }
                const data = await response.json();
                const analysisData = JSON.parse(data.choices[0].message.content);
                renderAllCharts(analysisData);
                dashboardLoader.style.display = 'none';
                dashboardContent.style.display = 'grid';

            } catch(error) {
                console.error("Dashboard Generation Error:", error);
                dashboardLoader.innerHTML = `<p class="text-red-400">Error generating dashboard: ${error.message}</p>`;
            }
        }
        
        function renderAllCharts(data) {
            Object.values(charts).forEach(chart => chart.destroy()); // Clear old charts
            const chartOptions = { plugins: { legend: { labels: { color: '#d1d5db' } } }, scales: { y: { ticks: { color: '#d1d5db' }, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { ticks: { color: '#d1d5db' }, grid: { color: 'rgba(255,255,255,0.1)' } } } };
            
            const budgetCanvas = document.getElementById('budget-chart');
            const solutionsCanvas = document.getElementById('solutions-chart');
            const topProductsCanvas = document.getElementById('top-products-chart');
            const bottomProductsCanvas = document.getElementById('bottom-products-chart');

            if (!budgetCanvas || !solutionsCanvas || !topProductsCanvas || !bottomProductsCanvas) {
                console.error("One or more chart canvas elements could not be found.");
                return;
            }
            
            // Budget Chart
            const budgetRanges = { "<10k": 0, "10k-50k": 0, "50k-100k": 0, ">100k": 0 };
            (data.budgets || []).forEach(b => {
                if(b < 10000) budgetRanges["<10k"]++;
                else if(b <= 50000) budgetRanges["10k-50k"]++;
                else if(b <= 100000) budgetRanges["50k-100k"]++;
                else budgetRanges[">100k"]++;
            });
            charts.budget = new Chart(budgetCanvas, { type: 'bar', data: { labels: Object.keys(budgetRanges), datasets: [{ label: 'Budget Inquiry Range', data: Object.values(budgetRanges), backgroundColor: '#3b82f6' }] }, options: {...chartOptions, indexAxis: 'y'} });

            // Solutions Chart
            charts.solutions = new Chart(solutionsCanvas, { type: 'doughnut', data: { labels: Object.keys(data.solutions || {}), datasets: [{ label: 'Top Solutions', data: Object.values(data.solutions || {}), backgroundColor: ['#10b981', '#f97316'] }] }, options: { plugins: { legend: { labels: { color: '#d1d5db' } } } } });
            
            const productEntries = Object.entries(data.products || {}).sort((a, b) => b[1] - a[1]);
            
            // Top Products
            const topProducts = productEntries.slice(0, 5);
            charts.topProducts = new Chart(topProductsCanvas, { type: 'bar', data: { labels: topProducts.map(p => p[0]), datasets: [{ label: 'Top 5 Requested Products', data: topProducts.map(p => p[1]), backgroundColor: '#8b5cf6' }] }, options: chartOptions });

            // Bottom Products
            const bottomProducts = productEntries.slice(-5);
            charts.bottomProducts = new Chart(bottomProductsCanvas, { type: 'bar', data: { labels: bottomProducts.map(p => p[0]), datasets: [{ label: 'Bottom 5 Requested Products', data: bottomProducts.map(p => p[1]), backgroundColor: '#ef4444' }] }, options: chartOptions });
        }

        // --- Helper Functions ---
        function switchTab(activeTab) {
            if (activeTab === 'assistant') {
                tabAssistant.classList.add('active');
                tabDashboard.classList.remove('active');
                pageAssistant.style.display = 'block';
                pageDashboard.style.display = 'none';
            } else {
                tabAssistant.classList.remove('active');
                tabDashboard.classList.add('active');
                pageAssistant.style.display = 'none';
                pageDashboard.style.display = 'block';
                generateDashboard();
            }
        }
        function addMessageToChat(message, sender, isHtml = false) {
             const messageDiv = document.createElement('div');
             messageDiv.className = `chat-bubble ${sender === 'user' ? 'chat-bubble-user' : 'chat-bubble-assistant'}`;
             if(isHtml) { messageDiv.innerHTML = message.replace(/\* (.*?)\n/g, '<li>$1</li>').replace(/\n/g, '<br>'); }
             else { messageDiv.textContent = message; }
             chatHistory.appendChild(messageDiv);
             chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        function displayTable(data, container) {
            const table = document.createElement('table');
            const headerRow = document.createElement('tr');
            data[0].forEach(headerText => { const th = document.createElement('th'); th.textContent = headerText; headerRow.appendChild(th); });
            table.appendChild(headerRow);
            data.slice(1).forEach(rowData => { const row = document.createElement('tr'); rowData.forEach(cellText => { const td = document.createElement('td'); td.textContent = cellText; row.appendChild(td); }); table.appendChild(row); });
            container.innerHTML = '';
            container.appendChild(table);
        }
        function toggleLoading(isLoading) {
            askAiBtn.disabled = isLoading;
            btnText.classList.toggle('hidden', isLoading);
            btnSpinner.classList.toggle('hidden', !isLoading);
            if (isLoading) { animationContainer.classList.add('is-thinking'); assistantStatusText.textContent = 'SOLmate is thinking...'; }
            else { animationContainer.classList.remove('is-thinking'); assistantStatusText.textContent = 'Ready for questions.'; }
        }
        function parseMarkdownTable(text) {
            const lines = text.split('\n').filter(line => line.trim().startsWith('|'));
            if (lines.length < 2) return null;
            const data = lines.filter(line => !line.match(/^\|-+\|/)).map(line => line.split('|').slice(1, -1).map(cell => cell.trim()));
            return data.filter(row => row.length > 0 && row.some(cell => cell));
        }
        function exportTable() {
            if (generatedTableData.length === 0) return;
            const worksheet = XLSX.utils.aoa_to_sheet(generatedTableData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "SOLmate Export");
            XLSX.writeFile(workbook, "SOLmate_Export.xlsx");
        }
    </script>
</body>
</html>

