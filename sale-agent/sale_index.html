<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart AI POS Sales Assistant (RAG)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 700px;
            height: 90vh;
            max-height: 800px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 16px 20px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
        }
        .upload-section {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
        }
        .upload-section label {
            font-weight: 500;
            margin-bottom: 10px;
            display: block;
        }
        .upload-section input[type="file"] {
            border: 1px solid #ccc;
            padding: 8px;
            border-radius: 6px;
            width: 80%;
        }
        #upload-status {
            margin-top: 10px;
            font-style: italic;
            color: #555;
            min-height: 20px;
        }
        .chat-window {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .message {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            margin-bottom: 10px;
            line-height: 1.4;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .ai-message {
            background-color: #e9e9eb;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .thinking {
            font-style: italic;
            color: #888;
        }
        .chat-input-form {
            display: flex;
            padding: 20px;
            border-top: 1px solid #e0e0e0;
        }
        #chat-input {
            flex-grow: 1;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 1rem;
        }
        #send-button {
            border: none;
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
        }
        #send-button:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div class="container">
    <header>Smart AI POS Sales Assistant</header>
    
    <div class="upload-section">
        <label for="file-upload">1. Upload a Large Product File (.txt, .csv, .md)</label>
        <input type="file" id="file-upload" accept=".txt,.csv,.md,.json">
        <p id="upload-status">No file uploaded yet.</p>
    </div>

    <div class="chat-window" id="chat-window">
        <div class="message ai-message">
            Hello! Please upload a large file. I will process it so you can ask questions.
        </div>
    </div>

    <form class="chat-input-form" id="chat-form">
        <input type="text" id="chat-input" placeholder="Ask a question about the file..." disabled>
        <button type="submit" id="send-button" disabled>Send</button>
    </form>
</div>

<script>
    // --- DOM Element References ---
    const fileUpload = document.getElementById('file-upload');
    const uploadStatus = document.getElementById('upload-status');
    const chatWindow = document.getElementById('chat-window');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');

    // --- State Variables for RAG ---
    let documentChunks = [];
    let chunkEmbeddings = [];

    // --- API Key Handling ---
    function getApiKey() {
        const base64Key = "c2stcHJvai1pUWtUQUxfMGh1MXFmU0k3N0gxRlF4STdCX2dUVnlMVERZREhRRllCTnlpdTl2em1ZOGc2YWhQc3JCVTcyYjl4NTBHOHNVOG14YlQzQmxia0ZKb25tM1RXaDlUVndjRHVoenpBclZsT1BMaUVGeDdBSXBjaUs2WmpqcDh4SUVDY2JZdmJObEY3b1BBbUF0YmktSkM3Q3hQd0NWd0E=";
        return atob(base64Key);
    }

    // --- File Processing and Embedding ---
    fileUpload.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        chatInput.disabled = true;
        sendButton.disabled = true;
        uploadStatus.textContent = 'Reading file...';
        uploadStatus.style.color = '#555';

        const reader = new FileReader();
        reader.onload = async (e) => {
            const content = e.target.result;
            
            // 1. Chunk the document
            uploadStatus.textContent = 'Splitting document into chunks...';
            documentChunks = chunkText(content, 500); // Chunk size in tokens (approx)

            // 2. Get embeddings for each chunk
            try {
                uploadStatus.textContent = `Creating embeddings for ${documentChunks.length} chunks... (This may take a moment)`;
                chunkEmbeddings = await getEmbeddings(documentChunks);
                
                uploadStatus.textContent = `✅ File processed: ${file.name}`;
                uploadStatus.style.color = 'green';
                chatInput.disabled = false;
                sendButton.disabled = false;
                addMessageToChat('ai', `Great! I've processed the file "${file.name}". What would you like to know?`);
            } catch (error) {
                uploadStatus.textContent = `❌ Error creating embeddings: ${error.message}`;
                uploadStatus.style.color = 'red';
                console.error(error);
            }
        };
        reader.readAsText(file);
    });

    /**
     * Splits a long text into smaller chunks based on paragraphs or sentence breaks.
     * @param {string} text - The full text content.
     * @param {number} chunkSize - The approximate size of each chunk in words.
     * @returns {string[]} An array of text chunks.
     */
    function chunkText(text, chunkSize = 200) {
        const paragraphs = text.split(/\n\s*\n/);
        const chunks = [];
        let currentChunk = "";
        for (const paragraph of paragraphs) {
            const words = paragraph.split(' ');
            if (currentChunk.split(' ').length + words.length > chunkSize) {
                if(currentChunk) chunks.push(currentChunk.trim());
                currentChunk = paragraph;
            } else {
                currentChunk += "\n\n" + paragraph;
            }
        }
        if (currentChunk) chunks.push(currentChunk.trim());
        return chunks;
    }

    /**
     * Calls the OpenAI API to get embeddings for an array of text chunks.
     * @param {string[]} texts - An array of strings to embed.
     * @returns {Promise<number[][]>} A promise that resolves to an array of embedding vectors.
     */
    async function getEmbeddings(texts) {
        const response = await fetch('https://api.openai.com/v1/embeddings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${getApiKey()}`
            },
            body: JSON.stringify({
                input: texts,
                model: 'text-embedding-3-small'
            })
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Embedding API Error: ${errorData.error.message}`);
        }
        const data = await response.json();
        return data.data.map(item => item.embedding);
    }
    
    /**
     * Calculates the cosine similarity between two vectors.
     * @param {number[]} vecA - The first vector.
     * @param {number[]} vecB - The second vector.
     * @returns {number} The cosine similarity score.
     */
    function cosineSimilarity(vecA, vecB) {
        let dotProduct = 0.0;
        let normA = 0.0;
        let normB = 0.0;
        for (let i = 0; i < vecA.length; i++) {
            dotProduct += vecA[i] * vecB[i];
            normA += vecA[i] * vecA[i];
            normB += vecB[i] * vecB[i];
        }
        return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
    }


    // --- Chat Logic ---
    chatForm.addEventListener('submit', (event) => {
        event.preventDefault();
        const userQuestion = chatInput.value.trim();
        if (userQuestion && documentChunks.length > 0) {
            addMessageToChat('user', userQuestion);
            chatInput.value = '';
            getAIResponse(userQuestion);
        }
    });

    /**
     * The main RAG function to get an answer from the AI.
     * @param {string} question - The user's question.
     */
    async function getAIResponse(question) {
        const thinkingIndicator = showThinkingIndicator();
        sendButton.disabled = true;

        try {
            // 1. Get embedding for the user's question
            const questionEmbedding = await getEmbeddings([question]);
            
            // 2. Find the most relevant chunks from the document
            const similarities = chunkEmbeddings.map((chunkVec, i) => ({
                index: i,
                score: cosineSimilarity(questionEmbedding[0], chunkVec)
            }));

            similarities.sort((a, b) => b.score - a.score);
            const topN = 3; // Get the top 3 most relevant chunks
            const relevantChunks = similarities.slice(0, topN).map(sim => documentChunks[sim.index]);
            const context = relevantChunks.join("\n\n---\n\n");

            // 3. Call the chat API with the relevant context
            const systemPrompt = `You are an expert sales assistant. Answer the user's question based ONLY on the following context. If the answer is not in the context, say you cannot find the information in the provided document.`;
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${getApiKey()}`
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: `Context:\n${context}\n\nQuestion: ${question}` }
                    ]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Chat API Error: ${errorData.error.message}`);
            }

            const data = await response.json();
            const aiResponse = data.choices[0].message.content;
            addMessageToChat('ai', aiResponse);

        } catch (error) {
            console.error('Error in getAIResponse:', error);
            addMessageToChat('ai', error.message);
        } finally {
            thinkingIndicator.remove();
            sendButton.disabled = false;
        }
    }
    
    // Helper functions to add messages to the chat UI
    function addMessageToChat(sender, text) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message', `${sender}-message`);
        messageElement.textContent = text;
        chatWindow.appendChild(messageElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }
    
    function showThinkingIndicator() {
        const thinkingElement = document.createElement('div');
        thinkingElement.classList.add('message', 'ai-message', 'thinking');
        thinkingElement.textContent = 'Searching document and thinking...';
        chatWindow.appendChild(thinkingElement);
        chatWindow.scrollTop = chatWindow.scrollHeight;
        return thinkingElement;
    }

</script>
</body>
</html>
