<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Admin Dashboard — Discrepancy Resolution</title>
<style>
  /* Base styles inherited from mobile app for consistency */
  :root{
    --bg:#f6f8fb; 
    --panel:#ffffff; 
    --muted:#637082; 
    --text:#0b1220;
    --brand:#3b82f6;
    --line:#d1d5db; 
    --shadow:0 4px 12px rgba(17,24,39,.12);
    --radius:12px; 
    --inset: env(safe-area-inset-bottom, 0);
    --fs-xs: clamp(11px, 1.4vw, 12px);
    --fs-sm: clamp(13px, 1.6vw, 14px);
    --fs-md: clamp(15px, 1.9vw, 16px);
    --fs-lg: clamp(18px, 2.3vw, 20px);
    --fs-xl: clamp(22px, 2.8vw, 24px);
    --icon: 18px;
    --icon-inline: 16px;
    --bad: #f87171; /* Red for discrepancy */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:var(--fs-md)/1.5 Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial; min-height: 100dvh;}
  header{padding:16px 20px;background:var(--brand);color:#fff;box-shadow:var(--shadow); display:flex; justify-content:space-between; align-items:center;}
  header h1{margin:0;font-size:var(--fs-xl); display:flex; align-items:center; gap: 10px;}
  .container{max-width:1400px;margin:0 auto;padding:20px 10px}
  .grid{display:grid;gap:15px}
  .row{display:flex;gap:15px;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);}
  .card h3{margin:0 0 10px 0;font-size:var(--fs-lg);display:flex;align-items:center;gap:8px; color: #1f2937;}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:var(--fs-sm); font-weight: 600;}
  .pill.open { background: #fee2e2; color: #b91c1c; border: 1px solid var(--bad); }
  .pill.closed { background: #d1fae5; color: #047857; border: 1px solid #10b981; }
  
  /* Buttons */
  button{font-size:var(--fs-md)}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:#fff;border:1px solid var(--line);color:#1f2937;padding:10px 16px; 
       border-radius:8px;cursor:pointer;min-height:40px; font-weight: 600; transition: all 0.2s ease;}
  .btn.primary{border-color:var(--brand);background:var(--brand);color:#fff;}
  .btn.primary:hover{background:#2563eb; border-color:#2563eb;}
  .btn.ok{border-color:#10b981;color:#047857;background:#d1fae5}
  .btn.bad{border-color:var(--bad);color:#b91c1c;background:#fee2e2}

  /* Discrepancy Table Styling */
  table{width:100%;border-collapse:collapse;margin-top:15px;}
  th,td{text-align:left;padding:12px 15px; border-bottom: 1px solid #e5e7eb;}
  thead th{font-size:var(--fs-sm);color:#475569; background: #f9fafb;}
  tbody tr:hover{background:#f0f4ff; cursor:pointer;}

  /* Modal Overrides */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .dialog{background:#fff;border-radius:var(--radius);width:90%;max-width:600px;box-shadow:0 10px 30px rgba(2,6,23,.25)}
  .sheet{padding:20px;}
  .close{position:absolute;right:15px;top:15px;background:#fff;border:1px solid var(--line);color:#334155;border-radius:50%;padding:4px 8px;cursor:pointer}

  /* KPI boxes */
  .kpis {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .kpi{flex:1; background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:15px; min-width: 150px;}
  .kpi .val{font-size:var(--fs-xl);font-weight:800; color: #1f2937; margin-bottom: 4px;}
  .kpi .lbl{font-size:var(--fs-sm);color:#4b5563;}

  /* Form elements within modal */
  label {display:block; margin-bottom: 5px; font-weight: 500;}
  textarea { min-height: 100px; padding: 10px; border: 1px solid var(--line); border-radius: 8px; width: 100%;}
  select { padding: 10px; min-height: 40px;}
</style>

</head>
<body>
<header>
    <h1><span class="ico-inline" data-ic="shield"></span> Admin Resolution Dashboard</h1>
    <span class="pill" style="background:#fff; color: var(--brand);">Supervisor Access</span>
</header>

<div class="container">
    <div class="grid">
        <!-- KPI Row -->
        <div class="kpis">
            <div class="kpi" id="kpiTotal"></div>
            <div class="kpi" id="kpiOpen"></div>
            <div class="kpi" id="kpiVariance"></div>
            <div class="kpi" id="kpiPosted"></div>
        </div>

        <!-- Main Discrepancy Queue -->
        <div class="card" id="discrepancyQueue">
            <h3><span class="ico-inline" data-ic="alert"></span> Discrepancy Queue: Pending Review</h3>
            <div id="discrepancyTable">
                <!-- Table will be rendered here -->
            </div>
        </div>

        <!-- System Actions Card -->
        <div class="card">
            <h3><span class="ico-inline" data-ic="report"></span> Post-Validation Actions</h3>
            <div class="row">
                <button class="btn primary" onclick="postToSAP()" style="flex:1;"><span class="ico-inline" data-ic="arrow"></span> Post Completed Plan to SAP</button>
                <button class="btn" onclick="showMessage('Download Audit', 'Generating comprehensive audit log for review.')" style="flex:1;"><span class="ico-inline" data-ic="report"></span> Download Audit Log</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Decision & Action (Approve/Recount/Review) -->
<div class="modal" id="modalDecision">
  <div class="dialog">
    <div class="sheet">
      <button class="close" onclick="closeModalDecision()">✕</button>
      <h3 style="margin-top:0;">Decision & Action: <span id="modalDiscId"></span></h3>
      
      <div id="decisionDetails" style="margin-bottom: 20px;">
        <!-- Details of the discrepancy -->
      </div>
      
      <div class="card" style="margin-bottom: 15px;">
        <label for="reviewReason">Review Reason / Justification</label>
        <textarea id="reviewReason" placeholder="Enter reason for variance approval or instruction for recount..."></textarea>
      </div>

      <div class="row" style="justify-content:space-between; margin-top: 15px;">
        <button class="btn bad" onclick="actionRecount()"><span class="ico-inline" data-ic="scan"></span> Recount / Re-enter</button>
        <button class="btn ok" onclick="actionApproveVariance()"><span class="ico-inline" data-ic="tick"></span> Approve Variance</button>
      </div>
    </div>
  </div>
</div>

<script>
// --- ICON DEFINITIONS (Copying from mobile app) ---
const ICONS = {
  plan:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 4v16M3 8h18"/></svg>`,
  users:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="8" cy="8" r="3"/><circle cx="16" cy="11" r="3"/><path d="M2 21a6 6 0 0 1 12 0"/><path d="M10 21a6 6 0 0 1 12 0"/></svg>`,
  scan:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M4 7V5a1 1 0 0 1 1-1h2M18 4h1a1 1 0 0 1 1 1v2M20 17v2a1 1 0 0 1-1 1h-2M6 20H5a1 1 0 0 1-1-1v-2"/>
    <rect x="8" y="8" width="8" height="8" rx="2"/></svg>`,
  shield:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M12 2l7 4v6c0 5-3.5 9-7 10-3.5-1-7-5-7-10V6l7-4z"/></svg>`,
  report:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M4 4h10l6 6v10a2 2 0 0 1-2 2H4z"/><path d="M14 4v6h6"/><path d="M8 16v4M12 14v6M16 12v8"/></svg>`,
  tick:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>`,
  alert:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M12 9v4"/><path d="M12 17h.01"/><path d="M10.3 3.2 1.7 18a2 2 0 0 0 1.7 3h17a2 2 0 0 0 1.7-3L13.7 3.2a2 2 0 0 0-3.4 0z"/></svg>`,
  arrow:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg>`
};
function paintIcons(scope=document){ scope.querySelectorAll('[data-ic]').forEach(el=>{ el.innerHTML = ICONS[el.getAttribute('data-ic')]||''; }); }
function esc(s){return (s??'').toString().replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
function fmtWhen(t){const d=new Date(t||Date.now()); return d.toLocaleString();}
let currentDiscrepancy = null;

// --- STATE MANAGEMENT (Mimics Mobile App's localStorage structure) ---
let state = {
  discrepancies: [],
  plans: []
};

function loadState() {
    try {
        state.discrepancies = JSON.parse(localStorage.getItem('pc_disc') || '[]') || [];
        state.plans = JSON.parse(localStorage.getItem('pc_plans') || '[]') || [];
    } catch (e) {
        console.error("Failed to load state from localStorage:", e);
    }
}

function persistState() {
    try {
        localStorage.setItem('pc_disc', JSON.stringify(state.discrepancies));
    } catch (e) {
        console.error("Failed to persist state to localStorage:", e);
    }
}

// --- MOCK DATA GENERATION ---
function seedDemoDiscrepancies() {
    loadState();
    // Only generate if the mobile app hasn't created any yet
    if (state.discrepancies.length > 0) return; 

    const now = Date.now();
    const pid = 'PLAN-Q3-2025';

    const mockDiscrepancies = [
        // 1. Critical Qty Mismatch (Needs Review)
        {
            planId: pid, id: 'D-1001', type: 'QtyMismatch - Review', binId: 'A01-03', sku: 'SKU-78321',
            expected: 50, counted: 42, status: 'Open', when: now - 3600000,
            note: 'Counter noted carton damage. Recount required.',
        },
        // 2. Large Variance (Needs Approval)
        {
            planId: pid, id: 'D-1002', type: 'QtyMismatch - Review', binId: 'B02-05', sku: 'SKU-11940',
            expected: 1, counted: 15, status: 'Open', when: now - 7200000,
            note: 'Seems like a forgotten pallet under the rack.',
        },
        // 3. Small Variance (Ready for Recount)
        {
            planId: pid, id: 'D-1003', type: 'QtyMismatch - Review', binId: 'A01-10', sku: 'SKU-00334',
            expected: 4, counted: 3, status: 'Open', when: now - 1800000,
        },
        // 4. Zero Variance (Requires Documentation)
        {
            planId: pid, id: 'D-1004', type: 'Zero Variance - Review', binId: 'C03-01', sku: 'SKU-99011',
            expected: 20, counted: 20, status: 'Open', when: now - 5400000,
            note: 'Triggered by blind count system setting. Actual count matches expected.',
        },
        // 5. Closed/Resolved (Ready for Posting)
        {
            planId: pid, id: 'D-1005', type: 'QtyMismatch - Review', binId: 'B02-01', sku: 'SKU-55667',
            expected: 10, counted: 12, status: 'Closed - Approved Variance', when: now - 9000000,
            reason: 'Confirmed system error in batch booking.',
            resolvedBy: 'AdminUser', resolvedTime: now - 1800000,
        }
    ];

    state.discrepancies.push(...mockDiscrepancies);
    persistState();
}

// --- RENDERING FUNCTIONS ---

function getKPIs() {
    const total = state.discrepancies.length;
    const open = state.discrepancies.filter(d => d.status.includes('Open') || d.status.includes('Pending')).length;
    const closed = state.discrepancies.filter(d => d.status.includes('Closed')).length;
    
    // Total value of variance (mock calculation for open items)
    const variance = state.discrepancies
        .filter(d => d.status.includes('Open') || d.status.includes('Pending'))
        .reduce((sum, d) => sum + Math.abs(d.expected - d.counted), 0);

    return { total, open, closed, variance };
}

function renderKPIs() {
    const kpis = getKPIs();
    document.getElementById('kpiTotal').innerHTML = `<div class="val">${kpis.total}</div><div class="lbl">Total Discrepancies</div>`;
    document.getElementById('kpiOpen').innerHTML = `<div class="val" style="color:var(--bad);">${kpis.open}</div><div class="lbl">Open for Review</div>`;
    document.getElementById('kpiVariance').innerHTML = `<div class="val">${kpis.variance}</div><div class="lbl">Total Open Variance (Units)</div>`;
    document.getElementById('kpiPosted').innerHTML = `<div class="val" style="color:#10b981;">${kpis.closed}</div><div class="lbl">Resolved/Posted (Closed)</div>`;
}

function renderDiscrepancyQueue() {
    const activeDiscrepancies = state.discrepancies.filter(d => d.status.includes('Open') || d.status.includes('Pending'));
    const container = document.getElementById('discrepancyTable');
    
    if (activeDiscrepancies.length === 0) {
        container.innerHTML = `<div class="card" style="text-align:center; padding: 30px; background: #e0f2fe; border: 1px solid #bae6fd;">
                                <h3 style="color:#3b82f6; margin-bottom: 0;">Queue Clear!</h3>
                                <div class="muted" style="color:#3b82f6;">No open discrepancies require review.</div>
                              </div>`;
        return;
    }

    const tableRows = activeDiscrepancies.map(d => {
        const diff = d.counted - d.expected;
        const diffText = diff > 0 ? `+${diff}` : diff;
        const diffColor = diff === 0 ? 'color:#10b981;' : 'color:var(--bad); font-weight:700;';

        const statusClass = d.status.toLowerCase().includes('pending') ? 'pill open' : 'pill bad';

        return `<tr onclick="openModalDecision('${d.id}')">
            <td>${esc(d.id)}</td>
            <td>${esc(d.binId)}</td>
            <td>${esc(d.sku)}</td>
            <td>${d.expected}</td>
            <td>${d.counted}</td>
            <td style="${diffColor}">${diffText}</td>
            <td><span class="${statusClass}">${d.status}</span></td>
            <td><button class="btn primary" onclick="event.stopPropagation(); openModalDecision('${d.id}')">Review</button></td>
        </tr>`;
    }).join('');

    container.innerHTML = `<table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Bin</th>
                <th>SKU</th>
                <th>Expected Qty</th>
                <th>Counted Qty</th>
                <th>Variance</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>${tableRows}</tbody>
    </table>`;
}

function render() {
    loadState();
    // Re-check for mock data every time in case localStorage was cleared externally
    if (state.discrepancies.length === 0) {
        seedDemoDiscrepancies();
        loadState(); // Reload after seeding
    }
    renderKPIs();
    renderDiscrepancyQueue();
    paintIcons(document);
}


// --- MODAL / ACTION FUNCTIONS ---

function openModalDecision(discId) {
    currentDiscrepancy = state.discrepancies.find(d => d.id === discId);
    if (!currentDiscrepancy) {
        showMessage('Error', 'Discrepancy not found.');
        return;
    }
    
    document.getElementById('modalDiscId').textContent = currentDiscrepancy.id;
    document.getElementById('reviewReason').value = currentDiscrepancy.reason || '';

    const diff = currentDiscrepancy.counted - currentDiscrepancy.expected;
    const diffColor = diff === 0 ? 'color:#10b981;' : 'color:var(--bad); font-weight:700;';
    
    document.getElementById('decisionDetails').innerHTML = `
        <p class="muted">Bin ID: <b>${esc(currentDiscrepancy.binId)}</b> | SKU: <b>${esc(currentDiscrepancy.sku)}</b></p>
        <p style="font-size: var(--fs-lg); margin-top: 5px;">
            Expected: <b>${currentDiscrepancy.expected}</b> | Counted: <b>${currentDiscrepancy.counted}</b> | Variance: <b style="${diffColor}">${diff}</b>
        </p>
        <p class="muted" style="font-size:var(--fs-sm);">
            Type: ${currentDiscrepancy.type}. Scanned Time: ${fmtWhen(currentDiscrepancy.when)}
        </p>
        <!-- Simulation for viewing evidence is simple button -->
        <button class="btn" style="padding: 6px 12px; margin-top: 10px;" onclick="showMessage('Evidence', 'Simulated viewing of counter notes and photos.', 'info')">
            <span class="ico-inline" data-ic="report"></span> Examine Evidence (Notes/Photos)
        </button>
    `;
    
    document.getElementById('modalDecision').style.display = 'flex';
}

function closeModalDecision() {
    currentDiscrepancy = null;
    document.getElementById('modalDecision').style.display = 'none';
}

// Option 1: Recount / Re-enter
function actionRecount() {
    const reason = document.getElementById('reviewReason').value.trim();
    if (!reason) {
        showMessage('Error', 'Reason for Recount/Re-enter is required.');
        return;
    }
    
    currentDiscrepancy.status = 'Recount Pending'; 
    currentDiscrepancy.reason = reason;
    persistState();
    closeModalDecision();
    render();
    showMessage('Action Complete', `Discrepancy ${currentDiscrepancy.id} marked for Recount. Reason: ${reason}`);
}

// Option 2: Approve Variance
function actionApproveVariance() {
    const reason = document.getElementById('reviewReason').value.trim();
    if (!reason) {
        showMessage('Error', 'Justification for Approving Variance is required.');
        return;
    }
    
    currentDiscrepancy.status = 'Closed - Approved Variance';
    currentDiscrepancy.resolution = 'Approved Variance';
    currentDiscrepancy.reason = reason;
    currentDiscrepancy.resolvedBy = 'AdminUser';
    currentDiscrepancy.resolvedTime = Date.now();
    
    persistState();
    closeModalDecision();
    render();
    showMessage('Action Complete', `Discrepancy ${currentDiscrepancy.id} Closed/Approved. Ready for SAP posting.`);
}

function postToSAP() {
    const resolvedDiscrepancies = state.discrepancies.filter(d => d.status.includes('Closed'));
    
    if (resolvedDiscrepancies.length === 0) {
        showMessage('SAP Posting Alert', 'No resolved discrepancies found to post to SAP.');
        return;
    }

    showConfirm('Confirm SAP Posting', `Are you sure you want to finalize and post ${resolvedDiscrepancies.length} resolved discrepancies to SAP? This action cannot be undone.`, () => {
        // Mark all 'Closed' items as 'Posted' (simulating final data sync)
        state.discrepancies.forEach(d => {
            if (d.status.includes('Closed')) {
                d.status = 'Posted to SAP';
            }
        });
        persistState();
        render();
        showMessage('SAP Posting Successful', `${resolvedDiscrepancies.length} records posted to SAP and synchronized.`);
    });
}

// --- SHARED UI UTILITIES (from mobile app) ---
document.body.insertAdjacentHTML('beforeend', `
  <div class="modal" id="customModal">
    <div class="dialog" style="max-width:400px;border-radius:18px">
      <div class="sheet" style="padding:20px;border:none;border-radius:18px">
        <h3 id="modalTitle" style="margin-top:0"></h3>
        <p id="modalBody"></p>
        <div id="modalButtons" class="row" style="justify-content:flex-end"></div>
      </div>
    </div>
  </div>
`);
const modal = document.getElementById('customModal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalButtons = document.getElementById('modalButtons');

function showMessage(title, message){
  modalTitle.textContent = title;
  modalBody.textContent = message;
  modalButtons.innerHTML = `<button class="btn primary" onclick="closeModal()">OK</button>`;
  modal.style.display = 'flex';
}

function showConfirm(title, message, onConfirm, onCancel=null){
  modalTitle.textContent = title;
  modalBody.textContent = message;
  modalButtons.innerHTML = `
    <button class="btn" onclick="closeModal(); ${onCancel?`(${onCancel})()`:''}">Cancel</button>
    <button class="btn bad" onclick="closeModal(); (${onConfirm})()">Confirm</button>
  `;
  modal.style.display = 'flex';
}

function closeModal(){ modal.style.display = 'none'; }


// --- BOOTSTRAP ---
window.onload = function() {
    render();
    setInterval(render, 5000); // Auto-refresh data every 5 seconds
    paintIcons(document.querySelector('header'));
    paintIcons(document.getElementById('discrepancyQueue'));
    paintIcons(document.querySelector('.card:last-child'));
};
</script>
</body>
</html>
