<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Physical Count — V6 (Monochrome • Proposal Order)</title>
<style>
  :root{
    --bg:#f6f8fb; --panel:#ffffff; --muted:#637082; --text:#0b1220;
    --brand:#2563eb; --line:#e4e8ef; --shadow:0 2px 8px rgba(15,23,42,.08);
    --radius:12px; --inset: env(safe-area-inset-bottom, 0);
    --fs-xs: clamp(11px, 1.4vw, 12px);
    --fs-sm: clamp(12px, 1.6vw, 13px);
    --fs-md: clamp(13px, 1.9vw, 15px);
    --fs-lg: clamp(15px, 2.3vw, 17px);
    --fs-xl: clamp(17px, 2.8vw, 20px);
    --icon: 16px; --icon-inline: 14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:var(--fs-md)/1.5 Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  header{position:sticky;top:0;z-index:30;display:flex;align-items:center;gap:8px;padding:8px 12px;background:#fff;border-bottom:1px solid var(--line);box-shadow:var(--shadow)}
  .brand{width:14px;height:14px;border-radius:4px;background:var(--brand)}
  h1{margin:0;font-size:var(--fs-lg)}
  .sub{color:var(--muted);font-size:var(--fs-xs)}
  .container{max-width:1100px;margin:0 auto;padding:10px}
  .grid{display:grid;gap:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:10px;box-shadow:var(--shadow)}
  .card h3{margin:0 0 6px 0;font-size:var(--fs-lg);display:flex;align-items:center;gap:6px}
  .muted{color:var(--muted)}
  /* Inputs */
  input,select,textarea,button{font-size:var(--fs-md)}
  input,select,textarea{width:100%;background:#fff;border:1px solid #dbe3ea;color:var(--text);padding:8px 10px;border-radius:10px;outline:none;min-height:36px}
  input:focus,select:focus,textarea:focus{border-color:#93c5fd;box-shadow:0 0 0 2px rgba(147,197,253,.25)}
  label{font-size:var(--fs-sm);color:#334155;display:block;margin-bottom:4px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;background:#fff;border:1px solid #cbd5e1;color:#0f172a;padding:8px 12px;border-radius:10px;cursor:pointer;min-height:36px}
  .btn.primary{border-color:var(--brand);background:#eff6ff;color:#1d4ed8}
  .btn.ok{border-color:#86efac;color:#14532d;background:#ecfdf5}
  .btn.warn{border-color:#facc15;color:#713f12;background:#fffbeb}
  .btn.bad{border-color:#fecaca;color:#7f1d1d;background:#fef2f2}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;color:#334155;font-size:var(--fs-sm)}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  th,td{text-align:left;padding:8px 10px}
  thead th{font-size:var(--fs-sm);color:#475569}
  tbody tr{background:#fff;border:1px solid #e5e7eb}
  tbody tr td:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
  tbody tr td:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}
  @media (max-width:760px){
    table thead{display:none}
    table tbody tr{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:6px}
    table tbody td{padding:6px 6px}
    table tbody td::before{content:attr(data-label);display:block;color:#64748b;font-size:var(--fs-xs);margin-bottom:2px}
  }
  /* Bottom tabs */
  .tabs{position:fixed;left:0;right:0;bottom:0;z-index:40;background:#fff;border-top:1px solid var(--line);
    padding:4px calc(8px + var(--inset)); display:flex;gap:4px;justify-content:space-around}
  .tab-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;border:0;background:transparent;color:#334155;
    padding:6px;border-radius:10px;min-height:50px}
  .tab-btn .ico{width:var(--icon);height:var(--icon);color:#2563eb}
  .tab-btn.active{background:#eff6ff;color:#1d4ed8;border:1px solid #dbeafe}
  .tab-btn.active .ico{color:#1d4ed8}
  .tab-btn span{font-size:var(--fs-xs)}
  .spacer{height:72px}
  /* Modals */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;align-items:flex-end;justify-content:center;z-index:50}
  .dialog{background:#fff;border-top-left-radius:14px;border-top-right-radius:14px;width:100%;max-width:680px;box-shadow:0 -10px 24px rgba(2,6,23,.16)}
  .sheet{padding:12px 12px calc(12px + var(--inset)) 12px;border-top:1px solid var(--line)}
  .close{position:absolute;right:10px;top:8px;background:#fff;border:1px solid #cbd5e1;color:#334155;border-radius:8px;padding:4px 8px;cursor:pointer}
  /* Icon system */
  svg{display:block}
  .ico svg{width:100%;height:100%}
  .ico-inline{width:var(--icon-inline);height:var(--icon-inline);color:#2563eb}
</style>
</head>
<body>
<header>
  <div class="brand" aria-hidden="true"></div>
  <div>
    <h1>Physical Count</h1>
    <div class="sub">Monochrome • Ordered by Proposal • Mobile‑first</div>
  </div>
</header>

<div class="container" id="view"></div>
<div class="spacer"></div>

<!-- Bottom Tabs (ordered by proposal) -->
<div class="tabs">
  <button class="tab-btn active" data-view="plan"><div class="ico" data-ic="plan"></div><span>Plan</span></button>
  <button class="tab-btn" data-view="assign"><div class="ico" data-ic="users"></div><span>Assign</span></button>
  <button class="tab-btn" data-view="execute"><div class="ico" data-ic="scan"></div><span>Execute</span></button>
  <button class="tab-btn" data-view="validate"><div class="ico" data-ic="shield"></div><span>Validate</span></button>
  <button class="tab-btn" data-view="reports"><div class="ico" data-ic="report"></div><span>Reports</span></button>
</div>

<!-- Scan Sheet -->
<div class="modal" id="sheetScan">
  <div class="dialog">
    <div class="sheet">
      <button class="close" onclick="toggleSheet('sheetScan',false)">✕</button>
      <h3><span class="ico-inline" data-ic="scan"></span> Scan & Count</h3>
      <div class="row">
        <div class="card" style="flex:1;min-width:220px"><label>Location / Bin</label><input id="sc-loc" placeholder="Shelf A01 or Bin A01-05-002"/></div>
        <div class="card" style="flex:1;min-width:220px"><label>SKU / EAN / Serial</label><input id="sc-sku" placeholder="8850123456789"/></div>
      </div>
      <div class="row">
        <div class="card" style="flex:1;min-width:120px"><label>Qty</label><input id="sc-qty" type="number" value="1"/></div>
        <div class="card" style="flex:1;min-width:120px"><label>Blind</label><select id="sc-blind"><option value="true">On</option><option value="false">Off</option></select></div>
      </div>
      <div class="row"><div class="card" style="flex:1"><label>Notes</label><input id="sc-note" placeholder="Optional note"/></div></div>
      <div class="row">
        <button class="btn ok" onclick="submitScan()"><span class="ico-inline" data-ic="tick"></span> Submit</button>
        <button class="btn" onclick="markDiscrepancy()"><span class="ico-inline" data-ic="alert"></span> Mark Discrepancy</button>
      </div>
    </div>
  </div>
</div>

<!-- Freeze Sheet -->
<div class="modal" id="sheetFreeze">
  <div class="dialog">
    <div class="sheet">
      <button class="close" onclick="toggleSheet('sheetFreeze',false)">✕</button>
      <h3><span class="ico-inline" data-ic="freeze"></span> Freeze / Unfreeze Bin</h3>
      <div class="row">
        <div class="card" style="flex:1;min-width:200px"><label>Bin ID</label><input id="fz-bin" placeholder="A01-05-002"/></div>
        <div class="card" style="flex:1;min-width:200px"><label>Reason</label><input id="fz-reason" placeholder="Cycle count in progress"/></div>
      </div>
      <div class="row">
        <button class="btn warn" onclick="freezeBin()"><span class="ico-inline" data-ic="freeze"></span> Freeze</button>
        <button class="btn ok" onclick="unfreezeBin()"><span class="ico-inline" data-ic="flame"></span> Unfreeze</button>
      </div>
    </div>
  </div>
</div>

<script>
// Icons (monochrome SVG, currentColor)
const ICONS = {
  plan:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 4v16M3 8h18"/></svg>`,
  users:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="8" cy="8" r="3"/><circle cx="16" cy="11" r="3"/><path d="M2 21a6 6 0 0 1 12 0"/><path d="M10 21a6 6 0 0 1 12 0"/></svg>`,
  scan:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M4 7V5a1 1 0 0 1 1-1h2M18 4h1a1 1 0 0 1 1 1v2M20 17v2a1 1 0 0 1-1 1h-2M6 20H5a1 1 0 0 1-1-1v-2"/>
    <rect x="8" y="8" width="8" height="8" rx="2"/></svg>`,
  shield:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M12 2l7 4v6c0 5-3.5 9-7 10-3.5-1-7-5-7-10V6l7-4z"/></svg>`,
  report:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M4 4h10l6 6v10a2 2 0 0 1-2 2H4z"/><path d="M14 4v6h6"/><path d="M8 16v4M12 14v6M16 12v8"/></svg>`,
  tick:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>`,
  alert:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M12 9v4"/><path d="M12 17h.01"/><path d="M10.3 3.2 1.7 18a2 2 0 0 0 1.7 3h17a2 2 0 0 0 1.7-3L13.7 3.2a2 2 0 0 0-3.4 0z"/></svg>`,
  freeze:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M4 12h16M6 6l12 12M18 6L6 18"/></svg>`,
  flame:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3s4 3 4 7-2 5-4 5-4-1-4-5 4-7 4-7z"/></svg>`,
  boxes:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M3 7l9-4 9 4-9 4-9-4z"/><path d="M3 17l9 4 9-4"/><path d="M3 12l9 4 9-4"/></svg>`,
  map:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l-6 3V6l6-3 6 3 6-3v15l-6 3-6-3z"/><path d="M9 3v15M15 6v15"/></svg>`,
  arrow:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg>`
};
function paintIcons(scope=document){ scope.querySelectorAll('[data-ic]').forEach(el=>{ el.innerHTML = ICONS[el.getAttribute('data-ic')]||''; }); }

// State
const state = {
  sessions: JSON.parse(localStorage.getItem('pc_sessions')||'[]'),
  routes: JSON.parse(localStorage.getItem('pc_routes')||'[]'),
  assignments: JSON.parse(localStorage.getItem('pc_assignments')||'[]'),
  scans: JSON.parse(localStorage.getItem('pc_scans')||'[]'),
  discrepancies: JSON.parse(localStorage.getItem('pc_disc')||'[]'),
  freezes: JSON.parse(localStorage.getItem('pc_freezes')||'[]'),
  maps: JSON.parse(localStorage.getItem('pc_maps')||'[]'),
  cfg: JSON.parse(localStorage.getItem('pc_cfg')||'null')
};
function persist(){
  localStorage.setItem('pc_sessions', JSON.stringify(state.sessions));
  localStorage.setItem('pc_routes', JSON.stringify(state.routes));
  localStorage.setItem('pc_assignments', JSON.stringify(state.assignments));
  localStorage.setItem('pc_scans', JSON.stringify(state.scans));
  localStorage.setItem('pc_disc', JSON.stringify(state.discrepancies));
  localStorage.setItem('pc_freezes', JSON.stringify(state.freezes));
  localStorage.setItem('pc_maps', JSON.stringify(state.maps));
  localStorage.setItem('pc_cfg', JSON.stringify(state.cfg));
}
(function seed(){
  const fresh = !state.sessions.length && !state.routes.length && !state.assignments.length && !state.scans.length &&
                !state.discrepancies.length && !state.freezes.length && !state.maps.length && !state.cfg;
  if(!fresh) return;
  const now = Date.now();
  state.sessions = [{
    id:'S-2025-09-001', site:'BKK01', asof:'2025-09-01',
    scope:{category:'Beverage', brand:'Cola', vendor:'VND001'},
    repeat:'Quarterly',
    sections:[{section:'A01', bins:40},{section:'A02', bins:32},{section:'Backroom-FRZ', bins:12}]
  }];
  state.routes = [
    {type:'system', section:'A01', route:['A01-01','A01-02','A01-03','A01-04']},
    {type:'system', section:'A02', route:['A02-01','A02-02','A02-03']},
    {type:'system', section:'Backroom-FRZ', route:['FRZ-01','FRZ-02']},
  ];
  state.assignments = [
    {user:'alice', section:'A01', route:['A01-01','A01-02']},
    {user:'bob', section:'A01', route:['A01-03','A01-04']},
    {user:'carl', section:'A02', route:['A02-01','A02-02']},
    {user:'diana', section:'Backroom-FRZ', route:['FRZ-01','FRZ-02']},
  ];
  state.scans = [
    {when:now-7200e3, loc:'Shelf A01', sku:'EAN-885000000001', qty:6, blind:true, note:'promo'},
    {when:now-6800e3, loc:'Shelf A01', sku:'EAN-885000000002', qty:3, blind:true, note:''},
    {when:now-3600e3, loc:'Bin A01-05-002', sku:'SKU-2002', qty:2, blind:false, note:''},
    {when:now-1200e3, loc:'Bin A02-01-004', sku:'SKU-3003', qty:9, blind:false, note:'box opened'},
  ];
  state.discrepancies = [
    {id:'D-1001', type:'QtyMismatch', loc:'Shelf A01', sku:'EAN-885000000001', expected:10, counted:6, status:'Open'},
    {id:'D-1002', type:'BinLocked', loc:'Bin A01-05-002', sku:'SKU-2002', expected:3, counted:2, status:'Open'},
  ];
  state.freezes = [
    {bin:'A01-05-002', reason:'Cycle count', when:now-3000e3},
    {bin:'FRZ-01', reason:'Backroom Frozen', when:now-5000e3}
  ];
  state.maps = [{shelf:'A01', bin:'A01-05-001'}, {shelf:'A01', bin:'A01-05-002'}, {shelf:'A02', bin:'A02-01-004'}, {shelf:'FRZ', bin:'FRZ-01'}];
  state.cfg = {blind:true, twoMatch:true, photo:true, maxVariance:5};
  persist();
})();

// Router
const view = document.getElementById('view');
document.querySelectorAll('.tab-btn').forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    location.hash = b.dataset.view;
    render();
  };
});
window.addEventListener('hashchange', render);
function render(){
  const route = (location.hash||'#plan').replace('#','');
  switch(route){
    case 'plan': return renderPlan();
    case 'assign': return renderAssign();
    case 'execute': return renderExecute();
    case 'validate': return renderValidate();
    case 'reports': return renderReports();
    default: return renderPlan();
  }
}
render(); paintIcons(document);

// Views
function renderPlan(){
  const s = state.sessions[0];
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="plan"></span> 1) Action Plan Creation</h3>
        <div class="row">
          <div style="flex:1;min-width:150px"><label>Site</label><input id="pl-site" value="${s?esc(s.site):'BKK01'}"/></div>
          <div style="flex:1;min-width:150px"><label>As-of</label><input id="pl-asof" value="${s?esc(s.asof):''}" placeholder="YYYY-MM-DD"/></div>
          <div style="flex:1;min-width:150px"><label>Repeat</label><input id="pl-repeat" value="${s?esc(s.repeat||'One-time'):''}"/></div>
        </div>
        <div class="row">
          <div style="flex:1;min-width:150px"><label>Category</label><input id="pl-cat" value="${s?esc(s.scope.category):''}"/></div>
          <div style="flex:1;min-width:150px"><label>Brand</label><input id="pl-brand" value="${s?esc(s.scope.brand):''}"/></div>
          <div style="flex:1;min-width:150px"><label>Vendor</label><input id="pl-vendor" value="${s?esc(s.scope.vendor):''}"/></div>
        </div>
        <div class="row">
          <button class="btn primary" onclick="savePlan()"><span class="ico-inline" data-ic="tick"></span> Save Plan</button>
          <button class="btn" onclick="insertMockPlan()"><span class="ico-inline" data-ic="arrow"></span> Insert Mock Plan</button>
        </div>
      </div>

      <div class="card">
        <h3><span class="ico-inline" data-ic="map"></span> 1.1) System‑Guided Route Planning</h3>
        <div class="row">
          <button class="btn primary" onclick="systemGuidedRoute()"><span class="ico-inline" data-ic="arrow"></span> Generate Routes</button>
          <button class="btn" onclick="insertMockRoute()"><span class="ico-inline" data-ic="arrow"></span> Insert Mock Route</button>
        </div>
        ${renderRoutes()}
      </div>

      <div class="card">
        <h3><span class="ico-inline" data-ic="map"></span> 1.2) Manual Route Planning</h3>
        <div class="row">
          <div style="flex:1;min-width:140px"><label>Section</label><input id="mr-section" placeholder="A01"/></div>
          <div style="flex:2;min-width:200px"><label>Stops (comma)</label><input id="mr-stops" placeholder="A01-01,A01-02,A01-03"/></div>
          <div style="align-self:end"><button class="btn ok" onclick="manualRouteCreate()"><span class="ico-inline" data-ic="tick"></span> Add Manual Route</button></div>
        </div>
      </div>

      <div class="card">
        <h3><span class="ico-inline" data-ic="map"></span> Sections</h3>
        ${s? tableSections(s.sections): empty('No sections.')}
        <div class="row" style="margin-top:6px">
          <div style="flex:1;min-width:140px"><label>Section</label><input id="sec-name" placeholder="A03"/></div>
          <div style="flex:1;min-width:140px"><label>Bins</label><input id="sec-bins" type="number" value="12"/></div>
          <div style="align-self:end"><button class="btn ok" onclick="addSection()"><span class="ico-inline" data-ic="tick"></span> Add Section</button></div>
        </div>
      </div>
    </div>`;
  paintIcons(view);
}
function tableSections(secs){
  return `<table><thead><tr><th>Section</th><th>Bins</th></tr></thead>
    <tbody>${secs.map(x=>`<tr>
      <td data-label="Section">${esc(x.section)}</td>
      <td data-label="Bins"><span class="pill">${x.bins}</span></td>
    </tr>`).join('')}</tbody></table>`;
}
function renderRoutes(){
  if(!state.routes.length) return empty('No routes yet.');
  return `<div class="grid" style="margin-top:6px">
    ${state.routes.map((r,i)=>`<div class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div><b>${r.type.toUpperCase()}</b> — ${esc(r.section)}: ${r.route.join(' → ')}</div>
      <button class="btn bad" onclick="delRoute(${i})"><span class="ico-inline" data-ic="alert"></span> Delete</button>
    </div>`).join('')}
  </div>`;
}
function delRoute(i){ state.routes.splice(i,1); persist(); renderPlan(); }
function systemGuidedRoute(){
  const s = state.sessions[0]; if(!s){alert('Create a plan first'); return;}
  s.sections.forEach(sec=>{
    const stops = Math.ceil(sec.bins/4);
    const route = Array.from({length:stops},(_,i)=>`${sec.section}-${String(i+1).padStart(2,'0')}`);
    state.routes.push({type:'system', section:sec.section, route});
  });
  persist(); renderPlan();
}
function manualRouteCreate(){
  const section = document.getElementById('mr-section').value.trim();
  const list = document.getElementById('mr-stops').value.trim();
  if(!section||!list){ alert('Enter Section & Stops'); return; }
  const route = list.split(',').map(s=>s.trim()).filter(Boolean);
  state.routes.push({type:'manual', section, route}); persist(); renderPlan();
}
function insertMockPlan(){
  const s = state.sessions[0] || {id:'S-NEW', site:'BKK02', asof:'2025-10-01', scope:{}, repeat:'One-time', sections:[]};
  s.scope = {category:'Snack', brand:'Chip', vendor:'VND045'};
  s.sections = [{section:'S01', bins:20},{section:'S02', bins:18}];
  state.sessions = [s]; persist(); renderPlan();
}
function addSection(){
  const s = state.sessions[0]; if(!s){alert('Save a plan first');return;}
  const name = document.getElementById('sec-name').value.trim(); const bins = +document.getElementById('sec-bins').value||0;
  if(!name || bins<=0) { alert('Enter section and bins>0'); return; }
  s.sections.push({section:name,bins}); persist(); renderPlan();
}
function savePlan(){
  const s = state.sessions[0] || {id:'S-NEW', scope:{}, sections:[]};
  s.site = document.getElementById('pl-site').value.trim();
  s.asof = document.getElementById('pl-asof').value.trim();
  s.repeat = document.getElementById('pl-repeat').value.trim();
  s.scope.category = document.getElementById('pl-cat').value.trim();
  s.scope.brand = document.getElementById('pl-brand').value.trim();
  s.scope.vendor = document.getElementById('pl-vendor').value.trim();
  state.sessions = [s]; persist(); alert('Plan saved (demo).');
}
function insertMockRoute(){
  state.routes.push({type:'manual', section:'A01', route:['A01-01','A01-02','A01-03']});
  state.routes.push({type:'manual', section:'A02', route:['A02-01','A02-02']});
  persist(); renderPlan();
}

// Assign
function renderAssign(){
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="users"></span> 2) Allocation Assignment</h3>
        ${tableAssign(state.assignments)}
        <div class="row" style="margin-top:6px">
          <div style="flex:1;min-width:140px"><label>User</label><input id="as-user" placeholder="alice"/></div>
          <div style="flex:1;min-width:140px"><label>Section</label><input id="as-section" placeholder="A01"/></div>
          <div style="flex:2;min-width:180px"><label>Route (comma)</label><input id="as-route" placeholder="A01-01,A01-02"/></div>
          <div style="align-self:end"><button class="btn ok" onclick="addAssign()"><span class="ico-inline" data-ic="tick"></span> Assign</button></div>
        </div>
        <div class="row">
          <button class="btn primary" onclick="autoAssign()"><span class="ico-inline" data-ic="arrow"></span> Auto-Assign</button>
          <button class="btn" onclick="insertMockAssign()"><span class="ico-inline" data-ic="arrow"></span> Insert Mock</button>
        </div>
      </div>
    </div>`;
  paintIcons(view);
}
function tableAssign(arr){
  if(!arr.length) return empty('No assignments yet.');
  return `<table><thead><tr><th>User</th><th>Section</th><th>Route</th></tr></thead>
    <tbody>${arr.map(a=>`<tr>
      <td data-label="User">${esc(a.user)}</td>
      <td data-label="Section">${esc(a.section)}</td>
      <td data-label="Route">${a.route.join(', ')}</td>
    </tr>`).join('')}</tbody></table>`;
}
function addAssign(){
  const user = document.getElementById('as-user').value.trim();
  const section = document.getElementById('as-section').value.trim();
  const route = document.getElementById('as-route').value.split(',').map(s=>s.trim()).filter(Boolean);
  if(!user||!section||!route.length){ alert('Fill User/Section/Route'); return; }
  state.assignments.push({user, section, route}); persist(); renderAssign();
}
function autoAssign(){
  const users = ['alice','bob','carl','diana'];
  if(!state.routes.length){ alert('Plan routes first.'); return; }
  const out=[]; let ui=0;
  for(const r of state.routes){
    out.push({user:users[ui%users.length], section:r.section, route:r.route});
    ui++;
  }
  state.assignments = out; persist(); renderAssign();
}
function insertMockAssign(){
  state.assignments.push({user:'erin', section:'S01', route:['S01-01','S01-02']});
  persist(); renderAssign();
}

// Execute
function renderExecute(){
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="scan"></span> 3) Execution (Track / Freeze)</h3>
        <div class="row">
          <button class="btn ok" onclick="toggleSheet('sheetScan',true)"><span class="ico-inline" data-ic="scan"></span> Scan & Count</button>
          <button class="btn warn" onclick="toggleSheet('sheetFreeze',true)"><span class="ico-inline" data-ic="freeze"></span> Freeze Bin</button>
          <button class="btn" onclick="insertMockScan()"><span class="ico-inline" data-ic="arrow"></span> Insert Mock Scan</button>
        </div>
        ${listScans(state.scans.slice(-10).reverse())}
      </div>
      <div class="card">
        <h3><span class="ico-inline" data-ic="freeze"></span> Frozen Bins</h3>
        <div class="grid">${state.freezes.length? state.freezes.map(f=>`<div class="card" style="display:flex;justify-content:space-between;align-items:center">
          <div><b>${esc(f.bin)}</b> — ${esc(f.reason||'Frozen')}</div>
          <button class="btn ok" onclick="unfreezeDirect('${f.bin}')"><span class="ico-inline" data-ic="flame"></span> Unfreeze</button>
        </div>`).join('') : '<div class="muted">No frozen bins.</div>'}</div>
      </div>
    </div>`;
  paintIcons(view);
}
function listScans(arr){
  if(!arr.length) return empty('No scans yet.');
  return `<div class="grid">
    ${arr.map(r=>`<div class="card" style="padding:8px">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div style="display:flex;align-items:center;gap:6px">
          <span class="ico-inline" data-ic="boxes"></span>
          <div><b>${esc(r.sku)}</b><div class="muted" style="font-size:var(--fs-sm)">${esc(r.loc)}</div></div>
        </div>
        <div style="text-align:right">
          <span class="pill">Qty ${r.qty}</span>
          <div class="muted" style="font-size:var(--fs-xs)">${fmtWhen(r.when)}</div>
        </div>
      </div>
      <div class="muted" style="margin-top:2px;font-size:var(--fs-sm)">${r.blind?'Blind':''} ${esc(r.note||'')}</div>
    </div>`).join('')}
  </div>`;
}
function insertMockScan(){
  state.scans.push({when:Date.now(), loc:'Shelf S01', sku:'EAN-885000000099', qty:4, blind:true, note:'mock'});
  persist(); renderExecute();
}
function unfreezeDirect(bin){ state.freezes = state.freezes.filter(f=>f.bin!==bin); persist(); renderExecute(); }

// Validate
function renderValidate(){
  const cfg = state.cfg || {blind:true,twoMatch:true,photo:true,maxVariance:5};
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="shield"></span> 4) Validation & Exception Handling</h3>
        <div class="row">
          <div style="flex:1;min-width:140px"><label>Blind Count</label>
            <select id="cfg-blind"><option value="true"${cfg.blind?' selected':''}>On</option><option value="false"${!cfg.blind?' selected':''}>Off</option></select>
          </div>
          <div style="flex:1;min-width:140px"><label>Two-Match Principle</label>
            <select id="cfg-two"><option value="true"${cfg.twoMatch?' selected':''}>On</option><option value="false"${!cfg.twoMatch?' selected':''}>Off</option></select>
          </div>
          <div style="flex:1;min-width:140px"><label>Photo Evidence</label>
            <select id="cfg-photo"><option value="true"${cfg.photo?' selected':''}>Required</option><option value="false"${!cfg.photo?' selected':''}>Optional</option></select>
          </div>
          <div style="flex:1;min-width:140px"><label>Max Variance %</label>
            <input id="cfg-var" type="number" value="${cfg.maxVariance||5}"/>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn ok" onclick="saveCfg()"><span class="ico-inline" data-ic="tick"></span> Save</button>
          <button class="btn" onclick="insertMockException()"><span class="ico-inline" data-ic="alert"></span> Insert Mock Exception</button>
        </div>
      </div>
      <div class="card">
        <h3><span class="ico-inline" data-ic="alert"></span> Exception Queue</h3>
        ${listQueue(state.discrepancies)}
      </div>
    </div>`;
  paintIcons(view);
}
function listQueue(arr){
  if(!arr.length) return empty('No discrepancies. Great job!');
  return `<div class="grid">
    ${arr.map(d=>`<div class="card" style="padding:8px;display:grid;gap:6px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;align-items:center;gap:6px">
          <span class="ico-inline" data-ic="alert"></span>
          <div><b>${esc(d.id)}</b> — ${esc(d.type||'Exception')} — ${esc(d.sku)}</div>
        </div>
        <span class="pill">${d.status}</span>
      </div>
      <div class="muted">${esc(d.loc)}</div>
      <div>Expected <b>${d.expected}</b> • Counted <b>${d.counted}</b></div>
      <div class="row">
        <button class="btn ok" onclick="closeDisc('${d.id}')"><span class="ico-inline" data-ic="tick"></span> Approve & Close</button>
      </div>
    </div>`).join('')}
  </div>`;
}
function insertMockException(){
  const id = 'D-' + Math.floor(Math.random()*9000+1000);
  state.discrepancies.push({id, type:'SerialMismatch', loc:'Bin S01-01', sku:'SER-0001', expected:1, counted:1, status:'Open'});
  persist(); renderValidate();
}
function saveCfg(){
  state.cfg = {
    blind: document.getElementById('cfg-blind').value==='true',
    twoMatch: document.getElementById('cfg-two').value==='true',
    photo: document.getElementById('cfg-photo').value==='true',
    maxVariance: +document.getElementById('cfg-var').value||5
  };
  persist();
  alert('Validation rules saved (demo).');
}
function closeDisc(id){ const it = state.discrepancies.find(x=>x.id===id); if(it){ it.status='Closed'; persist(); renderValidate(); }}

// Reports
function renderReports(){
  const total = state.sessions.flatMap(s=>s.sections||[]).reduce((a,b)=>a+(b.bins||0),0);
  const counted = state.scans.length;
  const open = state.discrepancies.filter(d=>d.status!=='Closed').length;
  const frozen = state.freezes.length;
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="report"></span> 5) Reports</h3>
        <div class="row">
          <div class="pill">Planned Bins: <b>${total}</b></div>
          <div class="pill">Counted Entries: <b>${counted}</b></div>
          <div class="pill">Open Exceptions: <b>${open}</b></div>
          <div class="pill">Frozen Bins: <b>${frozen}</b></div>
        </div>
      </div>
      <div class="card">
        <h3><span class="ico-inline" data-ic="report"></span> Recent Scans (CSV)</h3>
        ${listScans(state.scans.slice(-12).reverse())}
        <div class="row"><button class="btn primary" onclick="exportCSV()"><span class="ico-inline" data-ic="arrow"></span> Export CSV</button></div>
      </div>
    </div>`;
  paintIcons(view);
}
function exportCSV(){
  const rows = [['when','location','sku','qty','blind','note']]
    .concat(state.scans.map(s=>[new Date(s.when).toISOString(), s.loc, s.sku, s.qty, s.blind, (s.note||'')]));
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'physical_count_scans.csv'; a.click();
  URL.revokeObjectURL(url);
}

// Shared
function toggleSheet(id, on){ document.getElementById(id).style.display = on?'flex':'none'; }
function empty(text){
  return `<div class="card" style="text-align:center;padding:12px">
    <div class="ico-inline" data-ic="boxes" style="margin:0 auto 4px auto"></div>
    <div class="muted">${esc(text)}</div>
  </div>`;
}
function esc(s){return (s??'').toString().replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
function fmtWhen(t){const d=new Date(t||Date.now()); return d.toLocaleString();}

paintIcons(document);
</script>
</body>
</html>
