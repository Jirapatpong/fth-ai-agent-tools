<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Physical Count — V7.13 Light (Expected SKUs)</title>
<style>
  :root{
    --bg:#f6f8fb; --panel:#ffffff; --muted:#637082; --text:#0b1220;
    --brand:#2563eb; --line:#e4e8ef; --shadow:0 2px 8px rgba(15,23,42,.08);
    --radius:12px; --inset: env(safe-area-inset-bottom, 0);
    --fs-xs: clamp(11px, 1.4vw, 12px);
    --fs-sm: clamp(12px, 1.6vw, 13px);
    --fs-md: clamp(13px, 1.9vw, 15px);
    --fs-lg: clamp(15px, 2.3vw, 17px);
    --fs-xl: clamp(17px, 2.8vw, 20px);
    --icon: 16px; --icon-inline: 14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:var(--fs-md)/1.5 Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  header{position:sticky;top:0;z-index:30;display:flex;align-items:center;gap:8px;padding:8px 12px;background:#fff;border-bottom:1px solid var(--line);box-shadow:var(--shadow)}
  .brand{width:14px;height:14px;border-radius:4px;background:var(--brand)}
  h1{margin:0;font-size:var(--fs-lg)}
  .sub{color:var(--muted);font-size:var(--fs-xs)}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;color:#334155;font-size:var(--fs-sm)}
  .container{max-width:1100px;margin:0 auto;padding:10px}
  .grid{display:grid;gap:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:10px;box-shadow:var(--shadow)}
  .card h3{margin:0 0 6px 0;font-size:var(--fs-lg);display:flex;align-items:center;gap:6px}
  .muted{color:var(--muted)}
  input,select,textarea,button{font-size:var(--fs-md)}
  input,select,textarea{width:100%;background:#fff;border:1px solid #dbe3ea;color:var(--text);padding:8px 10px;border-radius:10px;outline:none;min-height:36px}
  input:focus,select:focus,textarea:focus{border-color:#93c5fd;box-shadow:0 0 0 2px rgba(147,197,253,.25)}
  label{font-size:var(--fs-sm);color:#334155;display:block;margin-bottom:4px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;background:#fff;border:1px solid #cbd5e1;color:#0f172a;padding:8px 12px;border-radius:10px;cursor:pointer;min-height:36px}
  .btn.primary{border-color:var(--brand);background:#eff6ff;color:#1d4ed8}
  .btn.ok{border-color:#86efac;color:#14532d;background:#ecfdf5}
  .btn.warn{border-color:#facc15;color:#713f12;background:#fffbeb}
  .btn.bad{border-color:#fecaca;color:#7f1d1d;background:#fef2f2}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  th,td{text-align:left;padding:8px 10px}
  thead th{font-size:var(--fs-sm);color:#475569}
  tbody tr{background:#fff;border:1px solid #e5e7eb}
  tbody tr td:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
  tbody tr td:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}
  @media (max-width:760px){
    table thead{display:none}
    table tbody tr{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:6px}
    table tbody td{padding:6px 6px}
    table tbody td::before{content:attr(data-label);display:block;color:#64748b;font-size:var(--fs-xs);margin-bottom:2px}
  }
  .tabs{position:fixed;left:0;right:0;bottom:0;z-index:40;background:#fff;border-top:1px solid var(--line);
    padding:4px calc(8px + var(--inset)); display:flex;gap:4px;justify-content:space-around}
  .tab-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;border:0;background:transparent;color:#334155;
    padding:6px;border-radius:10px;min-height:50px}
  .tab-btn .ico{width:var(--icon);height:var(--icon);color:#2563eb}
  .tab-btn.active{background:#eff6ff;color:#1d4ed8;border:1px solid #dbeafe}
  .tab-btn.active .ico{color:#1d4ed8}
  .tab-btn span{font-size:var(--fs-xs)}
  .spacer{height:72px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;align-items:flex-end;justify-content:center;z-index:50}
  .dialog{background:#fff;border-top-left-radius:14px;border-top-right-radius:14px;width:100%;max-width:680px;box-shadow:0 -10px 24px rgba(2,6,23,.16)}
  .sheet{padding:12px 12px calc(12px + var(--inset)) 12px;border-top:1px solid var(--line)}
  .close{position:absolute;right:10px;top:8px;background:#fff;border:1px solid #cbd5e1;color:#334155;border-radius:8px;padding:4px 8px;cursor:pointer}
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px}
  .kpi{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:10px;box-shadow:var(--shadow)}
  .kpi .val{font-size:var(--fs-xl);font-weight:700}
  .kpi .lbl{font-size:var(--fs-sm);color:#475569}
  .progress{height:10px;background:#eef2ff;border-radius:999px;overflow:hidden;border:1px solid #dbeafe}
  .progress > i{display:block;height:100%;width:0;background:var(--brand);transition:width .4s ease}
  .bars{display:grid;gap:8px}
  .bar{display:flex;align-items:center;gap:8px}
  .bar .track{flex:1;height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden}
  .bar .track > i{display:block;height:100%;width:0;background:#2563eb}
  svg{display:block}
  .ico svg{width:100%;height:100%}
  .ico-inline{width:var(--icon-inline);height:var(--icon-inline);color:#2563eb}
  .login-wrap{min-height:calc(100dvh - 60px);display:flex;align-items:center;justify-content:center;padding:16px}
  .login-card{width:100%;max-width:460px}
</style>
</head>
<body>
<header>
  <div class="brand" aria-hidden="true"></div>
  <div>
    <h1>Physical Count</h1>
    <div class="sub">V7.13 — Light • <span id="activePlanBadge" class="pill">Plan: <b>—</b></span></div>
  </div>
  <button class="btn" id="logoutBtn" style="position:absolute;right:10px;top:10px;display:none" onclick="logout()">Logout</button>
</header>

<div class="container" id="loginView" style="display:none"></div>
<div class="container" id="view"></div>
<div class="spacer"></div>

<div class="tabs" id="tabs" style="display:none">
  <button class="tab-btn active" data-view="plan"><div class="ico" data-ic="plan"></div><span>Plan</span></button>
  <button class="tab-btn" data-view="assign"><div class="ico" data-ic="users"></div><span>Assign</span></button>
  <button class="tab-btn" data-view="execute"><div class="ico" data-ic="scan"></div><span>Execute</span></button>
  <button class="tab-btn" data-view="validate"><div class="ico" data-ic="shield"></div><span>Validate</span></button>
  <button class="tab-btn" data-view="reports"><div class="ico" data-ic="report"></div><span>Reports</span></button>
</div>

<div class="modal" id="sheetScan">
  <div class="dialog">
    <div class="sheet">
      <button class="close" onclick="toggleSheet('sheetScan',false)">✕</button>
      <h3><span class="ico-inline" data-ic="scan"></span> Scan & Count</h3>
      <div class="row">
        <div class="card" style="flex:1;min-width:220px">
          <label>Route Stop / Bin</label>
          <select id="sc-bin"></select>
        </div>
        <div class="card" style="flex:1;min-width:220px"><label>SKU / EAN / Serial</label><input id="sc-sku" placeholder="8850123456789"/></div>
      </div>
      <div class="row">
        <div class="card" style="flex:1;min-width:120px"><label>Qty</label><input id="sc-qty" type="number" value="1"/></div>
        <div class="card" style="flex:1;min-width:120px"><label>Blind</label><select id="sc-blind"><option value="true">On</option><option value="false">Off</option></select></div>
      </div>
      <div class="row"><div class="card" style="flex:1"><label>Notes</label><input id="sc-note" placeholder="Optional note"/></div></div>
      <div class="row">
        <button class="btn ok" onclick="submitScan()"><span class="ico-inline" data-ic="tick"></span> Submit</button>
        <button class="btn" onclick="markDiscrepancy()"><span class="ico-inline" data-ic="alert"></span> Mark Discrepancy</button>
      </div>
      <div class="row">
        <div class="card" style="flex:1;min-width:220px">
          <label>Camera</label>
          <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">
            <button class="btn" onclick="startCam()"><span class="ico-inline" data-ic='scan'></span> Open Camera</button>
            <button class="btn" onclick="stopCam()"><span class="ico-inline" data-ic='alert'></span> Close</button>
            <button class="btn primary" onclick="mockScanSKU()"><span class="ico-inline" data-ic='tick'></span> Mock Scan → SKU</button>
          </div>
          <video id="cam" autoplay playsinline style="width:100%;max-height:200px;border-radius:10px;background:#000"></video>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ===== STATE FIRST =====
let stateReady = false;
const state = {
  plans: [], routes: [], bins: [], assignments: [], scans: [], discrepancies: [], freezes: [], cfgByPlan: {}, currentPlanId: null
};
try{
  state.plans = JSON.parse(localStorage.getItem('pc_plans')||'[]') || [];
  state.routes = JSON.parse(localStorage.getItem('pc_routes')||'[]') || [];
  state.bins = JSON.parse(localStorage.getItem('pc_bins')||'[]') || [];
  state.assignments = JSON.parse(localStorage.getItem('pc_assignments')||'[]') || [];
  state.scans = JSON.parse(localStorage.getItem('pc_scans')||'[]') || [];
  state.discrepancies = JSON.parse(localStorage.getItem('pc_disc')||'[]') || [];
  state.freezes = JSON.parse(localStorage.getItem('pc_freezes')||'[]') || [];
  state.cfgByPlan = JSON.parse(localStorage.getItem('pc_cfgByPlan')||'{}') || {};
  state.currentPlanId = localStorage.getItem('pc_currentPlanId') || null;
  stateReady = true;
}catch(_){ stateReady = true; }

function persist(){
  try{
    localStorage.setItem('pc_plans', JSON.stringify(state.plans));
    localStorage.setItem('pc_routes', JSON.stringify(state.routes));
    localStorage.setItem('pc_bins', JSON.stringify(state.bins));
    localStorage.setItem('pc_assignments', JSON.stringify(state.assignments));
    localStorage.setItem('pc_scans', JSON.stringify(state.scans));
    localStorage.setItem('pc_disc', JSON.stringify(state.discrepancies));
    localStorage.setItem('pc_freezes', JSON.stringify(state.freezes));
    localStorage.setItem('pc_cfgByPlan', JSON.stringify(state.cfgByPlan));
    if(state.currentPlanId) localStorage.setItem('pc_currentPlanId', state.currentPlanId);
  }catch(_){}
}

// ===== ICONS =====
const ICONS = {
  plan:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 4v16M3 8h18"/></svg>`,
  users:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="8" cy="8" r="3"/><circle cx="16" cy="11" r="3"/><path d="M2 21a6 6 0 0 1 12 0"/><path d="M10 21a6 6 0 0 1 12 0"/></svg>`,
  scan:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M4 7V5a1 1 0 0 1 1-1h2M18 4h1a1 1 0 0 1 1 1v2M20 17v2a1 1 0 0 1-1 1h-2M6 20H5a1 1 0 0 1-1-1v-2"/>
    <rect x="8" y="8" width="8" height="8" rx="2"/></svg>`,
  shield:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M12 2l7 4v6c0 5-3.5 9-7 10-3.5-1-7-5-7-10V6l7-4z"/></svg>`,
  report:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M4 4h10l6 6v10a2 2 0 0 1-2 2H4z"/><path d="M14 4v6h6"/><path d="M8 16v4M12 14v6M16 12v8"/></svg>`,
  tick:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>`,
  alert:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M12 9v4"/><path d="M12 17h.01"/><path d="M10.3 3.2 1.7 18a2 2 0 0 0 1.7 3h17a2 2 0 0 0 1.7-3L13.7 3.2a2 2 0 0 0-3.4 0z"/></svg>`,
  freeze:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M4 12h16M6 6l12 12M18 6L6 18"/></svg>`,
  flame:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3s4 3 4 7-2 5-4 5-4-1-4-5 4-7 4-7z"/></svg>`,
  boxes:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M3 7l9-4 9 4-9 4-9-4z"/><path d="M3 17l9 4 9-4"/><path d="M3 12l9 4 9-4"/></svg>`,
  map:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l-6 3V6l6-3 6 3 6-3v15l-6 3-6-3z"/><path d="M9 3v15M15 6v15"/></svg>`,
  arrow:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg>`
};
function paintIcons(scope=document){ scope.querySelectorAll('[data-ic]').forEach(el=>{ el.innerHTML = ICONS[el.getAttribute('data-ic')]||''; }); }

// ===== AUTH =====
let currentUser = null;
try{ currentUser = localStorage.getItem('pc_user') || null; }catch(_){ currentUser = null; }
function showAppChrome(show){
  document.getElementById('tabs').style.display = show? 'flex':'none';
  document.getElementById('logoutBtn').style.display = show? 'inline-flex':'none';
}
function renderLogin(){
  const lv = document.getElementById('loginView');
  const app = document.getElementById('view');
  lv.style.display = 'block'; app.style.display = 'none';
  lv.innerHTML = `
    <div class="login-wrap">
      <div class="card login-card">
        <h3>Welcome — Sign in</h3>
        <div class="row" style="flex-direction:column">
          <div>
            <label>Username</label>
            <input id="lg-user" inputmode="text" autocomplete="username" placeholder="e.g., alice"/>
          </div>
          <div>
            <label>Password</label>
            <input id="lg-pass" type="password" autocomplete="current-password" placeholder="••••••••"/>
          </div>
          <div style="display:flex;align-items:center;gap:8px;margin-top:4px">
            <input id="lg-remember" type="checkbox" style="width:16px;height:16px" checked>
            <label for="lg-remember" style="margin:0">Remember me</label>
          </div>
        </div>
        <div class="row" style="justify-content:space-between">
          <button class="btn" onclick="fillDemo()">Use demo</button>
          <button class="btn primary" onclick="login()"><span class="ico-inline" data-ic="tick"></span> Login</button>
        </div>
        <div class="muted" style="font-size:var(--fs-sm)">Demo login only. Any user/password accepted.</div>
      </div>
    </div>`;
  paintIcons(lv); showAppChrome(false);
}
function fillDemo(){ const u=document.getElementById('lg-user'); const p=document.getElementById('lg-pass'); if(u) u.value='alice'; if(p) p.value='demo123'; }
function login(){
  const u = (document.getElementById('lg-user')||{}).value?.trim();
  if(!u){ alert('Enter a username'); return; }
  currentUser = u;
  try{ if(document.getElementById('lg-remember')?.checked){ localStorage.setItem('pc_user', u); } }catch(_){}
  showMain();
}
function logout(){
  currentUser = null;
  try{ localStorage.removeItem('pc_user'); }catch(_){}
  renderLogin(); refreshActivePlanBadge();
}
function showMain(){
  const lv = document.getElementById('loginView');
  const app = document.getElementById('view');
  lv.style.display = 'none'; app.style.display = 'block';
  showAppChrome(true);
  location.hash = '#plan'; render();
}

// ===== ROUTER & HELPERS =====
const view = document.getElementById('view');
document.querySelectorAll('.tab-btn').forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    location.hash = b.dataset.view;
    render();
  };
});
window.addEventListener('hashchange', render);
function render(){
  if(!stateReady) return;
  if(document.getElementById('loginView').style.display==='block') return;
  const route = (location.hash||'#plan').replace('#','');
  switch(route){
    case 'plan': return renderPlan();
    case 'assign': return renderAssign();
    case 'execute': return renderExecute();
    case 'validate': return renderValidate();
    case 'reports': return renderReports();
    default: return renderPlan();
  }
}
function keyOf(r){ return `${r.planId}|${r.section}|${r.type}`; }
function currentPlan(){ return state.plans.find(p=>p.id===state.currentPlanId) || null; }
function ensurePlan(){ if(!state.currentPlanId || !currentPlan()){ view.innerHTML = `<div class="card">Create or select an Action Plan first.</div>`; return false; } return true; }
function routesOfPlan(pid){ return state.routes.filter(r=>r.planId===pid); }
function allBinsOfPlan(pid){ return state.bins.filter(b=>b.planId===pid); }
function binsOfRoute(pid, routeKey){ return state.bins.filter(b=>b.planId===pid && b.routeKey===routeKey); }
function sumQtyForBin(pid, binId){ return state.scans.filter(s=>s.planId===pid && s.binId===binId).reduce((t,s)=>t+(+s.qty||0),0); }
function distinctSkuCountForBin(pid, binId){ return new Set(state.scans.filter(s=>s.planId===pid && s.binId===binId).map(s=>s.sku)).size; }
function refreshActivePlanBadge(){
  const badge = document.getElementById('activePlanBadge');
  if(!badge) return;
  const p = currentPlan();
  badge.innerHTML = 'Plan: <b>' + (p? esc(p.id) : '—') + '</b>';
}

// ===== PLAN =====
function planSelector(){
  return `<div class="row" style="align-items:end">
    <div style="flex:1;min-width:200px">
      <label>Active Plan</label>
      <select id="sel-plan" onchange="selectPlan(this.value)">
        <option value="" ${!state.currentPlanId?'selected':''}>— None —</option>
        ${state.plans.map(p=>`<option value="${p.id}" ${p.id===state.currentPlanId?'selected':''}>${p.id} — ${p.site||'-'} (${p.asof||'-'})</option>`).join('')}
      </select>
    </div>
  </div>`;
}
function selectPlan(pid){ state.currentPlanId = pid||null; persist(); render(); refreshActivePlanBadge(); }

function renderPlan(){
  const p = currentPlan();
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="plan"></span> 1) Action Plan</h3>
        ${planSelector()}
        <div class="row">
          <div style="flex:1;min-width:150px"><label>Plan ID</label><input id="pl-id" value="${p?esc(p.id):''}" placeholder="e.g., S-2025-10-001"/></div>
          <div style="flex:1;min-width:150px"><label>Site</label><input id="pl-site" value="${p?esc(p.site||''):''}" placeholder="BKK01"/></div>
          <div style="flex:1;min-width:150px"><label>As-of</label><input id="pl-asof" value="${p?esc(p.asof||''):''}" placeholder="YYYY-MM-DD"/></div>
          <div style="flex:1;min-width:150px"><label>Repeat</label><input id="pl-repeat" value="${p?esc(p.repeat||'One-time'):''}"/></div>
        </div>
        <div class="row">
          <div style="flex:1;min-width:150px"><label>Category</label><input id="pl-cat" value="${p?esc((p.scope||{}).category||''):''}"/></div>
          <div style="flex:1;min-width:150px"><label>Brand</label><input id="pl-brand" value="${p?esc((p.scope||{}).brand||''):''}"/></div>
          <div style="flex:1;min-width:150px"><label>Vendor</label><input id="pl-vendor" value="${p?esc((p.scope||{}).vendor||''):''}"/></div>
        </div>
        <div class="row">
          <button class="btn primary" onclick="savePlan()"><span class="ico-inline" data-ic="tick"></span> Save / Set Active</button>
          <button class="btn" onclick="seedDemo()"><span class="ico-inline" data-ic="arrow"></span> Insert Mock Data</button>
        </div>
      </div>

      <div class="card">
        <h3><span class="ico-inline" data-ic="map"></span> 1.1) System‑Guided Route (sub of Plan)</h3>
        <div class="row">
          <div style="flex:1;min-width:150px"><label>Section</label><input id="sg-section" placeholder="A01"/></div>
          <div style="flex:1;min-width:150px"><label>Stops per Route</label><input id="sg-stops" type="number" value="4"/></div>
          <div style="align-self:end"><button class="btn primary" onclick="systemGuidedRoute()"><span class="ico-inline" data-ic="arrow"></span> Generate</button></div>
        </div>
        ${renderRoutesTable()}
      </div>

      <div class="card">
        <h3><span class="ico-inline" data-ic="map"></span> 1.2) Manual Route (sub of Plan)</h3>
        <div class="row">
          <div style="flex:1;min-width:140px"><label>Section</label><input id="mr-section" placeholder="A02"/></div>
          <div style="flex:2;min-width:200px"><label>Stops (comma) — becomes Bins</label><input id="mr-stops" placeholder="A02-01,A02-02,A02-03"/></div>
          <div style="align-self:end"><button class="btn ok" onclick="manualRouteCreate()"><span class="ico-inline" data-ic="tick"></span> Add Manual Route</button></div>
        </div>
      </div>

      <div class="card">
        <h3><span class="ico-inline" data-ic="boxes"></span> 1.3) Bin Targets (Expected SKUs)</h3>
        ${renderBinTargets()}
      </div>
    </div>`;
  paintIcons(view); refreshActivePlanBadge();
}
function renderRoutesTable(){
  if(!state.currentPlanId) return '<div class="muted">Select or save a plan first.</div>';
  const list = routesOfPlan(state.currentPlanId);
  if(!list.length) return empty('No routes for this plan.');
  return `<table><thead><tr><th>Plan</th><th>Section</th><th>Type</th><th>Stops / Bins</th><th></th></tr></thead>
    <tbody>${list.map((r,i)=>`<tr>
      <td data-label="Plan">${esc(r.planId)}</td>
      <td data-label="Section">${esc(r.section)}</td>
      <td data-label="Type"><span class="pill">${r.type}</span></td>
      <td data-label="Stops">${esc(r.stops.join(', '))}</td>
      <td data-label=""><button class="btn bad" onclick="delRoute(${i})"><span class="ico-inline" data-ic="alert"></span> Delete</button></td>
    </tr>`).join('')}</tbody></table>`;
}
function renderBinTargets(){
  if(!state.currentPlanId) return '<div class="muted">Create routes to generate bins.</div>';
  const pid = state.currentPlanId;
  const bins = allBinsOfPlan(pid);
  if(!bins.length) return '<div class="muted">No bins yet. Create routes to generate bins.</div>';
  const rows = bins.map((b,i)=>{
    const expected = (b.expectedSkus!=null? b.expectedSkus : (b.expectedItems!=null?b.expectedItems:1)); // migrate
    const skuCnt = distinctSkuCountForBin(pid, b.binId);
    const qtySum = sumQtyForBin(pid, b.binId);
    const done = expected>0 ? skuCnt>=expected : skuCnt>0;
    return `<tr>
      <td data-label="Bin">${esc(b.section)} • ${esc(b.binId)}</td>
      <td data-label="Expected SKUs"><input type="number" min="0" value="${expected}" onchange="setBinExpected(${i}, this.value)"/></td>
      <td data-label="Counted SKUs">${skuCnt}</td>
      <td data-label="Qty Sum">${qtySum}</td>
      <td data-label="Status"><span class="pill" style="border-color:${done?'#86efac':'#cbd5e1'};background:${done?'#ecfdf5':'#fff'}">${done?'Completed':'Pending'}</span></td>
    </tr>`;
  }).join('');
  return `<div class="row"><button class="btn" onclick="setAllBinsExpected(1)">Set all to 1</button><button class="btn" onclick="setAllBinsExpected(0)">Set all to 0 (no target)</button></div>
          <table><thead><tr><th>Bin</th><th>Expected SKUs</th><th>Counted SKUs</th><th>Qty Sum</th><th>Status</th></tr></thead><tbody>${rows}</tbody></table>`;
}
function setBinExpected(idxInPlanBins, val){
  const pid = state.currentPlanId; if(!pid) return;
  const bins = allBinsOfPlan(pid);
  const b = bins[idxInPlanBins]; if(!b) return;
  const ref = state.bins.find(x=>x.planId===pid && x.binId===b.binId && x.routeKey===b.routeKey);
  if(!ref) return;
  ref.expectedSkus = Math.max(0, parseInt(val||0,10));
  persist(); render();
}
function setAllBinsExpected(val){
  const pid = state.currentPlanId; if(!pid) return;
  state.bins.filter(b=>b.planId===pid).forEach(b=>b.expectedSkus = Math.max(0, parseInt(val||0,10)));
  persist(); render();
}

function savePlan(){
  const id = document.getElementById('pl-id').value.trim();
  if(!id){ alert('Plan ID required'); return; }
  const site = document.getElementById('pl-site').value.trim();
  const asof = document.getElementById('pl-asof').value.trim();
  const repeat = document.getElementById('pl-repeat').value.trim();
  const scope = {category:document.getElementById('pl-cat').value.trim(),
                 brand:document.getElementById('pl-brand').value.trim(),
                 vendor:document.getElementById('pl-vendor').value.trim()};
  let p = state.plans.find(x=>x.id===id);
  if(!p){ p = {id, site, asof, repeat, scope}; state.plans.push(p); }
  else { Object.assign(p, {site, asof, repeat, scope}); }
  state.currentPlanId = id; persist(); alert('Plan saved & set active.');
  render(); refreshActivePlanBadge();
}
function seedDemo(){
  const id = 'DEMO-PLAN-001';
  const site = 'BKK01';
  const asof = new Date().toISOString().slice(0,10);
  const repeat = 'One-time';
  const scope = {category:'FMCG', brand:'Generic', vendor:'Supplier A'};
  let p = state.plans.find(x=>x.id===id);
  if(!p){ p = {id, site, asof, repeat, scope}; state.plans.push(p); }
  state.currentPlanId = id;

  const sys = {planId:id, section:'A01', type:'system', stops:['A01-01','A01-02','A01-03','A01-04']};
  const man = {planId:id, section:'B02', type:'manual', stops:['B02-01','B02-02','B02-03']};
  const existingKeys = new Set(state.routes.map(r=>keyOf(r)));
  [sys,man].forEach(r=>{ if(!existingKeys.has(keyOf(r))){ state.routes.push(r); r.stops.forEach(b=>state.bins.push({planId:id, routeKey:keyOf(r), binId:b, section:r.section, expectedSkus:1})); }});

  const rkSys = keyOf(sys), rkMan = keyOf(man);
  if(!state.assignments.some(a=>a.planId===id && a.routeKey===rkSys)) state.assignments.push({planId:id, routeKey:rkSys, user:'alice'});
  if(!state.assignments.some(a=>a.planId===id && a.routeKey===rkMan)) state.assignments.push({planId:id, routeKey:rkMan, user:'bob'});

  const pushScan = (rk, bin, sku, qty)=> state.scans.push({planId:id, routeKey:rk, binId:bin, when:Date.now(), sku, qty, blind:true, note:''});
  if(state.scans.filter(s=>s.planId===id).length<3){
    pushScan(rkSys,'A01-01','EAN-1234567890123',1);
    pushScan(rkSys,'A01-02','EAN-2234567890123',3);
    pushScan(rkMan,'B02-01','EAN-3234567890123',2);
  }

  persist(); alert('Inserted mock data for Action Plan DEMO-PLAN-001'); render(); refreshActivePlanBadge();
}
function systemGuidedRoute(){
  if(!state.currentPlanId) return alert('Save a Plan first.');
  const section = document.getElementById('sg-section').value.trim();
  const per = +document.getElementById('sg-stops').value||0;
  if(!section || per<=0){ alert('Section & Stops per Route required'); return; }
  const pid = state.currentPlanId;
  const r = {planId:pid, section, type:'system', stops:Array.from({length:per},(_,i)=>`${section}-${String(i+1).padStart(2,'0')}`)};
  state.routes.push(r);
  r.stops.forEach(b=>state.bins.push({planId:pid, routeKey:keyOf(r), binId:b, section, expectedSkus:1}));
  persist(); render();
}
function manualRouteCreate(){
  if(!state.currentPlanId) return alert('Save a Plan first.');
  const section = document.getElementById('mr-section').value.trim();
  const list = document.getElementById('mr-stops').value.trim();
  if(!section||!list){ alert('Enter Section & Stops'); return; }
  const stops = list.split(',').map(s=>s.trim()).filter(Boolean);
  const pid = state.currentPlanId;
  const r = {planId:pid, section, type:'manual', stops};
  state.routes.push(r);
  stops.forEach(b=>state.bins.push({planId:pid, routeKey:keyOf(r), binId:b, section, expectedSkus:1}));
  persist(); render();
}
function delRoute(i){
  const pid = state.currentPlanId;
  const r = routesOfPlan(pid)[i]; if(!r) return;
  const key = keyOf(r);
  state.assignments = state.assignments.filter(a=>!(a.planId===pid && a.routeKey===key));
  state.bins = state.bins.filter(b=>!(b.planId===pid && b.routeKey===key));
  state.scans = state.scans.filter(s=>!(s.planId===pid && s.routeKey===key));
  state.freezes = state.freezes.filter(f=>!(f.planId===pid && r.stops.includes(f.binId)));
  state.discrepancies = state.discrepancies.filter(d=>!(d.planId===pid && r.stops.includes(d.binId)));
  const idx = state.routes.findIndex(x=>x.planId===pid && keyOf(x)===key);
  if(idx>=0) state.routes.splice(idx,1);
  persist(); render();
}

// ===== ASSIGN =====
function renderAssign(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const routes = routesOfPlan(pid);
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="users"></span> 2) Allocation Assignment</h3>
        ${planSelector()}
        <div class="row">
          <div style="flex:1;min-width:160px">
            <label>Route</label>
            <select id="as-route">
              ${routes.length? routes.map(r=>`<option value="${keyOf(r)}">${r.planId} • ${r.section} — ${r.type} — (${r.stops.length} bins)</option>`).join('') : '<option disabled>No routes yet</option>'}
            </select>
          </div>
          <div style="flex:1;min-width:140px"><label>User</label><input id="as-user" placeholder="alice"/></div>
          <div style="align-self:end"><button class="btn ok" onclick="addAssign()"><span class="ico-inline" data-ic="tick"></span> Assign</button></div>
        </div>
        ${tableAssign(state.assignments.filter(a=>a.planId===pid), pid)}
      </div>
    </div>`;
  paintIcons(view);
}
function tableAssign(arr, pid){
  if(!arr.length) return empty('No assignments for this plan.');
  return `<table><thead><tr><th>User</th><th>Route</th><th>Bins</th><th>Actions</th></tr></thead>
    <tbody>${arr.map(a=>{
      const bins = binsOfRoute(pid, a.routeKey);
      const routeDisplay = a.routeKey.split('|').slice(1).join(' / ');
      return `<tr>
        <td data-label="User">${esc(a.user)}</td>
        <td data-label="Route">${esc(routeDisplay)}</td>
        <td data-label="Bins">${bins.map(b=>b.binId).join(', ')}</td>
        <td data-label="Actions"><button class="btn" onclick="editAssign('${a.routeKey.replace(/"/g,'&quot;')}','${(a.user||'').replace(/"/g,'&quot;')}')">Edit</button></td>
      </tr>`;
    }).join('')}</tbody></table>`;
}
function addAssign(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const rk = (document.getElementById('as-route')||{}).value;
  const user = (document.getElementById('as-user')||{}).value.trim();
  if(!rk || !user){ alert('Route & User required'); return; }
  const r = state.routes.find(x=>keyOf(x)===rk && x.planId===pid);
  if(!r){ alert('Selected route not found in current plan.'); return; }
  state.assignments.push({planId:pid, user, routeKey:rk}); persist(); render();
}
function editAssign(routeKey, oldUser){
  const pid = state.currentPlanId;
  const a = state.assignments.find(x=>x.planId===pid && x.routeKey===routeKey && x.user===oldUser);
  if(!a) return alert('Assignment not found');
  const nu = prompt('Edit user name', a.user||'');
  if(!nu) return;
  a.user = nu.trim();
  persist(); renderAssign();
}

// ===== EXECUTE =====
let camStream = null;
async function startCam(){
  try{
    stopCam();
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    const v = document.getElementById('cam'); if(v){ v.srcObject = camStream; }
  }catch(e){ alert('Camera not available: '+e.message); }
}
function stopCam(){
  if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream = null; }
  const v = document.getElementById('cam'); if(v){ v.srcObject = null; }
}
function mockScanSKU(){
  const sku = 'EAN-' + Math.floor(Math.random()*900000000000+100000000000);
  const el = document.getElementById('sc-sku'); if(el) el.value = sku;
}
function renderExecute(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const allBins = allBinsOfPlan(pid);
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="scan"></span> 3) Execution (Track / Scan)</h3>
        <div class="row">
          <div style="flex:1;min-width:200px">
            <label>Bin</label>
            <select id="exe-bin">${
              allBins.length? allBins.map(b=>{
                const frozen = state.freezes.some(f=>f.planId===pid && f.binId===b.binId);
                const [pid2]=b.routeKey.split('|');
                return `<option ${frozen?'disabled':''} value="${b.routeKey}::${b.binId}">${pid2} • ${b.section} • ${b.binId}${frozen?' (Frozen)':''}</option>`;
              }).join('') : '<option disabled>No bins</option>'
            }</select>
          </div>
          <div style="align-self:end"><button class="btn ok" onclick="openScanSheet()"><span class="ico-inline" data-ic="scan"></span> Scan & Count</button></div>
        </div>
        <div class="muted" id="binStat" style="margin: -4px 0 6px 0"></div>
        ${listScans(state.scans.filter(s=>s.planId===pid).slice(-12).reverse())}
      </div>
    </div>`;
  const sel = document.getElementById('exe-bin');
  function updateBinStat(){
    const v = sel && sel.value || '';
    const parts = v.split('::'); const binId = parts[1];
    if(!binId){ document.getElementById('binStat').innerHTML=''; return; }
    const b = allBinsOfPlan(pid).find(x=>x.binId===binId);
    const exp = (b && (b.expectedSkus!=null?b.expectedSkus:(b.expectedItems!=null?b.expectedItems:1)));
    const skuCnt = distinctSkuCountForBin(pid, binId);
    const qtySum = sumQtyForBin(pid, binId);
    document.getElementById('binStat').innerHTML = `Target SKUs ${exp} • Counted SKUs ${skuCnt} • Qty Sum ${qtySum} ${skuCnt>=exp? '• <b>Completed</b>':''}`;
  }
  if(sel){ sel.addEventListener('change', updateBinStat); updateBinStat(); }
  paintIcons(view);
}
function openScanSheet(){ populateScanBins(); toggleSheet('sheetScan',true); }
function populateScanBins(){
  const pid = state.currentPlanId;
  const sel = document.getElementById('sc-bin'); if(!sel) return;
  sel.innerHTML = allBinsOfPlan(pid).map(b=>{
    const frozen = state.freezes.some(f=>f.planId===pid && f.binId===b.binId);
    const [pid2]=b.routeKey.split('|');
    return `<option ${frozen?'disabled':''} value="${b.routeKey}::${b.binId}">${pid2} • ${b.section} • ${b.binId}${frozen?' (Frozen)':''}</option>`;
  }).join('');
}
function listScans(arr){
  if(!arr.length) return empty('No scans yet.');
  return `<div class="grid">
    ${arr.map(r=>`<div class="card" style="padding:8px">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div><b>${esc(r.sku)}</b><div class="muted" style="font-size:var(--fs-sm)">${esc(r.binId)}</div></div>
        <div style="text-align:right">
          <span class="pill">Qty ${r.qty}</span>
          <div class="muted" style="font-size:var(--fs-xs)">${fmtWhen(r.when)}</div>
        </div>
      </div>
      <div class="muted" style="margin-top:2px;font-size:var(--fs-sm)">${r.blind?'Blind':''} ${esc(r.note||'')}</div>
    </div>`).join('')}
  </div>`;
}
function submitScan(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const rkbin = document.getElementById('sc-bin').value;
  if(!rkbin){ alert('Select a bin'); return; }
  const [rk, binId] = rkbin.split('::');
  const exists = state.bins.some(b=>b.planId===pid && b.routeKey===rk && b.binId===binId);
  if(!exists){ alert('Bin must belong to current plan & selected route.'); return; }
  const isFrozen = state.freezes.some(f=>f.planId===pid && f.binId===binId);
  if(isFrozen){ alert('This bin is frozen. You cannot scan/count until it is unfrozen.'); return; }
  const sku = document.getElementById('sc-sku').value.trim();
  const qty = +document.getElementById('sc-qty').value||0;
  const blind = document.getElementById('sc-blind').value==='true';
  const note = document.getElementById('sc-note').value.trim();
  if(!sku || qty<=0){ alert('SKU and Qty>0 required'); return; }
  state.scans.push({planId:pid, routeKey:rk, binId, when:Date.now(), sku, qty, blind, note});
  persist(); toggleSheet('sheetScan',false); render();
}
function markDiscrepancy(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const rkbin = document.getElementById('sc-bin').value;
  const [rk, binId] = rkbin.split('::');
  const sku = document.getElementById('sc-sku').value.trim();
  const qty = +document.getElementById('sc-qty').value||0;
  const id = 'D-' + Math.floor(Math.random()*9000+1000);
  state.discrepancies.push({planId:pid, id, type:'QtyMismatch', binId, sku, expected:qty+2, counted:qty, status:'Open'});
  persist(); toggleSheet('sheetScan',false); render();
}

// ===== VALIDATE =====
function renderValidate(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const cfg = state.cfgByPlan[pid] || {blind:true,twoMatch:true,photo:true,maxVariance:5};
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="shield"></span> 4) Validation & Exception Handling</h3>
        ${planSelector()}
        <div class="row">
          <div style="flex:1;min-width:140px"><label>Blind Count (default)</label>
            <select id="cfg-blind"><option value="true"${cfg.blind?' selected':''}>On</option><option value="false"${!cfg.blind?' selected':''}>Off</option></select>
          </div>
          <div style="flex:1;min-width:140px"><label>Two-Match Principle</label>
            <select id="cfg-two"><option value="true"${cfg.twoMatch?' selected':''}>On</option><option value="false"${!cfg.twoMatch?' selected':''}>Off</option></select>
          </div>
          <div style="flex:1;min-width:140px"><label>Photo Evidence</label>
            <select id="cfg-photo"><option value="true"${cfg.photo?' selected':''}>Required</option><option value="false"${!cfg.photo?' selected':''}>Optional</option></select>
          </div>
          <div style="flex:1;min-width:140px"><label>Max Variance %</label>
            <input id="cfg-var" type="number" value="${cfg.maxVariance||5}"/>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn ok" onclick="saveCfg()"><span class="ico-inline" data-ic="tick"></span> Save</button>
        </div>
      </div>

      <div class="card">
        <h3><span class="ico-inline" data-ic="freeze"></span> Bin Controls (Freeze)</h3>
        <div class="row">
          <div style="flex:1;min-width:200px">
            <label>Bin</label>
            <select id="vc-bin"></select>
          </div>
          <div style="flex:1;min-width:220px">
            <label>Freeze Reason</label>
            <input id="vc-reason" placeholder="Cycle count in progress"/>
          </div>
        </div>
        <div class="row">
          <button class="btn warn" onclick="vcFreeze()"><span class="ico-inline" data-ic="freeze"></span> Freeze</button>
          <button class="btn ok" onclick="vcUnfreeze()"><span class="ico-inline" data-ic="flame"></span> Unfreeze</button>
        </div>
      </div>
    </div>`;
  const vcSel = document.getElementById('vc-bin');
  if(vcSel){
    const bins = allBinsOfPlan(pid);
    vcSel.innerHTML = bins.map(b=>{
      const frozen = state.freezes.some(f=>f.planId===pid && f.binId===b.binId);
      const [pid2]=b.routeKey.split("|");
      return `<option value="${b.binId}">${pid2} • ${b.section} • ${b.binId}${frozen?' (Frozen)':''}</option>`;
    }).join('');
  }
  paintIcons(view); refreshActivePlanBadge();
}
function vcFreeze(){
  const pid = state.currentPlanId;
  const binId = (document.getElementById('vc-bin')||{}).value;
  const reason = (document.getElementById('vc-reason')||{}).value||'Frozen';
  if(!binId) return alert('Select a bin');
  if(state.freezes.some(f=>f.planId===pid && f.binId===binId)) return alert('Already frozen');
  state.freezes.push({planId:pid, binId, reason, when:Date.now()}); persist(); renderValidate();
}
function vcUnfreeze(){
  const pid = state.currentPlanId;
  const binId = (document.getElementById('vc-bin')||{}).value;
  if(!binId) return alert('Select a bin');
  state.freezes = state.freezes.filter(f=>!(f.planId===pid && f.binId===binId)); persist(); renderValidate();
}
function saveCfg(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  state.cfgByPlan[pid] = {
    blind: document.getElementById('cfg-blind').value==='true',
    twoMatch: document.getElementById('cfg-two').value==='true',
    photo: document.getElementById('cfg-photo').value==='true',
    maxVariance: +document.getElementById('cfg-var').value||5
  };
  persist(); alert('Validation rules saved for this plan.');
}

// ===== REPORTS =====
function kpiData(pid){
  const routes = state.routes.filter(r=>r.planId===pid);
  const bins = state.bins.filter(b=>b.planId===pid);
  const scans = state.scans.filter(s=>s.planId===pid);
  const frozen = state.freezes.filter(f=>f.planId===pid).length;

  const binsDone = bins.filter(b=>{
    const exp = (b.expectedSkus!=null?b.expectedSkus:(b.expectedItems!=null?b.expectedItems:1));
    const skuCnt = distinctSkuCountForBin(pid, b.binId);
    return exp>0 ? skuCnt>=exp : skuCnt>0;
  }).length;
  const progressPct = bins.length ? Math.round(binsDone*100/bins.length) : 0;

  const routeKeySet = new Set(routes.map(r=>keyOf(r)));
  const routesCounted = new Set(scans.map(s=>s.routeKey).filter(rk=>routeKeySet.has(rk))).size;

  const scanEntries = scans.length;
  const byUser = {};
  const assignments = state.assignments.filter(a=>a.planId===pid);
  for(const a of assignments){
    const u = a.user;
    if(!byUser[u]) byUser[u] = {assignedRoutes:0, countedRoutes:0, bins:0, binsDone:0};
    byUser[u].assignedRoutes += 1;
    const rBins = state.bins.filter(b=>b.planId===pid && b.routeKey===a.routeKey);
    byUser[u].bins += rBins.length;
    const anyScanOnRoute = scans.some(s=>s.routeKey===a.routeKey);
    if(anyScanOnRoute) byUser[u].countedRoutes += 1;
    const doneOnRoute = new Set(scans.filter(s=>s.routeKey===a.routeKey).map(s=>s.binId)).size;
    byUser[u].binsDone += doneOnRoute;
  }
  const discOpen = state.discrepancies.filter(d=>d.planId===pid && d.status!=='Closed').length;

  return {plannedBins:bins.length, binsDone, progressPct, scanEntries, openExceptions:discOpen, frozenBins:frozen, routesTotal:routes.length, routesCounted, byUser};
}
function barRow(name, val, max){
  const pct = max? Math.min(100, Math.round(val*100/max)):0;
  return `<div class="bar">
    <div style="min-width:120px">${esc(name)}</div>
    <div class="track"><i style="width:${pct}%"></i></div>
    <div style="min-width:70px;text-align:right">${val}/${max}</div>
  </div>`;
}
function renderReports(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const d = kpiData(pid);
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3><span class="ico-inline" data-ic="report"></span> 5) Dashboard (Real‑time)</h3>
          <div>
            <button class="btn bad" onclick="clearAllData()"><span class="ico-inline" data-ic="alert"></span> Clear All Data</button>
            <button class="btn primary" onclick="exportCSV()"><span class="ico-inline" data-ic="arrow"></span> Export CSV</button>
          </div>
        </div>
        ${planSelector()}
        <div class="kpis" style="margin-top:8px">
          <div class="kpi"><div class="lbl">Progress</div><div class="val">${d.progressPct}%</div><div class="progress"><i style="width:${d.progressPct}%"></i></div></div>
          <div class="kpi"><div class="lbl">Planned Bins</div><div class="val">${d.plannedBins}</div></div>
          <div class="kpi"><div class="lbl">Completed Bins</div><div class="val">${d.binsDone}</div></div>
          <div class="kpi"><div class="lbl">Count Entries</div><div class="val">${d.scanEntries}</div></div>
          <div class="kpi"><div class="lbl">Routes Counted</div><div class="val">${d.routesCounted}/${d.routesTotal}</div></div>
          <div class="kpi"><div class="lbl">Open Exceptions</div><div class="val">${d.openExceptions}</div></div>
          <div class="kpi"><div class="lbl">Frozen Bins</div><div class="val">${d.frozenBins}</div></div>
        </div>
      </div>
      <div class="card">
        <h3>Route vs Counted by User</h3>
        <div class="bars">${
          Object.keys(d.byUser).length
            ? Object.entries(d.byUser).map(([u,v])=>barRow(u+' (routes)', v.countedRoutes, v.assignedRoutes)).join('')
            : '<div class="muted">No assignments yet.</div>'
        }</div>
      </div>
      <div class="card">
        <h3>Bin Completion by User</h3>
        <div class="bars">${
          Object.keys(d.byUser).length
            ? Object.entries(d.byUser).map(([u,v])=>barRow(u+' (bins)', v.binsDone, v.bins)).join('')
            : '<div class="muted">No assignments yet.</div>'
        }</div>
      </div>
    </div>`;
  paintIcons(view); refreshActivePlanBadge();
}
setInterval(()=>{ if((location.hash||'#reports')==='#reports'){ if(stateReady) renderReports(); } }, 2000);

// ===== EXPORTS / CLEAR =====
function exportCSV(){
  const pid = state.currentPlanId;
  const rows = [['planId','routeKey','binId','when','sku','qty','blind','note']]
    .concat(state.scans.filter(s=>s.planId===pid).map(s=>[s.planId,s.routeKey,s.binId,new Date(s.when).toISOString(), s.sku, s.qty, s.blind, (s.note||'')]));
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `physical_count_scans_${pid}.csv`; a.click();
  URL.revokeObjectURL(url);
}
function clearAllData(){
  if(!confirm('Clear all data for Physical Count? This cannot be undone.')) return;
  const keepUser = localStorage.getItem('pc_user');
  Object.keys(localStorage).filter(k=>k.startsWith('pc_')).forEach(k=>localStorage.removeItem(k));
  if(keepUser) localStorage.setItem('pc_user', keepUser);
  state.plans = []; state.routes = []; state.bins = []; state.assignments = [];
  state.scans = []; state.discrepancies = []; state.freezes = []; state.cfgByPlan = {};
  state.currentPlanId = null; persist();
  location.hash = '#plan'; render(); refreshActivePlanBadge();
}

// ===== SHARED =====
function toggleSheet(id, on){ const el=document.getElementById(id); if(el) el.style.display = on?'flex':'none'; }
function empty(text){
  return `<div class="card" style="text-align:center;padding:12px">
    <div class="ico-inline" data-ic="boxes" style="margin:0 auto 4px auto"></div>
    <div class="muted">${esc(text)}</div>
  </div>`;
}
function esc(s){return (s??'').toString().replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
function fmtWhen(t){const d=new Date(t||Date.now()); return d.toLocaleString();}

// ===== BOOT =====
function paintIcons(scope=document){ scope.querySelectorAll('[data-ic]').forEach(el=>{ el.innerHTML = ICONS[el.getAttribute('data-ic')]||''; }); }
paintIcons(document);
(function boot(){
  if(!currentUser){ renderLogin(); } else { showMain(); }
})();
</script>
</body>
</html>
