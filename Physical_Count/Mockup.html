<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Physical Count — V7 (Linked Plan→Route→Bin→Assign)</title>
<style>
  :root{
    --bg:#f6f8fb; --panel:#ffffff; --muted:#637082; --text:#0b1220;
    --brand:#2563eb; --line:#e4e8ef; --shadow:0 2px 8px rgba(15,23,42,.08);
    --radius:12px; --inset: env(safe-area-inset-bottom, 0);
    --fs-xs: clamp(11px, 1.4vw, 12px);
    --fs-sm: clamp(12px, 1.6vw, 13px);
    --fs-md: clamp(13px, 1.9vw, 15px);
    --fs-lg: clamp(15px, 2.3vw, 17px);
    --icon: 16px; --icon-inline: 14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:var(--fs-md)/1.5 Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  header{position:sticky;top:0;z-index:30;display:flex;align-items:center;gap:8px;padding:8px 12px;background:#fff;border-bottom:1px solid var(--line);box-shadow:var(--shadow)}
  .brand{width:14px;height:14px;border-radius:4px;background:var(--brand)}
  h1{margin:0;font-size:var(--fs-lg)}
  .sub{color:var(--muted);font-size:var(--fs-xs)}
  .container{max-width:1100px;margin:0 auto;padding:10px}
  .grid{display:grid;gap:10px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:10px;box-shadow:var(--shadow)}
  .card h3{margin:0 0 6px 0;font-size:var(--fs-lg);display:flex;align-items:center;gap:6px}
  .muted{color:var(--muted)}
  /* Inputs */
  input,select,textarea,button{font-size:var(--fs-md)}
  input,select,textarea{width:100%;background:#fff;border:1px solid #dbe3ea;color:var(--text);padding:8px 10px;border-radius:10px;outline:none;min-height:36px}
  input:focus,select:focus,textarea:focus{border-color:#93c5fd;box-shadow:0 0 0 2px rgba(147,197,253,.25)}
  label{font-size:var(--fs-sm);color:#334155;display:block;margin-bottom:4px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;background:#fff;border:1px solid #cbd5e1;color:#0f172a;padding:8px 12px;border-radius:10px;cursor:pointer;min-height:36px}
  .btn.primary{border-color:var(--brand);background:#eff6ff;color:#1d4ed8}
  .btn.ok{border-color:#86efac;color:#14532d;background:#ecfdf5}
  .btn.warn{border-color:#facc15;color:#713f12;background:#fffbeb}
  .btn.bad{border-color:#fecaca;color:#7f1d1d;background:#fef2f2}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;color:#334155;font-size:var(--fs-sm)}
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  th,td{text-align:left;padding:8px 10px}
  thead th{font-size:var(--fs-sm);color:#475569}
  tbody tr{background:#fff;border:1px solid #e5e7eb}
  tbody tr td:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
  tbody tr td:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}
  @media (max-width:760px){
    table thead{display:none}
    table tbody tr{display:grid;grid-template-columns:1fr 1fr;gap:6px;padding:6px}
    table tbody td{padding:6px 6px}
    table tbody td::before{content:attr(data-label);display:block;color:#64748b;font-size:var(--fs-xs);margin-bottom:2px}
  }
  /* Bottom tabs */
  .tabs{position:fixed;left:0;right:0;bottom:0;z-index:40;background:#fff;border-top:1px solid var(--line);
    padding:4px calc(8px + var(--inset)); display:flex;gap:4px;justify-content:space-around}
  .tab-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;border:0;background:transparent;color:#334155;
    padding:6px;border-radius:10px;min-height:50px}
  .tab-btn .ico{width:var(--icon);height:var(--icon);color:#2563eb}
  .tab-btn.active{background:#eff6ff;color:#1d4ed8;border:1px solid #dbeafe}
  .tab-btn.active .ico{color:#1d4ed8}
  .tab-btn span{font-size:var(--fs-xs)}
  .spacer{height:72px}
  /* Modals */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;align-items:flex-end;justify-content:center;z-index:50}
  .dialog{background:#fff;border-top-left-radius:14px;border-top-right-radius:14px;width:100%;max-width:680px;box-shadow:0 -10px 24px rgba(2,6,23,.16)}
  .sheet{padding:12px 12px calc(12px + var(--inset)) 12px;border-top:1px solid var(--line)}
  .close{position:absolute;right:10px;top:8px;background:#fff;border:1px solid #cbd5e1;color:#334155;border-radius:8px;padding:4px 8px;cursor:pointer}
  /* Icons */
  svg{display:block}
  .ico svg{width:100%;height:100%}
  .ico-inline{width:var(--icon-inline);height:var(--icon-inline);color:#2563eb}
</style>
</head>
<body>
<header>
  <div class="brand" aria-hidden="true"></div>
  <div>
    <h1>Physical Count</h1>
    <div class="sub">V7.1 — All entities are linked • <span id="activePlanBadge" class="pill">Plan: <b>—</b></span></div>
  </div>
</header>

<div class="container" id="view"></div>
<div class="spacer"></div>

<div class="tabs">
  <button class="tab-btn active" data-view="plan"><div class="ico" data-ic="plan"></div><span>Plan</span></button>
  <button class="tab-btn" data-view="assign"><div class="ico" data-ic="users"></div><span>Assign</span></button>
  <button class="tab-btn" data-view="execute"><div class="ico" data-ic="scan"></div><span>Execute</span></button>
  <button class="tab-btn" data-view="validate"><div class="ico" data-ic="shield"></div><span>Validate</span></button>
  <button class="tab-btn" data-view="reports"><div class="ico" data-ic="report"></div><span>Reports</span></button>
</div>

<!-- Scan Sheet -->
<div class="modal" id="sheetScan">
  <div class="dialog">
    <div class="sheet">
      <button class="close" onclick="toggleSheet('sheetScan',false)">✕</button>
      <h3><span class="ico-inline" data-ic="scan"></span> Scan & Count</h3>
      <div class="row">
        <div class="card" style="flex:1;min-width:220px">
          <label>Route Stop / Bin (from current Plan)</label>
          <select id="sc-bin"></select>
        </div>
        <div class="card" style="flex:1;min-width:220px"><label>SKU / EAN / Serial</label><input id="sc-sku" placeholder="8850123456789"/></div>
      </div>
      <div class="row">
        <div class="card" style="flex:1;min-width:120px"><label>Qty</label><input id="sc-qty" type="number" value="1"/></div>
        <div class="card" style="flex:1;min-width:120px"><label>Blind</label><select id="sc-blind"><option value="true">On</option><option value="false">Off</option></select></div>
      </div>
      <div class="row"><div class="card" style="flex:1"><label>Notes</label><input id="sc-note" placeholder="Optional note"/></div></div>
      <div class="row">
        <button class="btn ok" onclick="submitScan()"><span class="ico-inline" data-ic="tick"></span> Submit</button>
        <button class="btn" onclick="markDiscrepancy()"><span class="ico-inline" data-ic="alert"></span> Mark Discrepancy</button>
      </div>
    </div>
  </div>
</div>

<!-- Freeze Sheet -->
<div class="modal" id="sheetFreeze">
  <div class="dialog">
    <div class="sheet">
      <button class="close" onclick="toggleSheet('sheetFreeze',false)">✕</button>
      <h3><span class="ico-inline" data-ic="freeze"></span> Freeze / Unfreeze Bin</h3>
      <div class="row">
        <div class="card" style="flex:1;min-width:200px">
          <label>Bin (from current Plan)</label>
          <select id="fz-bin"></select>
        </div>
        <div class="card" style="flex:1;min-width:200px"><label>Reason</label><input id="fz-reason" placeholder="Cycle count in progress"/></div>
      </div>
      <div class="row">
        <button class="btn warn" onclick="freezeBin()"><span class="ico-inline" data-ic="freeze"></span> Freeze</button>
        <button class="btn ok" onclick="unfreezeBin()"><span class="ico-inline" data-ic="flame"></span> Unfreeze</button>
      </div>
    </div>
  </div>
</div>

<script>
// Icons
const ICONS = {
  plan:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <rect x="3" y="4" width="18" height="16" rx="2"/><path d="M7 4v16M3 8h18"/></svg>`,
  users:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="8" cy="8" r="3"/><circle cx="16" cy="11" r="3"/><path d="M2 21a6 6 0 0 1 12 0"/><path d="M10 21a6 6 0 0 1 12 0"/></svg>`,
  scan:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M4 7V5a1 1 0 0 1 1-1h2M18 4h1a1 1 0 0 1 1 1v2M20 17v2a1 1 0 0 1-1 1h-2M6 20H5a1 1 0 0 1-1-1v-2"/>
    <rect x="8" y="8" width="8" height="8" rx="2"/></svg>`,
  shield:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M12 2l7 4v6c0 5-3.5 9-7 10-3.5-1-7-5-7-10V6l7-4z"/></svg>`,
  report:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M4 4h10l6 6v10a2 2 0 0 1-2 2H4z"/><path d="M14 4v6h6"/><path d="M8 16v4M12 14v6M16 12v8"/></svg>`,
  tick:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>`,
  alert:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M12 9v4"/><path d="M12 17h.01"/><path d="M10.3 3.2 1.7 18a2 2 0 0 0 1.7 3h17a2 2 0 0 0 1.7-3L13.7 3.2a2 2 0 0 0-3.4 0z"/></svg>`,
  freeze:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M4 12h16M6 6l12 12M18 6L6 18"/></svg>`,
  flame:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3s4 3 4 7-2 5-4 5-4-1-4-5 4-7 4-7z"/></svg>`,
  boxes:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M3 7l9-4 9 4-9 4-9-4z"/><path d="M3 17l9 4 9-4"/><path d="M3 12l9 4 9-4"/></svg>`,
  map:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l-6 3V6l6-3 6 3 6-3v15l-6 3-6-3z"/><path d="M9 3v15M15 6v15"/></svg>`,
  arrow:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg>`
};
function paintIcons(scope=document){ scope.querySelectorAll('[data-ic]').forEach(el=>{ el.innerHTML = ICONS[el.getAttribute('data-ic')]||''; }); }

// State (all entities carry parent keys)
const state = {
  plans: JSON.parse(localStorage.getItem('pc_plans')||'[]'),          // [{id, site, asof, repeat, scope, sections[]}]
  routes: JSON.parse(localStorage.getItem('pc_routes')||'[]'),        // [{planId, section, type, stops[] }]
  bins: JSON.parse(localStorage.getItem('pc_bins')||'[]'),            // [{planId, routeKey, binId, section}]
  assignments: JSON.parse(localStorage.getItem('pc_assignments')||'[]'), // [{planId, user, routeKey, bins[]?}]
  scans: JSON.parse(localStorage.getItem('pc_scans')||'[]'),          // [{planId, routeKey, binId, sku, qty, ...}]
  discrepancies: JSON.parse(localStorage.getItem('pc_disc')||'[]'),   // [{planId, id, ...}]
  freezes: JSON.parse(localStorage.getItem('pc_freezes')||'[]'),      // [{planId, binId, ...}]
  cfg: JSON.parse(localStorage.getItem('pc_cfg')||'null'),            // {planId, ... rules}
  currentPlanId: localStorage.getItem('pc_currentPlanId') || null
};
function persist(){
  localStorage.setItem('pc_plans', JSON.stringify(state.plans));
  localStorage.setItem('pc_routes', JSON.stringify(state.routes));
  localStorage.setItem('pc_bins', JSON.stringify(state.bins));
  localStorage.setItem('pc_assignments', JSON.stringify(state.assignments));
  localStorage.setItem('pc_scans', JSON.stringify(state.scans));
  localStorage.setItem('pc_disc', JSON.stringify(state.discrepancies));
  localStorage.setItem('pc_freezes', JSON.stringify(state.freezes));
  localStorage.setItem('pc_cfg', JSON.stringify(state.cfg));
  if(state.currentPlanId) localStorage.setItem('pc_currentPlanId', state.currentPlanId);
}
(function seed(){
  const fresh = !state.plans.length && !state.routes.length && !state.bins.length && !state.assignments.length && !state.scans.length && !state.discrepancies.length && !state.freezes.length && !state.cfg;
  if(!fresh) return;
  const pid = 'S-2025-09-001';
  state.plans = [{
    id:pid, site:'BKK01', asof:'2025-09-01', repeat:'Quarterly',
    scope:{category:'Beverage', brand:'Cola', vendor:'VND001'},
    sections:[{section:'A01', bins:40},{section:'A02', bins:32},{section:'Backroom-FRZ', bins:12}]
  }];
  state.currentPlanId = pid;
  // routes
  const r1 = {planId:pid, section:'A01', type:'system', stops:['A01-01','A01-02','A01-03','A01-04']};
  const r2 = {planId:pid, section:'A02', type:'system', stops:['A02-01','A02-02','A02-03']};
  state.routes = [r1,r2];
  // bins derived from routes
  state.bins = [...r1.stops.map(b=>({planId:pid, routeKey:keyOf(r1), binId:b, section:r1.section})),
                ...r2.stops.map(b=>({planId:pid, routeKey:keyOf(r2), binId:b, section:r2.section}))];
  // assignments (must use planId+routeKey)
  state.assignments = [
    {planId:pid, user:'alice', routeKey:keyOf(r1)},
    {planId:pid, user:'bob', routeKey:keyOf(r2)},
  ];
  // others
  const now = Date.now();
  state.scans = [
    {planId:pid, routeKey:keyOf(r1), binId:'A01-01', when:now-7200e3, sku:'EAN-885000000001', qty:6, blind:true, note:'promo'},
    {planId:pid, routeKey:keyOf(r1), binId:'A01-02', when:now-3600e3, sku:'SKU-2002', qty:2, blind:false, note:''},
  ];
  state.freezes = [{planId:pid, binId:'A01-02', reason:'Cycle count', when:now-3000e3}];
  state.discrepancies = [{planId:pid, id:'D-1001', type:'QtyMismatch', binId:'A01-01', sku:'EAN-885000000001', expected:10, counted:6, status:'Open'}];
  state.cfg = {planId:pid, blind:true, twoMatch:true, photo:true, maxVariance:5};
  persist();
})();

// Helpers
function keyOf(r){ return `${r.planId}|${r.section}|${r.type}`; }
function currentPlan(){ return state.plans.find(p=>p.id===state.currentPlanId) || null; }
function ensurePlan(){ if(!state.currentPlanId || !currentPlan()){ alert('Create or select an Action Plan first.'); return false; } return true; }
function routesOfPlan(pid){ return state.routes.filter(r=>r.planId===pid); }
function binsOfRoute(pid, routeKey){ return state.bins.filter(b=>b.planId===pid && b.routeKey===routeKey); }
function allBinsOfPlan(pid){ return state.bins.filter(b=>b.planId===pid); }

// Router
const view = document.getElementById('view');
document.querySelectorAll('.tab-btn').forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    location.hash = b.dataset.view;
    render();
  };
});
window.addEventListener('hashchange', render);
function render(){
  const route = (location.hash||'#plan').replace('#','');
  switch(route){
    case 'plan': return renderPlan();
    case 'assign': return renderAssign();
    case 'execute': return renderExecute();
    case 'validate': return renderValidate();
    case 'reports': return renderReports();
    default: return renderPlan();
  }
}
render(); paintIcons(document);

function refreshActivePlanBadge(){
  const badge = document.getElementById('activePlanBadge');
  if(!badge) return;
  const p = currentPlan();
  badge.innerHTML = 'Plan: <b>' + (p? esc(p.id) : '—') + '</b>';
}

refreshActivePlanBadge();

// UI Parts
function planSelector(){
  return `<div class="row" style="align-items:end">
    <div style="flex:1;min-width:200px">
      <label>Active Plan</label>
      <select id="sel-plan" onchange="selectPlan(this.value)">
        ${state.plans.map(p=>`<option value="${p.id}" ${p.id===state.currentPlanId?'selected':''}>${p.id} — ${p.site} (${p.asof})</option>`).join('')}
      </select>
    </div>
  </div>`;
}
function selectPlan(pid){ state.currentPlanId = pid; persist(); render(); refreshActivePlanBadge(); }

// Views
function renderPlan(){
  const p = currentPlan();
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="plan"></span> 1) Action Plan</h3>
        ${planSelector()}
        <div class="row">
          <div style="flex:1;min-width:150px"><label>Plan ID</label><input id="pl-id" value="${p?esc(p.id):''}" placeholder="e.g., S-2025-10-001"/></div>
          <div style="flex:1;min-width:150px"><label>Site</label><input id="pl-site" value="${p?esc(p.site):''}" placeholder="BKK01"/></div>
          <div style="flex:1;min-width:150px"><label>As-of</label><input id="pl-asof" value="${p?esc(p.asof):''}" placeholder="YYYY-MM-DD"/></div>
          <div style="flex:1;min-width:150px"><label>Repeat</label><input id="pl-repeat" value="${p?esc(p.repeat||'One-time'):''}"/></div>
        </div>
        <div class="row">
          <div style="flex:1;min-width:150px"><label>Category</label><input id="pl-cat" value="${p?esc(p.scope.category):''}"/></div>
          <div style="flex:1;min-width:150px"><label>Brand</label><input id="pl-brand" value="${p?esc(p.scope.brand):''}"/></div>
          <div style="flex:1;min-width:150px"><label>Vendor</label><input id="pl-vendor" value="${p?esc(p.scope.vendor):''}"/></div>
        </div>
        <div class="row">
          <button class="btn primary" onclick="savePlan()"><span class="ico-inline" data-ic="tick"></span> Save / Set Active</button>
          <button class="btn" onclick="insertMockPlan()"><span class="ico-inline" data-ic="arrow"></span> Insert Mock Plan</button>
        </div>
      </div>

      <div class="card">
        <h3><span class="ico-inline" data-ic="map"></span> 1.1) System‑Guided Route Planning (sub of Plan)</h3>
        <div class="row">
          <div style="flex:1;min-width:150px"><label>Section</label><input id="sg-section" placeholder="A01"/></div>
          <div style="flex:1;min-width:150px"><label>Stops per Route</label><input id="sg-stops" type="number" value="4"/></div>
          <div style="align-self:end"><button class="btn primary" onclick="systemGuidedRoute()"><span class="ico-inline" data-ic="arrow"></span> Generate</button></div>
        </div>
        ${renderRoutesTable()}
      </div>

      <div class="card">
        <h3><span class="ico-inline" data-ic="map"></span> 1.2) Manual Route Planning (sub of Plan)</h3>
        <div class="row">
          <div style="flex:1;min-width:140px"><label>Section</label><input id="mr-section" placeholder="A02"/></div>
          <div style="flex:2;min-width:200px"><label>Stops (comma) — becomes Bins</label><input id="mr-stops" placeholder="A02-01,A02-02,A02-03"/></div>
          <div style="align-self:end"><button class="btn ok" onclick="manualRouteCreate()"><span class="ico-inline" data-ic="tick"></span> Add Manual Route</button></div>
        </div>
        <div class="muted">All bins are derived from route stops; bins are children of both the route and the plan.</div>
      </div>
    </div>`;
  paintIcons(view);
}
function renderRoutesTable(){
  if(!ensurePlan()) return '';
  const list = routesOfPlan(state.currentPlanId);
  if(!list.length) return empty('No routes for this plan.');
  return `<table><thead><tr><th>Plan</th><th>Section</th><th>Type</th><th>Stops / Bins</th><th></th></tr></thead>
    <tbody>${list.map((r,i)=>`<tr>
      <td data-label="Plan">${esc(r.planId)}</td><td data-label="Section">${esc(r.section)}</td>
      <td data-label="Type"><span class="pill">${r.type}</span></td>
      <td data-label="Stops">${esc(r.stops.join(', '))}</td>
      <td data-label=""><button class="btn bad" onclick="delRoute(${i})"><span class="ico-inline" data-ic="alert"></span> Delete</button></td>
    </tr>`).join('')}</tbody></table>`;
}

// Assign
function renderAssign(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const routes = routesOfPlan(pid);
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="users"></span> 2) Allocation Assignment (must follow Plan → Route)</h3>
        ${planSelector()}
        <div class="row">
          <div style="flex:1;min-width:160px">
            <label>Route</label>
            <select id="as-route">
              ${routes.map(r=>`<option value="${keyOf(r)}">${r.planId} • ${r.section} — ${r.type} — (${r.stops.length} bins)</option>`).join('') || '<option disabled>No routes yet</option>'}
            </select>
          </div>
          <div style="flex:1;min-width:140px"><label>User</label><input id="as-user" placeholder="alice"/></div>
          <div style="align-self:end"><button class="btn ok" onclick="addAssign()"><span class="ico-inline" data-ic="tick"></span> Assign</button></div>
        </div>
        ${tableAssign(state.assignments.filter(a=>a.planId===pid), pid)}
      </div>
    </div>`;
  paintIcons(view);
}
function tableAssign(arr, pid){
  if(!arr.length) return empty('No assignments for this plan.');
  return `<table><thead><tr><th>User</th><th>Route</th><th>Bins</th></tr></thead>
    <tbody>${arr.map(a=>{
      const bins = binsOfRoute(pid, a.routeKey);
      return `<tr>
        <td data-label="User">${esc(a.user)}</td>
        <td data-label="Route">${esc(a.routeKey.split('|').slice(1).join(' / '))}</td>
        <td data-label="Bins">${bins.map(b=>b.binId).join(', ')}</td>
      </tr>`;
    }).join('')}</tbody></table>`;
}

// Execute
function renderExecute(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const allBins = allBinsOfPlan(pid);
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="scan"></span> 3) Execution (Track / Freeze) — linked to Plan & Route</h3>
        <div class="row">
          <div style="flex:1;min-width:200px">
            <label>Bin</label>
            <select id="exe-bin">${allBins.map(b=>{const [pid,sec,type]=b.routeKey.split("|");return `<option value="${b.routeKey}::${b.binId}">${pid} • ${b.section} • ${b.binId}</option>`}).join('') || '<option disabled>No bins</option>'}</select>
          </div>
          <div style="align-self:end"><button class="btn ok" onclick="toggleSheet('sheetScan',true);populateScanBins()"><span class="ico-inline" data-ic="scan"></span> Scan & Count</button></div>
          <div style="align-self:end"><button class="btn warn" onclick="toggleSheet('sheetFreeze',true);populateFreezeBins()"><span class="ico-inline" data-ic="freeze"></span> Freeze Bin</button></div>
        </div>
        ${listScans(state.scans.filter(s=>s.planId===pid).slice(-12).reverse())}
      </div>
      <div class="card">
        <h3><span class="ico-inline" data-ic="freeze"></span> Frozen Bins</h3>
        <div class="grid">${state.freezes.filter(f=>f.planId===pid).length? state.freezes.filter(f=>f.planId===pid).map(f=>`<div class="card" style="display:flex;justify-content:space-between;align-items:center">
          <div><b>${esc(f.binId)}</b> — ${esc(f.reason||'Frozen')}</div>
          <button class="btn ok" onclick="unfreezeDirect('${f.binId}')"><span class="ico-inline" data-ic="flame"></span> Unfreeze</button>
        </div>`).join('') : '<div class="muted">No frozen bins.</div>'}</div>
      </div>
    </div>`;
  paintIcons(view);
}
function populateScanBins(){
  const pid = state.currentPlanId;
  const sel = document.getElementById('sc-bin'); if(!sel) return;
  sel.innerHTML = allBinsOfPlan(pid).map(b=>{const [pid2]=b.routeKey.split("|");return `<option value="${b.routeKey}::${b.binId}">${pid2} • ${b.section} • ${b.binId}</option>`}).join('');
}
function populateFreezeBins(){
  const pid = state.currentPlanId;
  const sel = document.getElementById('fz-bin'); if(!sel) return;
  sel.innerHTML = allBinsOfPlan(pid).map(b=>{const [pid2]=b.routeKey.split("|");return `<option value="${b.binId}">${pid2} • ${b.section} • ${b.binId}</option>`}).join('');
}
function listScans(arr){
  if(!arr.length) return empty('No scans yet.');
  return `<div class="grid">
    ${arr.map(r=>`<div class="card" style="padding:8px">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div><b>${esc(r.sku)}</b><div class="muted" style="font-size:var(--fs-sm)">${esc(r.binId)}</div></div>
        <div style="text-align:right">
          <span class="pill">Qty ${r.qty}</span>
          <div class="muted" style="font-size:var(--fs-xs)">${fmtWhen(r.when)}</div>
        </div>
      </div>
      <div class="muted" style="margin-top:2px;font-size:var(--fs-sm)">${r.blind?'Blind':''} ${esc(r.note||'')}</div>
    </div>`).join('')}
  </div>`;
}

// Validate
function renderValidate(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const cfg = state.cfg && state.cfg.planId===pid ? state.cfg : {planId:pid, blind:true,twoMatch:true,photo:true,maxVariance:5};
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="shield"></span> 4) Validation & Exception Handling (Plan‑scoped)</h3>
        ${planSelector()}
        <div class="row">
          <div style="flex:1;min-width:140px"><label>Blind Count</label>
            <select id="cfg-blind"><option value="true"${cfg.blind?' selected':''}>On</option><option value="false"${!cfg.blind?' selected':''}>Off</option></select>
          </div>
          <div style="flex:1;min-width:140px"><label>Two-Match Principle</label>
            <select id="cfg-two"><option value="true"${cfg.twoMatch?' selected':''}>On</option><option value="false"${!cfg.twoMatch?' selected':''}>Off</option></select>
          </div>
          <div style="flex:1;min-width:140px"><label>Photo Evidence</label>
            <select id="cfg-photo"><option value="true"${cfg.photo?' selected':''}>Required</option><option value="false"${!cfg.photo?' selected':''}>Optional</option></select>
          </div>
          <div style="flex:1;min-width:140px"><label>Max Variance %</label>
            <input id="cfg-var" type="number" value="${cfg.maxVariance||5}"/>
          </div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn ok" onclick="saveCfg()"><span class="ico-inline" data-ic="tick"></span> Save</button>
          <button class="btn" onclick="insertMockException()"><span class="ico-inline" data-ic="alert"></span> Insert Mock Exception</button>
        </div>
      </div>
      <div class="card">
        <h3><span class="ico-inline" data-ic="alert"></span> Exception Queue</h3>
        ${listQueue(state.discrepancies.filter(d=>d.planId===pid))}
      </div>
    </div>`;
  paintIcons(view);
}
function listQueue(arr){
  if(!arr.length) return empty('No discrepancies. Great job!');
  return `<div class="grid">
    ${arr.map(d=>`<div class="card" style="padding:8px;display:grid;gap:6px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;align-items:center;gap:6px">
          <span class="ico-inline" data-ic="alert"></span>
          <div><b>${esc(d.id)}</b> — ${esc(d.type||'Exception')} — ${esc(d.sku||'')}</div>
        </div>
        <span class="pill">${d.status}</span>
      </div>
      <div class="muted">Bin ${esc(d.binId||'-')}</div>
      <div>${d.expected!=null?`Expected <b>${d.expected}</b> • Counted <b>${d.counted}</b>`:''}</div>
      <div class="row">
        <button class="btn ok" onclick="closeDisc('${d.id}')"><span class="ico-inline" data-ic="tick"></span> Approve & Close</button>
      </div>
    </div>`).join('')}
  </div>`;
}

// Reports
function renderReports(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const plannedBins = allBinsOfPlan(pid).length;
  const counted = state.scans.filter(s=>s.planId===pid).length;
  const open = state.discrepancies.filter(d=>d.planId===pid && d.status!=='Closed').length;
  const frozen = state.freezes.filter(f=>f.planId===pid).length;
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ico-inline" data-ic="report"></span> 5) Reports (Plan‑scoped)</h3>
        ${planSelector()}
        <div class="row">
          <div class="pill">Planned Bins: <b>${plannedBins}</b></div>
          <div class="pill">Counted Entries: <b>${counted}</b></div>
          <div class="pill">Open Exceptions: <b>${open}</b></div>
          <div class="pill">Frozen Bins: <b>${frozen}</b></div>
        </div>
        <div class="row"><button class="btn primary" onclick="exportCSV()"><span class="ico-inline" data-ic="arrow"></span> Export CSV</button></div>
      </div>
    </div>`;
  paintIcons(view);
}
function exportCSV(){
  const pid = state.currentPlanId;
  const rows = [['planId','routeKey','binId','when','sku','qty','blind','note']]
    .concat(state.scans.filter(s=>s.planId===pid).map(s=>[s.planId,s.routeKey,s.binId,new Date(s.when).toISOString(), s.sku, s.qty, s.blind, (s.note||'')]));
  const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `physical_count_scans_${pid}.csv`; a.click();
  URL.revokeObjectURL(url);
}

// Actions (respect links)
function savePlan(){
  const id = document.getElementById('pl-id').value.trim();
  if(!id){ alert('Plan ID required'); return; }
  const site = document.getElementById('pl-site').value.trim();
  const asof = document.getElementById('pl-asof').value.trim();
  const repeat = document.getElementById('pl-repeat').value.trim();
  const scope = {category:document.getElementById('pl-cat').value.trim(),
                 brand:document.getElementById('pl-brand').value.trim(),
                 vendor:document.getElementById('pl-vendor').value.trim()};
  let p = state.plans.find(x=>x.id===id);
  if(!p){ p = {id, site, asof, repeat, scope, sections:[]}; state.plans.push(p); }
  else { Object.assign(p, {site, asof, repeat, scope}); }
  state.currentPlanId = id; persist(); alert('Plan saved & set active.');
  render(); refreshActivePlanBadge();
}
function insertMockPlan(){
  const id = 'S-' + Math.floor(Math.random()*9000+1000);
  const p = {id, site:'BKK02', asof:'2025-10-01', repeat:'One-time', scope:{category:'Snack', brand:'Chip', vendor:'VND045'}, sections:[{section:'S01', bins:20}]};
  state.plans.push(p); state.currentPlanId = id; persist(); render(); refreshActivePlanBadge();
}
function systemGuidedRoute(){
  if(!ensurePlan()) return;
  const section = document.getElementById('sg-section').value.trim();
  const per = +document.getElementById('sg-stops').value||0;
  if(!section || per<=0){ alert('Section & Stops per Route required'); return; }
  const pid = state.currentPlanId;
  const r = {planId:pid, section, type:'system', stops:Array.from({length:per},(_,i)=>`${section}-${String(i+1).padStart(2,'0')}`)};
  state.routes.push(r);
  // derive bins
  r.stops.forEach(b=>state.bins.push({planId:pid, routeKey:keyOf(r), binId:b, section}));
  persist(); render();
}
function manualRouteCreate(){
  if(!ensurePlan()) return;
  const section = document.getElementById('mr-section').value.trim();
  const list = document.getElementById('mr-stops').value.trim();
  if(!section||!list){ alert('Enter Section & Stops'); return; }
  const stops = list.split(',').map(s=>s.trim()).filter(Boolean);
  const pid = state.currentPlanId;
  const r = {planId:pid, section, type:'manual', stops};
  state.routes.push(r);
  stops.forEach(b=>state.bins.push({planId:pid, routeKey:keyOf(r), binId:b, section}));
  persist(); render();
}
function delRoute(i){
  const pid = state.currentPlanId;
  const r = routesOfPlan(pid)[i]; if(!r) return;
  const key = keyOf(r);
  // remove assignments & bins & scans tied to this route
  state.assignments = state.assignments.filter(a=>!(a.planId===pid && a.routeKey===key));
  state.bins = state.bins.filter(b=>!(b.planId===pid && b.routeKey===key));
  state.scans = state.scans.filter(s=>!(s.planId===pid && s.routeKey===key));
  state.freezes = state.freezes.filter(f=>!(f.planId===pid && f.binId && r.stops.includes(f.binId)));
  state.discrepancies = state.discrepancies.filter(d=>!(d.planId===pid && d.binId && r.stops.includes(d.binId)));
  // remove route
  const idx = state.routes.findIndex(x=>x.planId===pid && keyOf(x)===key);
  if(idx>=0) state.routes.splice(idx,1);
  persist(); render();
}
function addAssign(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const rk = document.getElementById('as-route').value;
  const user = document.getElementById('as-user').value.trim();
  if(!rk || !user){ alert('Route & User required'); return; }
  // must be existing route
  const r = state.routes.find(x=>keyOf(x)===rk && x.planId===pid);
  if(!r){ alert('Selected route not found in current plan.'); return; }
  state.assignments.push({planId:pid, user, routeKey:rk}); persist(); render();
}
function toggleSheet(id, on){ document.getElementById(id).style.display = on?'flex':'none'; }
function submitScan(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const rkbin = document.getElementById('sc-bin').value;
  const [rk, binId] = rkbin.split('::');
  const exists = state.bins.some(b=>b.planId===pid && b.routeKey===rk && b.binId===binId);
  if(!exists){ alert('Bin must belong to current plan & selected route.'); return; }
  const sku = document.getElementById('sc-sku').value.trim();
  const qty = +document.getElementById('sc-qty').value||0;
  const blind = document.getElementById('sc-blind').value==='true';
  const note = document.getElementById('sc-note').value.trim();
  if(!sku || qty<=0){ alert('SKU and Qty>0 required'); return; }
  state.scans.push({planId:pid, routeKey:rk, binId, when:Date.now(), sku, qty, blind, note});
  persist(); toggleSheet('sheetScan',false); render();
}
function markDiscrepancy(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const rkbin = document.getElementById('sc-bin').value;
  const [rk, binId] = rkbin.split('::');
  const sku = document.getElementById('sc-sku').value.trim();
  const qty = +document.getElementById('sc-qty').value||0;
  const id = 'D-' + Math.floor(Math.random()*9000+1000);
  state.discrepancies.push({planId:pid, id, type:'QtyMismatch', binId, sku, expected:qty+2, counted:qty, status:'Open'});
  persist(); toggleSheet('sheetScan',false); render();
}
function freezeBin(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const binId = document.getElementById('fz-bin').value;
  const reason = document.getElementById('fz-reason').value.trim();
  if(!state.bins.some(b=>b.planId===pid && b.binId===binId)){ alert('Bin must belong to current plan'); return; }
  state.freezes.push({planId:pid, binId, reason, when:Date.now()}); persist(); toggleSheet('sheetFreeze',false); render();
}
function unfreezeBin(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  const binId = document.getElementById('fz-bin').value;
  state.freezes = state.freezes.filter(f=>!(f.planId===pid && f.binId===binId)); persist(); toggleSheet('sheetFreeze',false); render();
}
function unfreezeDirect(binId){
  const pid = state.currentPlanId;
  state.freezes = state.freezes.filter(f=>!(f.planId===pid && f.binId===binId)); persist(); render();
}
function insertMockException(){
  const pid = state.currentPlanId;
  const b = allBinsOfPlan(pid)[0]; if(!b){ alert('Need at least one bin'); return; }
  const id = 'D-' + Math.floor(Math.random()*9000+1000);
  state.discrepancies.push({planId:pid, id, type:'SerialMismatch', binId:b.binId, sku:'SER-0001', expected:1, counted:1, status:'Open'});
  persist(); renderValidate();
}
function saveCfg(){
  if(!ensurePlan()) return;
  const pid = state.currentPlanId;
  state.cfg = {
    planId:pid,
    blind: document.getElementById('cfg-blind').value==='true',
    twoMatch: document.getElementById('cfg-two').value==='true',
    photo: document.getElementById('cfg-photo').value==='true',
    maxVariance: +document.getElementById('cfg-var').value||5
  };
  persist(); alert('Validation rules saved for this plan.');
}
function closeDisc(id){ const it = state.discrepancies.find(x=>x.id===id && x.planId===state.currentPlanId); if(it){ it.status='Closed'; persist(); renderValidate(); }}

// Utils
function empty(text){
  return `<div class="card" style="text-align:center;padding:12px">
    <div class="ico-inline" data-ic="boxes" style="margin:0 auto 4px auto"></div>
    <div class="muted">${esc(text)}</div>
  </div>`;
}
function esc(s){return (s??'').toString().replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
function fmtWhen(t){const d=new Date(t||Date.now()); return d.toLocaleString();}

// Init
paintIcons(document);

function refreshActivePlanBadge(){
  const badge = document.getElementById('activePlanBadge');
  if(!badge) return;
  const p = currentPlan();
  badge.innerHTML = 'Plan: <b>' + (p? esc(p.id) : '—') + '</b>';
}

refreshActivePlanBadge();
</script>
</body>
</html>
