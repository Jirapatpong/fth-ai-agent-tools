<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Physical Count Web App ‚Äì Mobile‚ÄëFirst Mock (V2)</title>
<style>
  :root{
    --bg:#f6f8fb; --panel:#ffffff; --muted:#637082; --text:#0b1220;
    --brand:#2563eb; --brand-weak:#e8f0ff; --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --info:#0891b2;
    --line:#e4e8ef; --soft:#f1f5f9; --shadow:0 2px 8px rgba(15,23,42,.08);
    --radius:16px; --inset: env(safe-area-inset-bottom, 0);
    --fs-xs: clamp(12px, 1.5vw, 13px);
    --fs-sm: clamp(13px, 1.8vw, 14px);
    --fs-md: clamp(14px, 2.1vw, 16px);
    --fs-lg: clamp(16px, 2.5vw, 18px);
    --fs-xl: clamp(18px, 3vw, 22px);
    --icon: 24px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:var(--fs-md)/1.5 Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  /* Header */
  header{position:sticky;top:0;z-index:30;display:flex;align-items:center;gap:12px;padding:12px 16px;
    background:#fff;border-bottom:1px solid var(--line);box-shadow:var(--shadow)}
  .logo{width:18px;height:18px;background:conic-gradient(from 180deg at 50% 50%, #2563eb, #22d3ee, #60a5fa, #2563eb);border-radius:5px}
  h1{font-size:var(--fs-lg);margin:0}
  .sub{color:var(--muted);font-size:var(--fs-xs)}
  /* Hero */
  .hero{padding:14px 16px 10px 16px;background:linear-gradient(135deg,#e8f0ff,#f5fbff);border-bottom:1px solid var(--line)}
  .chips{display:flex;gap:10px;flex-wrap:wrap}
  .chip{display:flex;align-items:center;gap:8px;background:#fff;border:1px solid #d7dfef;border-radius:999px;padding:8px 12px;box-shadow:0 1px 2px rgba(2,6,23,.05)}
  .chip b{font-size:var(--fs-md)}
  .chip .i{font-size:18px}
  /* Layout */
  .container{max-width:1200px;margin:0 auto;padding:12px}
  .grid{display:grid;gap:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
  .card h3{margin:0 0 10px 0;font-size:var(--fs-lg);display:flex;align-items:center;gap:8px}
  .muted{color:var(--muted)}
  .accent{color:#1e40af}
  /* Controls */
  input,select,textarea,button{font-size:var(--fs-md)}
  input,select,textarea{width:100%;background:#fff;border:1px solid #dbe3ea;color:var(--text);
    padding:12px 14px;border-radius:12px;outline:none;min-height:44px}
  input:focus,select:focus,textarea:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(147,197,253,.35)}
  label{font-size:var(--fs-sm);color:#334155;display:block;margin-bottom:6px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;background:#fff;border:1px solid #cbd5e1;
    color:#0f172a;padding:12px 16px;border-radius:12px;cursor:pointer;min-height:46px}
  .btn.primary{border-color:var(--brand);background:var(--brand-weak);color:#0b3a9b}
  .btn.ok{border-color:var(--ok);color:#065f46;background:#ecfdf5}
  .btn.warn{border-color:var(--warn);color:#92400e;background:#fffbeb}
  .btn.bad{border-color:var(--bad);color:#7f1d1d;background:#fef2f2}
  .stack{display:flex;flex-wrap:wrap;gap:8px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid #cbd5e1;background:#fff;color:#334155;font-size:var(--fs-sm)}
  .pill.ok{background:#ecfdf5;border-color:#86efac;color:#14532d}
  .pill.warn{background:#fffbeb;border-color:#facc15;color:#713f12}
  .pill.bad{background:#fef2f2;border-color:#fecaca;color:#7f1d1d}
  .bar{height:10px;background:#fff;border:1px solid #e2e8f0;border-radius:999px;position:relative;overflow:hidden}
  .bar>span{position:absolute;left:0;top:0;bottom:0;background:linear-gradient(90deg,#60a5fa,#22d3ee)}
  /* Sparklines */
  .spark{width:100%;height:36px}
  /* Tables -> responsive list */
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th,td{text-align:left;padding:10px 12px}
  thead th{font-size:var(--fs-sm);color:#475569}
  tbody tr{background:#fff;border:1px solid #e5e7eb}
  tbody tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
  tbody tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
  @media (max-width:760px){
    table thead{display:none}
    table tbody tr{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:8px}
    table tbody td{padding:6px 8px}
    table tbody td::before{content:attr(data-label);display:block;color:#64748b;font-size:var(--fs-xs);margin-bottom:2px}
  }
  /* Desktop grids */
  @media (min-width:920px){
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  }
  @media (max-width:919px){ .kpi{display:grid;grid-template-columns:1fr 1fr;gap:12px} }
  /* Bottom tab bar */
  .tabs{position:fixed;left:0;right:0;bottom:0;z-index:40;background:#fff;border-top:1px solid var(--line);
    padding:6px calc(10px + var(--inset)); display:flex;gap:8px;justify-content:space-around}
  .tab-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;border:0;background:transparent;color:#334155;
    padding:8px;border-radius:12px;min-height:56px}
  .tab-btn .ico{font-size:var(--icon);line-height:1}
  .tab-btn.active{background:#eef2ff;color:#1e40af;border:1px solid #c7d2fe}
  .tab-btn span{font-size:var(--fs-xs)}
  .spacer{height:88px}
  /* FAB */
  .fab{position:fixed;right:16px;bottom:96px;z-index:45;background:#2563eb;color:#fff;border:0;border-radius:999px;
    min-width:56px;min-height:56px;display:flex;align-items:center;gap:10px;justify-content:center;padding:0 18px;
    box-shadow:0 14px 24px rgba(2,6,23,.28);cursor:pointer}
  .fab .ico{font-size:22px}
  /* Modals (bottom sheets) */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:flex-end;justify-content:center;z-index:50}
  .dialog{background:#fff;border-top-left-radius:20px;border-top-right-radius:20px;width:100%;max-width:720px;box-shadow:0 -10px 30px rgba(2,6,23,.18)}
  .sheet{padding:16px 16px calc(16px + var(--inset)) 16px;border-top:1px solid var(--line)}
  .sheet h3{margin:0 0 10px 0;font-size:var(--fs-lg);display:flex;align-items:center;gap:8px}
  .sheet .row{gap:10px}
  .close{position:absolute;right:14px;top:8px;background:#fff;border:1px solid #cbd5e1;color:#334155;border-radius:10px;padding:6px 10px;cursor:pointer}
  /* Icon circles */
  .ic{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;background:#eef2ff;color:#1e3a8a}
  .ic.ok{background:#ecfdf5;color:#14532d}
  .ic.warn{background:#fffbeb;color:#713f12}
  .ic.bad{background:#fef2f2;color:#7f1d1d}
</style>
</head>
<body>
<header>
  <div class="logo" aria-hidden="true"></div>
  <div>
    <h1>Physical Count</h1>
    <div class="sub">Mobile‚Äëfirst ‚Ä¢ SAP integration mock ‚Ä¢ Pre‚Äëseeded</div>
  </div>
</header>

<div class="hero">
  <div class="chips">
    <div class="chip"><span class="ic">üì¶</span><span>Planned <b id="chipPlanned">0</b></span></div>
    <div class="chip"><span class="ic ok">‚úÖ</span><span>Counted <b id="chipCounted">0</b></span></div>
    <div class="chip"><span class="ic warn">‚ö†Ô∏è</span><span>Open Disc <b id="chipDisc">0</b></span></div>
    <div class="chip"><span class="ic">üßä</span><span>Frozen <b id="chipFrozen">0</b></span></div>
  </div>
</div>

<div class="container" id="view"></div>
<div class="spacer"></div>

<!-- Bottom Tabs -->
<div class="tabs">
  <button class="tab-btn active" data-view="dashboard"><div class="ico">üè†</div><span>Dashboard</span></button>
  <button class="tab-btn" data-view="count"><div class="ico">üì∑</div><span>Count</span></button>
  <button class="tab-btn" data-view="queue"><div class="ico">‚ö†Ô∏è</div><span>Queue</span></button>
  <button class="tab-btn" data-view="plan"><div class="ico">üìù</div><span>Plan</span></button>
  <button class="tab-btn" data-view="more"><div class="ico">‚ãØ</div><span>More</span></button>
</div>

<!-- FAB Scan -->
<button class="fab" id="fabScan" title="Scan & Count"><span class="ico">üì∑</span><b>Scan</b></button>

<!-- Sheet Modals -->
<div class="modal" id="sheetScan">
  <div class="dialog">
    <div class="sheet">
      <button class="close" onclick="toggleSheet('sheetScan',false)">‚úï</button>
      <h3><span class="ic">üì∑</span> Scan & Count</h3>
      <div class="row">
        <div class="card" style="flex:1;min-width:240px">
          <label>Location / Bin</label>
          <input id="sc-loc" placeholder="Shelf A01 or Bin A01-05-002"/>
        </div>
        <div class="card" style="flex:1;min-width:240px">
          <label>SKU / EAN / Serial</label>
          <input id="sc-sku" placeholder="e.g., 8850123456789"/>
        </div>
      </div>
      <div class="row">
        <div class="card" style="flex:1;min-width:160px">
          <label>Qty</label>
          <input id="sc-qty" type="number" value="1"/>
        </div>
        <div class="card" style="flex:1;min-width:160px">
          <label>Blind Count</label>
          <select id="sc-blind"><option value="true">On</option><option value="false">Off</option></select>
        </div>
      </div>
      <div class="row">
        <div class="card" style="flex:1;">
          <label>Notes</label>
          <input id="sc-note" placeholder="Optional note"/>
        </div>
      </div>
      <div class="row">
        <button class="btn ok" onclick="submitScan()"><span class="ic ok">‚úÖ</span> Submit</button>
        <button class="btn" onclick="markDiscrepancy()"><span class="ic warn">‚ö†Ô∏è</span> Mark Discrepancy</button>
      </div>
      <div class="muted" style="margin-top:6px">Demo only: stores in localStorage.</div>
    </div>
  </div>
</div>

<div class="modal" id="sheetFreeze">
  <div class="dialog">
    <div class="sheet">
      <button class="close" onclick="toggleSheet('sheetFreeze',false)">‚úï</button>
      <h3><span class="ic">üßä</span> Freeze / Unfreeze Bin</h3>
      <div class="row">
        <div class="card" style="flex:1;min-width:220px">
          <label>Bin ID</label>
          <input id="fz-bin" placeholder="e.g., A01-05-002"/>
        </div>
        <div class="card" style="flex:1;min-width:220px">
          <label>Reason</label>
          <input id="fz-reason" placeholder="Cycle count in progress"/>
        </div>
      </div>
      <div class="row">
        <button class="btn warn" onclick="freezeBin()"><span class="ic warn">üßä</span> Freeze</button>
        <button class="btn ok" onclick="unfreezeBin()"><span class="ic ok">üî•</span> Unfreeze</button>
      </div>
      <div class="muted" style="margin-top:6px">Demo only.</div>
    </div>
  </div>
</div>

<script>
// State & Seed
const state = {
  sessions: JSON.parse(localStorage.getItem('pc_sessions')||'[]'),
  assignments: JSON.parse(localStorage.getItem('pc_assignments')||'[]'),
  scans: JSON.parse(localStorage.getItem('pc_scans')||'[]'),
  discrepancies: JSON.parse(localStorage.getItem('pc_disc')||'[]'),
  freezes: JSON.parse(localStorage.getItem('pc_freezes')||'[]'),
  maps: JSON.parse(localStorage.getItem('pc_maps')||'[]'),
  cfg: JSON.parse(localStorage.getItem('pc_cfg')||'null')
};
function persist(){
  localStorage.setItem('pc_sessions', JSON.stringify(state.sessions));
  localStorage.setItem('pc_assignments', JSON.stringify(state.assignments));
  localStorage.setItem('pc_scans', JSON.stringify(state.scans));
  localStorage.setItem('pc_disc', JSON.stringify(state.discrepancies));
  localStorage.setItem('pc_freezes', JSON.stringify(state.freezes));
  localStorage.setItem('pc_maps', JSON.stringify(state.maps));
  localStorage.setItem('pc_cfg', JSON.stringify(state.cfg));
}
(function seed(){
  const fresh = !state.sessions.length && !state.assignments.length && !state.scans.length &&
                !state.discrepancies.length && !state.freezes.length && !state.maps.length && !state.cfg;
  if(!fresh) return;
  const now = Date.now();
  state.sessions = [{
    id:'S-2025-09-001', site:'BKK01', asof:'2025-09-01',
    scope:{category:'Beverage', brand:'Cola', vendor:'VND001'},
    repeat:'Quarterly', freezePolicy:'Optional',
    sections:[{section:'A01', bins:40, people:3, duration:'4h'},
              {section:'A02', bins:32, people:2, duration:'3h'},
              {section:'Backroom-FRZ', bins:12, people:1, duration:'2h'}]
  }];
  state.assignments = [
    {user:'alice', section:'A01', bins:20, route:['A01-01','A01-02','A01-03']},
    {user:'bob', section:'A01', bins:20, route:['A01-04','A01-05','A01-06']},
    {user:'carl', section:'A02', bins:16, route:['A02-01','A02-02']},
    {user:'diana', section:'Backroom-FRZ', bins:12, route:['FRZ-01','FRZ-02']},
  ];
  state.scans = [
    {when:now-7200e3, loc:'Shelf A01', sku:'EAN-885000000001', qty:6, blind:true, note:'promo'},
    {when:now-6800e3, loc:'Shelf A01', sku:'EAN-885000000002', qty:3, blind:true, note:''},
    {when:now-3600e3, loc:'Bin A01-05-002', sku:'SKU-2002', qty:2, blind:false, note:''},
    {when:now-1200e3, loc:'Bin A02-01-004', sku:'SKU-3003', qty:9, blind:false, note:'box opened'},
  ];
  state.discrepancies = [
    {id:'D-1001', loc:'Shelf A01', sku:'EAN-885000000001', expected:10, counted:6, status:'Open'},
    {id:'D-1002', loc:'Bin A01-05-002', sku:'SKU-2002', expected:3, counted:2, status:'Open'},
  ];
  state.freezes = [
    {bin:'A01-05-002', reason:'Cycle count', when:now-3000e3},
    {bin:'FRZ-01', reason:'Backroom Frozen', when:now-5000e3}
  ];
  state.maps = [
    {shelf:'A01', bin:'A01-05-001'},
    {shelf:'A01', bin:'A01-05-002'},
    {shelf:'A02', bin:'A02-01-004'},
    {shelf:'FRZ', bin:'FRZ-01'}
  ];
  state.cfg = {blind:true, twoMatch:true, photo:true};
  persist();
})();

// Routing via bottom tabs
const view = document.getElementById('view');
document.querySelectorAll('.tab-btn').forEach(b=>{
  b.onclick = ()=>{
    document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    location.hash = b.dataset.view;
    render();
  };
});
document.getElementById('fabScan').onclick = ()=> toggleSheet('sheetScan', true);
window.addEventListener('hashchange', render);
function render(){
  const route = (location.hash||'#dashboard').replace('#','');
  updateHero();
  switch(route){
    case 'dashboard': return renderDashboard();
    case 'count': return renderCount();
    case 'queue': return renderQueue();
    case 'plan': return renderPlan();
    case 'more': return renderMore();
    default: return renderDashboard();
  }
}
render();

function updateHero(){
  const planned = state.sessions.flatMap(s=>s.sections||[]).reduce((a,b)=>a+(b.bins||0),0);
  const counted = state.scans.length;
  const discOpen = state.discrepancies.filter(d=>d.status!=='Closed').length;
  const frozen = state.freezes.length;
  document.getElementById('chipPlanned').textContent = planned;
  document.getElementById('chipCounted').textContent = counted;
  document.getElementById('chipDisc').textContent = discOpen;
  document.getElementById('chipFrozen').textContent = frozen;
}

// Views
function renderDashboard(){
  const totalBins = state.sessions.flatMap(s=>s.sections||[]).reduce((a,b)=>a+(b.bins||0),0);
  const counted = state.scans.length;
  const discOpen = state.discrepancies.filter(d=>d.status!=='Closed').length;
  const freezes = state.freezes.length;
  view.innerHTML = `
    <div class="grid">
      <div class="kpi">
        ${kpi('Planned Bins', totalBins, spark([20,40,60,50,80,70,90]))}
        ${kpi('Counted Entries', counted, spark([0,4,9,12,16,18,22]))}
        ${kpi('Open Discrepancies', discOpen, spark([5,6,4,5,3,4,2]))}
        ${kpi('Frozen Bins', freezes, spark([1,2,1,2,1,1,2]))}
      </div>
      <div class="two-col">
        <div class="card">
          <h3><span class="ic ok">‚úÖ</span> Recent Scans</h3>
          ${listScans(state.scans.slice(-6).reverse())}
          <div class="row"><button class="btn ok" onclick="toggleSheet('sheetScan',true)"><span class="ic ok">üì∑</span> Scan & Count</button></div>
        </div>
        <div class="card">
          <h3><span class="ic warn">‚ö†Ô∏è</span> Discrepancy Queue</h3>
          ${listQueue(state.discrepancies.slice(-6).reverse())}
          <div class="row"><button class="btn" onclick="location.hash='queue'; render();"><span class="ic">‚û°Ô∏è</span> Open Queue</button></div>
        </div>
      </div>
    </div>`;
}
function kpi(title,val,svg){
  return `<div class="card"><div class="muted">${title}</div>
    <div style="display:flex;align-items:flex-end;justify-content:space-between;gap:8px">
      <div style="font-size:var(--fs-xl);font-weight:700">${val||0}</div>
      <div class="spark">${svg}</div>
    </div>
    <div class="bar" style="margin-top:6px"><span style="width:${Math.min(100,(+val||0))}%"></span></div>
  </div>`;
}
function spark(points){
  const w=120,h=36; const max=Math.max(...points,1); const step=w/(points.length-1||1);
  const d=points.map((p,i)=>`${i? 'L':'M'} ${i*step},${h-(p/max)*h}`).join(' ');
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
    <path d="${d}" fill="none" stroke="#60a5fa" stroke-width="2"/>
  </svg>`;
}
function listScans(arr){
  if(!arr.length) return empty('No scans yet. Tap ‚ÄúScan‚Äù to start.');
  return `<div class="grid">
    ${arr.map(r=>`<div class="card" style="padding:10px">
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center">
        <div style="display:flex;align-items:center;gap:10px">
          <span class="ic ok">üì¶</span>
          <div><b>${esc(r.sku)}</b><div class="muted" style="font-size:var(--fs-sm)">${esc(r.loc)}</div></div>
        </div>
        <div style="text-align:right">
          <span class="pill ok">Qty ${r.qty}</span>
          <div class="muted" style="font-size:var(--fs-xs)">${fmtWhen(r.when)}</div>
        </div>
      </div>
      <div class="muted" style="margin-top:4px;font-size:var(--fs-sm)">${r.blind?'Blind':''} ${esc(r.note||'')}</div>
    </div>`).join('')}
  </div>`;
}
function listQueue(arr){
  if(!arr.length) return empty('No discrepancies. Great job!');
  return `<div class="grid">
    ${arr.map(d=>`<div class="card" style="padding:10px;display:grid;gap:8px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;align-items:center;gap:10px">
          <span class="ic warn">‚ö†Ô∏è</span>
          <div><b>${esc(d.id)}</b> ‚Äî ${esc(d.sku)}</div>
        </div>
        <span class="pill ${d.status==='Open'?'warn':'ok'}">${d.status}</span>
      </div>
      <div class="muted">${esc(d.loc)}</div>
      <div>Expected <b>${d.expected}</b> ‚Ä¢ Counted <b>${d.counted}</b></div>
      <div class="row"><button class="btn ok" onclick="closeDisc('${d.id}')"><span class="ic ok">‚úÖ</span> Approve & Close</button></div>
    </div>`).join('')}
  </div>`;
}
function empty(text){
  return `<div class="card" style="text-align:center;padding:18px">
    <div style="font-size:40px;line-height:1.1">ü™Ñ</div>
    <div style="margin-top:6px" class="muted">${esc(text)}</div>
  </div>`;
}

function renderCount(){
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ic">üß≠</span> My Tasks</h3>
        ${tableAssign(state.assignments)}
      </div>
      <div class="card">
        <h3><span class="ic ok">‚úÖ</span> Recent Scans</h3>
        ${listScans(state.scans.slice(-12).reverse())}
      </div>
    </div>`;
}
function tableAssign(arr){
  if(!arr.length) return empty('No assignments yet.');
  return `<table><thead><tr><th>User</th><th>Section</th><th>Bins</th><th>Route</th></tr></thead>
    <tbody>${arr.map(a=>`<tr>
      <td data-label="User">${esc(a.user)}</td>
      <td data-label="Section">${esc(a.section)}</td>
      <td data-label="Bins"><span class="pill">${a.bins}</span></td>
      <td data-label="Route">${a.route.join(', ')}</td>
    </tr>`).join('')}</tbody></table>`;
}

function renderQueue(){
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ic warn">‚ö†Ô∏è</span> Discrepancy Queue</h3>
        ${listQueue(state.discrepancies)}
      </div>
    </div>`;
}

function renderPlan(){
  const s = state.sessions[0];
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ic">üóÇÔ∏è</span> Plan (BKK01)</h3>
        ${s?`
          <div class="grid" style="gap:10px">
            <div class="row">
              <div class="card" style="flex:1;min-width:160px"><div class="muted">Site</div><div><b>${esc(s.site)}</b></div></div>
              <div class="card" style="flex:1;min-width:160px"><div class="muted">As-of</div><div><b>${esc(s.asof)}</b></div></div>
              <div class="card" style="flex:1;min-width:160px"><div class="muted">Repeat</div><div><b>${esc(s.repeat)}</b></div></div>
            </div>
            <div class="row">
              <div class="card" style="flex:1;min-width:160px"><div class="muted">Category</div><div>${esc(s.scope.category)}</div></div>
              <div class="card" style="flex:1;min-width:160px"><div class="muted">Brand</div><div>${esc(s.scope.brand)}</div></div>
              <div class="card" style="flex:1;min-width:160px"><div class="muted">Vendor</div><div>${esc(s.scope.vendor)}</div></div>
            </div>
          </div>` : empty('No plan yet.')}
      </div>
      <div class="card">
        <h3><span class="ic">üß±</span> Sections</h3>
        ${s? tableSections(s.sections): empty('No sections.')}
      </div>
      <div class="card">
        <h3><span class="ic">üßä</span> Freeze Control</h3>
        <div class="stack">${state.freezes.map(f=>`<span class="pill warn">Frozen: ${esc(f.bin)}</span>`).join('') || '<span class="muted">No frozen bins.</span>'}</div>
        <div class="row" style="margin-top:8px">
          <button class="btn warn" onclick="toggleSheet('sheetFreeze',true)"><span class="ic warn">üßä</span> Freeze / Unfreeze</button>
        </div>
      </div>
    </div>`;
}
function tableSections(secs){
  return `<table><thead><tr><th>Section</th><th>Bins</th><th>People</th><th>Duration</th></tr></thead>
    <tbody>${secs.map(x=>`<tr>
      <td data-label="Section">${esc(x.section)}</td>
      <td data-label="Bins"><span class="pill">${x.bins}</span></td>
      <td data-label="People"><span class="pill">${x.people}</span></td>
      <td data-label="Duration">${x.duration}</td>
    </tr>`).join('')}</tbody></table>`;
}

function renderMore(){
  view.innerHTML = `
    <div class="grid">
      <div class="card">
        <h3><span class="ic">‚öôÔ∏è</span> Settings</h3>
        ${renderSettings()}
      </div>
      <div class="card">
        <h3><span class="ic">üó∫Ô∏è</span> Shelf ‚Üî Bin Mapping</h3>
        ${renderMapping()}
      </div>
      <div class="card">
        <h3><span class="ic">üß™</span> Data Controls</h3>
        <div class="row">
          <button class="btn primary" onclick="seedAll()"><span class="ic">üå±</span> Re-seed Demo Data</button>
          <button class="btn bad" onclick="clearAll()"><span class="ic bad">üßπ</span> Clear All Data</button>
        </div>
        <div class="muted" style="margin-top:6px">Stored in your browser (localStorage).</div>
      </div>
    </div>`;
}

function renderSettings(){
  const cfg = state.cfg || {blind:true,twoMatch:true,photo:true};
  return `<div class="grid">
    <div class="row">
      <div class="card" style="flex:1;min-width:160px"><label>Blind Count</label>
        <select id="cfg-blind"><option value="true"${cfg.blind?' selected':''}>On</option><option value="false"${!cfg.blind?' selected':''}>Off</option></select>
      </div>
      <div class="card" style="flex:1;min-width:160px"><label>Two-Match Principle</label>
        <select id="cfg-two"><option value="true"${cfg.twoMatch?' selected':''}>On</option><option value="false"${!cfg.twoMatch?' selected':''}>Off</option></select>
      </div>
      <div class="card" style="flex:1;min-width:160px"><label>Photo Evidence</label>
        <select id="cfg-photo"><option value="true"${cfg.photo?' selected':''}>Required</option><option value="false"${!cfg.photo?' selected':''}>Optional</option></select>
      </div>
    </div>
    <div class="row"><button class="btn ok" onclick="saveCfg()"><span class="ic ok">üíæ</span> Save</button></div>
  </div>`;
}
function saveCfg(){
  state.cfg = {
    blind: document.getElementById('cfg-blind').value==='true',
    twoMatch: document.getElementById('cfg-two').value==='true',
    photo: document.getElementById('cfg-photo').value==='true',
  };
  persist();
  alert('Saved (demo).');
}

function renderMapping(){
  const maps = state.maps;
  return `
    <div class="row" style="gap:8px">
      <div style="flex:1;min-width:120px">
        <label>Shelf</label>
        <input id="map-shelf" placeholder="A01" />
      </div>
      <div style="flex:2;min-width:160px">
        <label>Bin</label>
        <input id="map-bin" placeholder="A01-05-002" />
      </div>
      <div style="align-self:end"><button class="btn ok" onclick="addMapping()"><span class="ic ok">‚ûï</span> Add</button></div>
    </div>
    ${maps.length ? `<div class="grid" style="margin-top:10px">${maps.map((m,i)=>`<div class="card" style="display:flex;justify-content:space-between;align-items:center">
        <div><b>${esc(m.shelf)}</b> ‚Üí ${esc(m.bin)}</div>
        <button class="btn bad" onclick="delMapping(${i})"><span class="ic bad">üóëÔ∏è</span> Delete</button>
      </div>`).join('')}</div>` : empty('No mappings yet.')}`;
}
function addMapping(){
  const shelf = document.getElementById('map-shelf').value.trim();
  const bin = document.getElementById('map-bin').value.trim();
  if(!shelf||!bin){ alert('Enter Shelf and Bin'); return; }
  state.maps.push({shelf,bin}); persist(); render();
}
function delMapping(i){ state.maps.splice(i,1); persist(); render(); }

// Actions
function toggleSheet(id, on){ document.getElementById(id).style.display = on?'flex':'none'; }
function submitScan(){
  const loc = document.getElementById('sc-loc').value.trim();
  const sku = document.getElementById('sc-sku').value.trim();
  const qty = +document.getElementById('sc-qty').value||0;
  const blind = document.getElementById('sc-blind').value==='true';
  const note = document.getElementById('sc-note').value.trim();
  if(!loc || !sku || qty<=0){ alert('Please fill Location, SKU and Qty > 0'); return; }
  state.scans.push({when:Date.now(), loc, sku, qty, blind, note});
  persist(); toggleSheet('sheetScan',false); render();
}
function markDiscrepancy(){
  const loc = document.getElementById('sc-loc').value.trim();
  const sku = document.getElementById('sc-sku').value.trim();
  const qty = +document.getElementById('sc-qty').value||0;
  if(!loc || !sku){ alert('Please fill Location and SKU'); return; }
  const id = 'D-' + Math.floor(Math.random()*9000+1000);
  state.discrepancies.push({id, loc, sku, expected:qty+2, counted:qty, status:'Open'});
  persist(); toggleSheet('sheetScan',false); render();
}
function closeDisc(id){
  const it = state.discrepancies.find(x=>x.id===id);
  if(it){ it.status='Closed'; persist(); render(); }
}
function freezeBin(){
  const bin = document.getElementById('fz-bin').value.trim();
  if(!bin){ alert('Enter Bin'); return; }
  state.freezes.push({bin, reason:document.getElementById('fz-reason').value.trim(), when:Date.now()});
  persist(); toggleSheet('sheetFreeze',false); render();
}
function unfreezeBin(){
  const bin = document.getElementById('fz-bin').value.trim();
  state.freezes = state.freezes.filter(f=>f.bin!==bin); persist(); toggleSheet('sheetFreeze',false); render();
}
function seedAll(){ localStorage.clear(); location.reload(); }
function clearAll(){ localStorage.clear(); alert('Cleared. Reloading...'); location.reload(); }

// Utils
function esc(s){return (s??'').toString().replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
function fmtWhen(t){const d=new Date(t||Date.now()); return d.toLocaleString();}
</script>
</body>
</html>
