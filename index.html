<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Analyzer & Sales Dashboard</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter for the main UI, Fira Code for the text areas -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- highlight.js for syntax highlighting JSON within logs -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <!-- Chart.js for the dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- NEW: AI & Minimal Theme --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a; /* Near black background */
            color: #e0e0e0;
        }
        textarea, pre code {
            font-family: 'Fira Code', monospace !important;
            font-size: 12px !important;
            line-height: 1.6 !important;
        }
        #output-container, #ai-output, textarea {
            background-color: #1a1a1a;
            border-radius: 0.5rem;
            border: 1px solid #333;
            padding: 1rem;
            overflow: auto;
        }
        
        textarea#input-code, #output-container {
            height: 45vh;
            min-height: 300px;
            resize: none;
        }

        /* Custom scrollbar for dark theme */
        textarea::-webkit-scrollbar, #output-container::-webkit-scrollbar, #ai-output::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        textarea::-webkit-scrollbar-track, #output-container::-webkit-scrollbar-track, #ai-output::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        textarea::-webkit-scrollbar-thumb, #output-container::-webkit-scrollbar-thumb, #ai-output::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .log-line { 
            white-space: pre-wrap; 
        }
        .log-timestamp { color: #888; }
        .log-thread { color: #cda56f; }
        .log-level-INFO { color: #569cd6; font-weight: bold; }
        .log-level-WARN { color: #dcdcaa; font-weight: bold; }
        .log-level-ERROR { color: #f44747; font-weight: bold; }
        .log-source { color: #c586c0; }
        .log-message { color: #d4d4d4; }
        .log-message .hljs {
            background: #252526;
            padding: 0.5em;
            border-radius: 4px;
            margin-top: 0.5em;
            display: block;
        }
        .log-line-request {
            background-color: rgba(86, 156, 214, 0.07);
        }
        .log-line-response {
            background-color: rgba(181, 206, 168, 0.07);
        }
        .search-highlight {
            background-color: #dcdcaa;
            color: #111827;
            border-radius: 2px;
        }
        .search-highlight-current {
            background-color: #f9ae58;
            color: #111827;
            border-radius: 2px;
        }
        #ai-output {
            white-space: pre-wrap;
        }
        #ai-input {
            resize: none;
        }
        /* --- FIX: Consistent AI Pane Styling --- */
        #ai-input, #ai-output {
            height: 320px;
            font-family: 'Inter', sans-serif !important;
            font-size: 14px !important;
        }
        .chat-message { margin-bottom: 1rem; }
        .chat-message-user { font-weight: bold; color: #569cd6; }
        .chat-message-assistant { font-weight: bold; color: #b5cea8; }
        .chat-message-content { padding-left: 1rem; white-space: pre-wrap; }
        
        /* --- FIX: Visible AI Selector --- */
        .ai-selector img {
            width: 40px;
            height: 40px;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            opacity: 0.5;
        }
        .ai-selector img:hover {
            opacity: 0.8;
        }
        .ai-selector img.active {
            opacity: 1;
            border-color: #8b5cf6; /* Purple border */
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.7); /* Purple glow */
        }
    </style>
</head>
<body class="text-gray-200">

    <div class="container mx-auto p-4 md:p-8 max-w-full">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-white">Log AI Analyzer</h1>
            <p class="mt-2 text-lg text-gray-400">Analyze logs and build sales dashboards with AI assistance.</p>
        </header>

        <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-6">
            <label class="w-full sm:w-auto bg-gray-700 hover:bg-gray-600 text-white font-bold py-2.5 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center gap-2 cursor-pointer">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12h16M4 18h16M4 6h16"/></svg>
                Browse File
                <input type="file" id="file-input" class="hidden" accept=".log,.txt">
            </label>
            <button id="format-btn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-500 text-white font-bold py-2.5 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center gap-2 min-w-[160px]">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-2"><path d="M12 3c-1.2 0-2.4.6-3 1.7A3.5 3.5 0 0 0 6.5 8c0 2 .5 3.5 3 5.5L12 16l2.5-2.5c2.5-2 3-3.5 3-5.5A3.5 3.5 0 0 0 15 4.7c-.6-1.1-1.8-1.7-3-1.7Z"/><path d="M22 12c0 5-4.5 9-10 9s-10-4-10-9 4.5-9 10-9"/></svg>
                Format Log
            </button>
            <button id="copy-btn" class="w-full sm:w-auto bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2.5 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center gap-2">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                Copy Text
            </button>
            <button id="dashboard-btn" class="w-full sm:w-auto bg-green-600 hover:bg-green-500 text-white font-bold py-2.5 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center gap-2 min-w-[160px]">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="m19 9-5 5-4-4-3 3"/></svg>
                Generate Dashboard
            </button>
        </div>
        
        <div class="flex justify-center items-center gap-4 mb-4">
            <input type="text" id="search-input" class="w-full max-w-xs bg-gray-800 border border-gray-600 text-white text-sm rounded-lg p-2.5" placeholder="Search in formatted log...">
            <button id="find-next-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2.5 px-6 rounded-lg transition-colors duration-300">Find Next</button>
        </div>

        <div id="spinner-container" class="hidden justify-center items-center my-4">
            <div class="spinner"></div>
        </div>

        <div id="message-box" class="text-center text-sm font-medium p-2 mb-4 rounded-md opacity-0 transition-opacity duration-300"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="input-code" class="block mb-2 text-sm font-medium text-gray-400">Source Log (Input)</label>
                <textarea id="input-code" class="block p-4 w-full text-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Paste your log content here or use 'Browse File'..."></textarea>
            </div>
            <div>
                <label class="block mb-2 text-sm font-medium text-gray-400">Formatted Log (Output)</label>
                <div id="output-container">
                    <pre><code id="output-code" class="log-output">Formatted log will appear here...</code></pre>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="mt-8 hidden">
            <h2 class="text-3xl font-bold text-white mb-6 text-center">Sales Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div class="bg-gray-900/50 p-6 rounded-lg text-center"><h3 class="text-gray-400 text-lg">Total Sales</h3><p id="total-sales" class="text-4xl font-bold text-white mt-2">0.00</p></div>
                <div class="bg-gray-900/50 p-6 rounded-lg text-center"><h3 class="text-gray-400 text-lg">Total Transactions</h3><p id="total-transactions" class="text-4xl font-bold text-white mt-2">0</p></div>
                 <div class="bg-gray-900/50 p-6 rounded-lg text-center"><h3 class="text-gray-400 text-lg">Avg. Transaction Value</h3><p id="avg-transaction" class="text-4xl font-bold text-white mt-2">0.00</p></div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-900/50 p-6 rounded-lg"><canvas id="hourly-sales-chart"></canvas></div>
                <div class="bg-gray-900/50 p-6 rounded-lg"><canvas id="tender-type-chart"></canvas></div>
                <div class="bg-gray-900/50 p-6 rounded-lg"><canvas id="best-selling-chart"></canvas></div>
                <div class="bg-gray-900/50 p-6 rounded-lg"><canvas id="top-spender-chart"></canvas></div>
            </div>
        </div>
        
        <!-- AI Analysis Section -->
        <div class="mt-8">
            <h2 class="text-3xl font-bold text-white mb-6 text-center">Ask an AI About This Log</h2>
            <div class="flex flex-col items-center mb-4 gap-4">
                <div class="ai-selector flex gap-4">
                    <img id="gemini-selector" src="https://static.vecteezy.com/system/resources/thumbnails/055/687/063/small/circle-gemini-google-icon-symbol-logo-free-png.png" alt="Gemini" class="active">
                    <img id="chatgpt-selector" src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/04/ChatGPT_logo.svg/2048px-ChatGPT_logo.svg.png" alt="ChatGPT">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="ai-input" class="block mb-2 text-sm font-medium text-gray-400">Your Question</label>
                    <textarea id="ai-input" class="block p-4 w-full text-gray-300 focus:ring-purple-500 focus:border-purple-500" placeholder="e.g., How can I improve sales performance?"></textarea>
                    <button id="ai-ask-btn" class="mt-4 w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2.5 px-6 rounded-lg transition-colors duration-300 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Z"/><path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Z"/><path d="M12 12v6"/><path d="M12 6V2"/></svg>
                        Ask AI
                    </button>
                </div>
                 <div>
                    <label class="block mb-2 text-sm font-medium text-gray-400">AI Conversation</label>
                    <div id="ai-output" class="p-4 rounded-lg text-gray-300 overflow-y-auto">
                        Ask a question to start the conversation...
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Prettier library for formatting JSON -->
    <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
    <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>

    <script>
        // DOM Element References
        const formatBtn = document.getElementById('format-btn');
        const dashboardBtn = document.getElementById('dashboard-btn');
        const copyBtn = document.getElementById('copy-btn');
        const inputCode = document.getElementById('input-code');
        const outputCode = document.getElementById('output-code');
        const messageBox = document.getElementById('message-box');
        const fileInput = document.getElementById('file-input');
        const spinnerContainer = document.getElementById('spinner-container');
        const searchInput = document.getElementById('search-input');
        const findNextBtn = document.getElementById('find-next-btn');
        const dashboardSection = document.getElementById('dashboard-section');
        const aiAskBtn = document.getElementById('ai-ask-btn');
        const aiInput = document.getElementById('ai-input');
        const aiOutput = document.getElementById('ai-output');
        const geminiSelector = document.getElementById('gemini-selector');
        const chatgptSelector = document.getElementById('chatgpt-selector');
        
        const GEMINI_API_KEY = "AIzaSyBOurSwEdhn6IHFpFr-BMhhp54iVsa8aYs";
        const CHATGPT_API_KEY = "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";

        let formattedPlainText = '';
        let originalFormattedHtml = '';
        let searchMatches = [];
        let currentMatchIndex = -1;
        let lastSearchTerm = '';
        let charts = {};
        let geminiChatHistory = [];
        let chatgptChatHistory = [];
        let salesDataForAI = null;
        let selectedAI = 'gemini';

        function showMessage(text, type = 'success') {
            messageBox.textContent = text;
            messageBox.classList.remove('opacity-0', 'bg-green-900', 'text-green-300', 'bg-red-900', 'text-red-300');
            if (type === 'success') {
                messageBox.classList.add('bg-green-900', 'text-green-300');
            } else {
                messageBox.classList.add('bg-red-900', 'text-red-300');
            }
            messageBox.classList.add('opacity-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, 3000);
        }

        function escapeHtml(unsafe) {
            return unsafe
                 .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
        
        function decodeTIS620(text) {
            let result = '';
            for (let i = 0; i < text.length; i++) {
                const charCode = text.charCodeAt(i);
                if (charCode >= 161 && charCode <= 251) {
                    result += String.fromCharCode(charCode + 3424);
                } else {
                    result += text.charAt(i);
                }
            }
            return result;
        }

        function formatLog() {
            const sourceCode = inputCode.value;
            if (!sourceCode.trim()) {
                showMessage('Input is empty. Please paste some log data.', 'error');
                return;
            }

            formatBtn.disabled = true;
            spinnerContainer.classList.remove('hidden');
            spinnerContainer.classList.add('flex');
            outputCode.innerHTML = '';
            formattedPlainText = '';
            clearAIChat();
            
            setTimeout(() => {
                const lines = sourceCode.replace(/\r\n/g, '\n').split('\n');
                let finalHtml = '';
                let finalPlainText = '';
                const logRegex = /^(\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2},\d{3})\s+(\[\d+\])\s+(INFO|WARN|ERROR|DEBUG)\s+([\w\s.()\[\]-]+?)\s+[–-]\s+(.*)$/;

                lines.forEach(line => {
                    const match = line.match(logRegex);
                    if (match) {
                        const [ , timestamp, thread, level, source, message ] = match;
                        const correctedMessage = decodeTIS620(message);
                        let messageHtml = '';
                        let messagePlainText = correctedMessage;
                        const jsonMatch = correctedMessage.match(/:\s*(\{.*\}|\[.*\])$/);
                        if (jsonMatch && jsonMatch[1]) {
                            try {
                                const jsonString = jsonMatch[1];
                                const formattedJson = prettier.format(jsonString, { parser: 'json', plugins: prettierPlugins });
                                const highlightedJson = hljs.highlight(formattedJson, { language: 'json' }).value;
                                messageHtml = escapeHtml(correctedMessage.replace(jsonString, '')) + `<code class="hljs json">${highlightedJson}</code>`;
                            } catch (e) {
                                messageHtml = escapeHtml(correctedMessage);
                            }
                        } else {
                            messageHtml = escapeHtml(correctedMessage);
                        }
                        
                        let lineClass = 'log-line';
                        if (correctedMessage.includes('Request :')) lineClass += ' log-line-request';
                        else if (correctedMessage.includes('Response :')) lineClass += ' log-line-response';

                        finalHtml += `<div class="${lineClass}"><span class="log-timestamp">${timestamp}</span> <span class="log-thread">${thread}</span> <span class="log-level-${level}">${level}</span> <span class="log-source">${source}</span> <span class="log-message">– ${messageHtml}</span></div>`;
                        finalPlainText += `${timestamp} ${thread} ${level} ${source} – ${messagePlainText}\n`;
                    } else {
                        const correctedLine = decodeTIS620(line);
                        finalHtml += `<div class="log-line">${escapeHtml(correctedLine)}</div>`;
                        finalPlainText += correctedLine + '\n';
                    }
                });
                
                outputCode.innerHTML = finalHtml;
                originalFormattedHtml = finalHtml;
                formattedPlainText = finalPlainText;
                
                showMessage('Log formatted successfully!', 'success');
                formatBtn.disabled = false;
                spinnerContainer.classList.add('hidden');
                spinnerContainer.classList.remove('flex');

            }, 50);
        }

        formatBtn.addEventListener('click', formatLog);

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                inputCode.value = e.target.result;
                formatLog();
            };
            reader.onerror = () => {
                showMessage('Failed to read file.', 'error');
            };
            reader.readAsText(file, 'TIS-620');
        });
        
        copyBtn.addEventListener('click', () => {
            if (!formattedPlainText.trim() || formattedPlainText === 'Formatted code will appear here...') {
                showMessage('Nothing to copy.', 'error');
                return;
            }
            if (navigator.clipboard) {
                navigator.clipboard.writeText(formattedPlainText).then(() => {
                    showMessage('Copied to clipboard!', 'success');
                }).catch(() => showMessage('Failed to copy text.', 'error'));
            } else {
                const textArea = document.createElement('textarea');
                textArea.value = formattedPlainText;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showMessage('Copied to clipboard!', 'success');
                } catch (err) {
                    showMessage('Failed to copy text.', 'error');
                }
                document.body.removeChild(textArea);
            }
        });

        function performSearch() {
            const searchTerm = searchInput.value;
            if (!originalFormattedHtml) return;
            
            outputCode.innerHTML = originalFormattedHtml;
            
            if (!searchTerm) {
                searchMatches = [];
                currentMatchIndex = -1;
                return;
            }

            const regex = new RegExp(escapeHtml(searchTerm), 'gi');
            outputCode.innerHTML = originalFormattedHtml.replace(regex, (match) => `<mark class="search-highlight">${match}</mark>`);
            
            searchMatches = outputCode.querySelectorAll('.search-highlight');
            currentMatchIndex = -1;
            if (searchMatches.length > 0) {
                findNext();
            }
        }
        
        function findNext() {
            if (searchMatches.length === 0) return;
            
            if (currentMatchIndex > -1) {
                searchMatches[currentMatchIndex].classList.remove('search-highlight-current');
                searchMatches[currentMatchIndex].classList.add('search-highlight');
            }

            currentMatchIndex = (currentMatchIndex + 1) % searchMatches.length;

            const currentMatch = searchMatches[currentMatchIndex];
            currentMatch.classList.add('search-highlight-current');
            currentMatch.classList.remove('search-highlight');
            currentMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        findNextBtn.addEventListener('click', () => {
            const searchTerm = searchInput.value;
            if (!searchTerm) {
                if (lastSearchTerm !== '') {
                    outputCode.innerHTML = originalFormattedHtml;
                    lastSearchTerm = '';
                }
                return;
            }

            if (searchTerm !== lastSearchTerm) {
                performSearch();
                lastSearchTerm = searchTerm;
            } else {
                findNext();
            }
        });

        dashboardBtn.addEventListener('click', () => {
            if (!formattedPlainText) {
                showMessage('Please format a log file first.', 'error');
                return;
            }
            
            const lines = formattedPlainText.split('\n');
            const salesData = {
                hourly: Array(24).fill(0),
                tenderTypes: {},
                bestSellers: {},
                topSpenders: {},
                totalSales: 0,
                totalTransactions: 0
            };

            lines.forEach(line => {
                if (line.includes('End Transaction Response')) {
                    const jsonString = line.substring(line.indexOf('{'));
                    try {
                        const data = JSON.parse(jsonString);
                        if (data.data && data.data.paymentList && Array.isArray(data.data.paymentList)) {
                            salesData.totalTransactions++;
                            let transactionTotal = 0;
                            
                            const timestampMatch = line.match(/^(\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2})/);
                            const hour = timestampMatch ? new Date(timestampMatch[1]).getHours() : 0;

                            data.data.paymentList.forEach(p => {
                                const paymentAmount = parseFloat(p.paymentAmount) || 0;
                                transactionTotal += paymentAmount;
                                salesData.tenderTypes[p.cardType] = (salesData.tenderTypes[p.cardType] || 0) + paymentAmount;
                            });

                            salesData.totalSales += transactionTotal;
                            salesData.hourly[hour] += transactionTotal;
                            
                            if (data.data.saleItemDetail && data.data.saleItemDetail.skuList) {
                                data.data.saleItemDetail.skuList.forEach(item => {
                                    const name = item.skuName ? item.skuName.trim() : 'Unknown Item';
                                    const saleAmount = parseFloat(item.skuSaleAmount) || 0;
                                    salesData.bestSellers[name] = (salesData.bestSellers[name] || 0) + saleAmount;
                                });
                            }
                            
                            if (data.data.memberCardDetail && data.data.memberCardDetail.memberPriceCardTitle) {
                                const memberType = data.data.memberCardDetail.memberPriceCardTitle.trim();
                                if (memberType) {
                                    salesData.topSpenders[memberType] = (salesData.topSpenders[memberType] || 0) + transactionTotal;
                                }
                            }
                        }
                    } catch (e) {
                        // Ignore and continue
                    }
                }
            });
            
            if (salesData.totalTransactions === 0) {
                 showMessage('No "End Transaction Response" data found in the log to generate a dashboard.', 'error');
                 return;
            }

            salesDataForAI = salesData;
            dashboardSection.classList.remove('hidden');
            updateDashboard(salesData);
        });

        function updateDashboard(data) {
            document.getElementById('total-sales').textContent = data.totalSales.toFixed(2);
            document.getElementById('total-transactions').textContent = data.totalTransactions;
            document.getElementById('avg-transaction').textContent = (data.totalSales / (data.totalTransactions || 1)).toFixed(2);
            
            Object.values(charts).forEach(chart => chart.destroy());

            const chartOptions = {
                plugins: { legend: { labels: { color: '#d1d5db' } } },
                scales: { 
                    y: { ticks: { color: '#d1d5db' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                    x: { ticks: { color: '#d1d5db' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                }
            };

            charts.hourly = new Chart(document.getElementById('hourly-sales-chart'), {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Sales per Hour',
                        data: data.hourly,
                        backgroundColor: '#569cd6'
                    }]
                },
                options: chartOptions
            });

            const sortedTenderTypes = Object.entries(data.tenderTypes).sort((a, b) => a[0].localeCompare(b[0]));
            charts.tender = new Chart(document.getElementById('tender-type-chart'), {
                type: 'pie',
                data: {
                    labels: sortedTenderTypes.map(item => item[0]),
                    datasets: [{
                        label: 'Tender Types',
                        data: sortedTenderTypes.map(item => item[1]),
                        backgroundColor: ['#569cd6', '#c586c0', '#b5cea8', '#dcdcaa', '#f44747']
                    }]
                },
                options: { plugins: { legend: { labels: { color: '#d1d5db' } } } }
            });
            
            const top5Items = Object.entries(data.bestSellers).sort((a, b) => b[1] - a[1]).slice(0, 5);
            charts.bestSellers = new Chart(document.getElementById('best-selling-chart'), {
                type: 'bar',
                data: {
                    labels: top5Items.map(item => item[0]),
                    datasets: [{
                        label: 'Best Selling Items',
                        data: top5Items.map(item => item[1]),
                        backgroundColor: '#b5cea8'
                    }]
                },
                options: chartOptions
            });
            
            const top5Spenders = Object.entries(data.topSpenders).sort((a, b) => b[1] - a[1]).slice(0, 5);
            charts.topSpenders = new Chart(document.getElementById('top-spender-chart'), {
                type: 'bar',
                data: {
                    labels: top5Spenders.map(item => item[0]),
                    datasets: [{
                        label: 'Top Spenders by Member Type',
                        data: top5Spenders.map(item => item[1]),
                        backgroundColor: '#c586c0'
                    }]
                },
                options: chartOptions
            });
        }

        // --- AI Analysis Logic ---
        geminiSelector.addEventListener('click', () => {
            selectedAI = 'gemini';
            geminiSelector.classList.add('active');
            chatgptSelector.classList.remove('active');
            clearAIChat();
        });

        chatgptSelector.addEventListener('click', () => {
            selectedAI = 'chatgpt';
            chatgptSelector.classList.add('active');
            geminiSelector.classList.remove('active');
            clearAIChat();
        });

        function clearAIChat() {
            geminiChatHistory = [];
            chatgptChatHistory = [];
            aiOutput.innerHTML = 'Ask a question to start the conversation...';
        }

        function displayConversation(history) {
            aiOutput.innerHTML = '';
            history.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                
                const roleSpan = document.createElement('span');
                const role = msg.role === 'model' ? 'assistant' : msg.role;
                roleSpan.className = role === 'user' ? 'chat-message-user' : 'chat-message-assistant';
                roleSpan.textContent = role === 'user' ? 'You:' : 'Assistant:';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'chat-message-content';
                contentDiv.textContent = msg.content || (msg.parts && msg.parts[0].text);

                messageDiv.appendChild(roleSpan);
                messageDiv.appendChild(contentDiv);
                aiOutput.appendChild(messageDiv);
            });
            aiOutput.scrollTop = aiOutput.scrollHeight;
        }

        aiAskBtn.addEventListener('click', () => {
            if (selectedAI === 'gemini') {
                askGemini();
            } else {
                askChatGPT();
            }
        });

        function getDashboardSummary() {
            if (!salesDataForAI) return "No dashboard has been generated yet.";
            
            const topSellers = Object.entries(salesDataForAI.bestSellers).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const topSpenders = Object.entries(salesDataForAI.topSpenders).sort((a, b) => b[1] - a[1]).slice(0, 5);

            return `
- Total Sales: ${salesDataForAI.totalSales.toFixed(2)}
- Total Transactions: ${salesDataForAI.totalTransactions}
- Tender Types: ${Object.keys(salesDataForAI.tenderTypes).join(', ')}
- Top 5 Best Sellers: ${topSellers.map(item => item[0]).join(', ')}
- Top 5 Spender Types: ${topSpenders.map(item => item[0]).join(', ')}
            `;
        }


        async function askGemini() {
            const userQuestion = aiInput.value;
            if (!userQuestion.trim()) { showMessage('Please enter a question to ask.', 'error'); return; }
            if (!formattedPlainText.trim()) { showMessage('Please format a log before analyzing.', 'error'); return; }

            aiAskBtn.disabled = true;
            
            const currentMessage = { role: 'user', parts: [{ text: userQuestion }] };
            geminiChatHistory.push(currentMessage);
            displayConversation(geminiChatHistory);
            aiInput.value = '';
            aiOutput.innerHTML += '<div class="flex justify-center items-center h-full"><div class="spinner"></div></div>';

            const MAX_LOG_LENGTH = 25000;
            let logContextForAI = formattedPlainText;
            if (logContextForAI.length > MAX_LOG_LENGTH) {
                logContextForAI = logContextForAI.substring(0, MAX_LOG_LENGTH) + "\n\n... (Log truncated) ...";
            }
            
            let messagesToSend = [...geminiChatHistory];
            if (geminiChatHistory.length === 1) {
                 const initialPrompt = `**Role:** You are a Log Data Extractor and Summarizer.
                **Task:** Your only function is to analyze the provided log data to answer the user's question.
                **Instructions:**
                1.  **Analyze the Data:** Carefully read and internally structure the entire formatted log file provided below. This is your only source of information.
                2.  **Answer Directly:** Provide a direct and factual answer to the user's question based *only* on the data.
                3.  **No Conversation:** Do not use conversational greetings, apologies, or explain your capabilities. Get straight to the answer.
                4.  **Format for Clarity:** Structure your answer clearly, using tables or lists if it helps present the data effectively.

                --- FORMATTED LOG DATA START ---
                ${logContextForAI}
                --- FORMATTED LOG DATA END ---

                **User's Question:** "${userQuestion}"

                **Direct Answer:**`;
                messagesToSend = [{ role: 'user', parts: [{ text: initialPrompt }] }];
            }

            try {
                const payload = { contents: messagesToSend };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts[0].text) {
                    const analysisText = result.candidates[0].content.parts[0].text;
                    geminiChatHistory.push({ role: 'model', parts: [{ text: analysisText }] });
                    displayConversation(geminiChatHistory);
                } else {
                    geminiChatHistory.pop();
                    displayConversation(geminiChatHistory);
                    aiOutput.innerHTML += '<div class="chat-message error">Error: No response from API.</div>';
                }

            } catch (error) {
                geminiChatHistory.pop();
                console.error("Gemini API Error:", error);
                displayConversation(geminiChatHistory);
                aiOutput.innerHTML += `<div class="chat-message error">Error: ${error.message}</div>`;
            } finally {
                aiAskBtn.disabled = false;
            }
        }

        async function askChatGPT() {
            const userQuestion = aiInput.value;
            if (!userQuestion.trim()) { showMessage('Please enter a question to ask.', 'error'); return; }
            if (!formattedPlainText.trim()) { showMessage('Please format a log before analyzing.', 'error'); return; }
            
            aiAskBtn.disabled = true;
            
            chatgptChatHistory.push({ role: 'user', content: userQuestion });
            displayConversation(chatgptChatHistory);
            aiInput.value = '';
            aiOutput.innerHTML += '<div class="flex justify-center items-center h-full"><div class="spinner"></div></div>';

            const MAX_LOG_LENGTH = 12000;
            let logContextForAI = formattedPlainText;
            if (logContextForAI.length > MAX_LOG_LENGTH) {
                logContextForAI = logContextForAI.substring(0, MAX_LOG_LENGTH) + "\n\n... (Log truncated) ...";
            }

            const systemPrompt = `You are a Log Data Extractor and Summarizer. Your only function is to analyze the provided log data to answer the user's question. Provide only direct, factual answers based on the data. Do not use conversational greetings or explain your capabilities. Structure answers clearly.`;
            
            const messagesToSend = (chatgptChatHistory.length === 1)
                ? [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: `Based on the log data below, please answer my question.\n--- LOG DATA START ---\n${logContextForAI}\n--- LOG DATA END ---\nMy Question: "${userQuestion}"` }
                  ]
                : [ { role: "system", content: systemPrompt }, ...chatgptChatHistory ];

            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + CHATGPT_API_KEY
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: messagesToSend
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.choices && data.choices.length > 0) {
                        const analysisText = data.choices[0].message.content;
                        chatgptChatHistory.push({ role: 'assistant', content: analysisText });
                        displayConversation(chatgptChatHistory);
                    } else {
                        chatgptChatHistory.pop();
                        displayConversation(chatgptChatHistory);
                        aiOutput.innerHTML += '<div class="chat-message error">Error: No response from API.</div>';
                    }
                } else {
                    chatgptChatHistory.pop();
                    const errorMsg = data.error?.message || JSON.stringify(data);
                    displayConversation(chatgptChatHistory);
                    aiOutput.innerHTML += `<div class="chat-message error">Error: (${response.status}): ${errorMsg}</div>`;
                }

            } catch (err) {
                chatgptChatHistory.pop();
                console.error("ChatGPT API Error:", err);
                displayConversation(chatgptChatHistory);
                aiOutput.innerHTML += `<div class="chat-message error">Error: ${err.message}</div>`;
            } finally {
                aiAskBtn.disabled = false;
            }
        }

    </script>

</body>
</html>
